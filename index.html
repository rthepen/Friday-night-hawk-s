<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Friday-night-hawk-s Timer v8.13</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --app-height: 100dvh;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            margin: 0; padding: 0;
            height: var(--app-height);
            width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden;
            overscroll-behavior: none; 
            transition: background-color 0.3s ease;
        }
        
        .container {
            padding: calc(10px + var(--safe-top)) 10px calc(10px + var(--safe-bottom)) 10px;
            height: 100%;
            display: flex; flex-direction: column;
            overflow-y: auto; 
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* --- INTRO BANNER --- */
        .intro-banner {
            background: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .intro-title {
            font-size: 16px;
            font-weight: 900;
            color: #30D158;
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }
        .intro-text {
            font-size: 13px;
            color: #ccc;
            line-height: 1.4;
        }

        /* --- LOGO & HEADER --- */
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .app-logo {
            width: 120px;
            height: auto;
            border-radius: 50%;
            border: 2px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
        }

        .app-header {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            text-align: left;
        }
        .version-tag {
            font-size: 11px;
            color: #30D158;
            background: #1c1c1e;
            padding: 2px 5px;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 5px;
            font-weight: bold;
            border: 1px solid #333;
        }
        
        .header-buttons { display: flex; gap: 5px; }

        .btn-header {
            border: none;
            border-radius: 20px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s;
        }
        .btn-header:active { opacity: 0.6; }
        .btn-save { background: #0A84FF; color: white; }
        .btn-reset { background: #333; color: #ccc; border: 1px solid #444; }
        .btn-share-app { background: #BF5AF2; color: white; }

        /* --- NEW COMPACT GRID (3 Columns) --- */
        .compact-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        /* 2 Column Grid for Time/Duration */
        .half-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            margin-bottom: 10px;
        }

        .select-group { display: flex; flex-direction: column; min-width: 0; }

        label { 
            display: block; font-size: 11px; color: #888; margin-bottom: 4px; text-align: left; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600;
        }
        
        select.compact-select {
            width: 100%; padding: 12px 8px; border-radius: 8px; border: 1px solid #333; 
            background: #1c1c1e; color: white; font-size: 16px;
            appearance: none; -webkit-appearance: none;
            text-align: center; text-align-last: center;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23555%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .5em top 50%;
            background-size: .65em auto;
        }
        
        .highlight-input {
            border: 1px solid #555 !important;
            background: #222 !important;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .input-group { display: flex; flex-direction: column; min-width: 0; }
        
        input[type="time"] {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; 
            background: #1c1c1e; color: white; font-size: 18px;
            display: block;
            appearance: none; -webkit-appearance: none;
            text-align: center;
            font-family: inherit;
        }
        
        input[type="text"] {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; 
            background: #1c1c1e; color: white; font-size: 16px;
            display: block;
            -webkit-appearance: none;
            text-align: center;
        }

        /* --- TOGGLES --- */
        .toggle-container { display: flex; background: #1c1c1e; border-radius: 8px; padding: 4px; margin-bottom: 12px; flex-shrink: 0; }
        .toggle-btn {
            flex: 1; padding: 10px; border: none; background: transparent;
            color: #666; font-weight: bold; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s;
        }
        .toggle-btn.active { background: #333; color: #fff; }

        /* --- SPEECH SETTINGS --- */
        .speech-options, .resume-options, .extra-options {
            background: #1c1c1e;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #333;
            text-align: left;
        }
        .resume-options, .extra-options { border-color: #555; margin-top: 15px; margin-bottom: 20px; } 

        .category-header {
            margin-top: 20px; margin-bottom: 10px;
            font-size: 12px; font-weight: 900; color: #30D158; 
            text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid #333; padding-bottom: 5px;
        }
        .category-header:first-child { margin-top: 0; }

        .switch-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0;
        }
        .switch-label { font-size: 14px; color: #fff; flex: 1; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; flex-shrink: 0;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 30px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #30D158; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Custom Text Input (Read only trigger) */
        .text-input-trigger { 
            width: 100%; background: #2a2a2c; border: 1px solid #444; color: #ccc; 
            padding: 12px; border-radius: 8px; font-size: 14px; margin-bottom: 15px; margin-top: 5px;
            white-space: pre-wrap; 
            overflow: visible;
            min-height: 80px; 
            line-height: 1.4;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }
        .text-input-trigger:active { background: #3a3a3c; }

        /* Custom Text Input (Real select for coach) */
        select.text-input {
            width: 100%; background: #2a2a2c; border: 1px solid #444; color: #ccc; 
            padding: 8px; border-radius: 6px; font-size: 13px; margin-bottom: 10px; margin-top: 2px;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }

        /* --- COLLAPSIBLE (Resume only) --- */
        .collapsible-header {
            background: #2c2c2e; padding: 10px; font-size: 12px; font-weight: bold;
            color: #fff; text-transform: uppercase; cursor: pointer; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .collapsible-header:hover { background: #3a3a3c; }
        .collapsible-content { padding: 10px; background: #151516; border-radius: 6px; margin-top: 5px; }
        .collapsible-content.hidden { display: none; }
        .arrow { font-size: 10px; transition: transform 0.2s; }
        .open .arrow { transform: rotate(180deg); }


        /* --- BUTTONS --- */
        button.action-btn {
            width: 100%; padding: 16px; font-size: 18px; font-weight: bold;
            border: none; border-radius: 12px; cursor: pointer; margin-top: 5px; margin-bottom: 20px; flex-shrink: 0;
        }
        .btn-start { background-color: #30D158; color: black; }
        
        /* Updated Control Buttons */
        .btn-control {
            flex: 1; 
            padding: 20px; 
            font-size: 40px; 
            font-weight: bold;
            border: 1px solid rgba(255,255,255,0.15); 
            background: rgba(255,255,255,0.05); /* Very subtle background */
            color: #fff;
            border-radius: 16px; 
            cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        .btn-control:active { background: rgba(255,255,255,0.15); transform: scale(0.98); }
        
        /* STRICT PAUSED STATE - NO WHITE BG */
        .btn-control.paused { 
            border-color: rgba(255,255,255,0.5) !important;
        }
        
        .btn-stop { color: #FF453A; /* Red icon for stop */ }

        .btn-nav { background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); width: 60px; border-radius: 8px; font-size: 24px; font-weight: bold; cursor: pointer;}

        /* --- INFO BOX --- */
        .info-bar {
            background: #111; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; flex-shrink: 0; margin-top: 5px;
            position: relative;
        }
        .btn-force-edit {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: #333; border: 1px solid #555; color: white; 
            font-size: 12px; padding: 5px 10px; border-radius: 6px; cursor: pointer;
        }

        /* --- LISTS --- */
        .schedule-list-wrapper {
            flex: 1; text-align: left; background: #000; border-top: 1px solid #222; overflow-y: auto; min-height: 100px;
        }
        .schedule-item { padding: 10px; border-bottom: 1px solid #1a1a1a; color: #555; display: flex; align-items: center; font-size: 14px; }
        .schedule-item.active { color: #fff; background: #1c1c1e; border-left: 4px solid #30D158; }
        .col-time { width: 60px; font-family: monospace; color: #888; font-size: 12px; flex-shrink: 0; }
        .col-desc { flex: 1; padding: 0 8px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .col-dur  { width: 40px; text-align: right; font-weight: bold; flex-shrink: 0;}
        
        /* --- TIMER SCREEN (GYM MODE) --- */
        #timer-screen { display: none; height: 100%; flex-direction: column; padding-bottom: var(--safe-bottom); width: 100vw;}
        
        /* PROGRESS BAR */
        .progress-container { 
            width: 100%; height: 50px; background: rgba(0,0,0,0.2); margin-top: var(--safe-top); 
            position: relative; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .progress-fill { 
            position: absolute; left: 0; top: 0; bottom: 0; background: rgba(255,255,255,0.8); width: 0%; 
            transition: width 0.2s linear; z-index: 1; 
        }
        #progress-text-center {
            position: relative; z-index: 2; font-size: 20px; font-weight: 900; color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        
        /* THE MAIN DISPLAY ZONE */
        .display-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 10px;
            position: relative;
        }

        .gym-phase-title {
            font-size: 8vw; /* Normal size for long text */
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 5px;
            opacity: 0.8;
            line-height: 1;
            position: relative;
            z-index: 1; 
            pointer-events: none;
            transition: font-size 0.3s;
        }

        .gym-phase-title.huge-text {
            font-size: 16vw; 
        }

        .gym-big-time {
            font-size: 32vw; 
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            line-height: 0.9;
            letter-spacing: -5px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            pointer-events: none;
        }

        /* NEW STATS GRID STRUCTURE */
        .stats-wrapper {
            width: 95%;
            max-width: 600px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            z-index: 50; 
            pointer-events: none;
        }

        .stats-row-1 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }
        
        .stats-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-box {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
            pointer-events: auto; /* CRITICAL: Re-enable clicks on the boxes */
            position: relative;
        }

        /* --- EDITABLE STYLES --- */
        .stat-box.editable {
            border: 2px solid #30D158;
            position: relative;
            z-index: 60; 
        }
        .stat-box.editable:active { transform: scale(0.98); background: rgba(48, 209, 88, 0.2); }
        .edit-icon { position: absolute; top: 4px; right: 4px; font-size: 10px; color: #30D158; }

        .stat-label {
            font-size: 2.5vw;
            text-transform: uppercase;
            opacity: 0.8;
            font-weight: bold;
            margin-bottom: 2px;
            color: #ddd;
        }
        
        .stat-value {
            font-size: 6vw; /* Bigger as requested */
            font-weight: 900;
            font-variant-numeric: tabular-nums;
        }

        /* Fallback for very small or very large screens */
        @media (min-width: 600px) {
            .stat-label { font-size: 14px; }
            .stat-value { font-size: 36px; }
            .gym-phase-title { font-size: 40px; }
            .gym-phase-title.huge-text { font-size: 80px; }
            .gym-big-time { font-size: 180px; }
        }

        .gym-next-info {
            font-size: 3vw;
            opacity: 0.7;
            margin-top: 20px;
            position: relative;
            z-index: 1;
            pointer-events: none;
        }

        .controls-container {
            flex: 0 0 100px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            width: 100%;
            background: rgba(0,0,0,0.2); 
            position: relative;
            z-index: 100; /* Highest priority */
            pointer-events: auto;
            gap: 15px; /* Spacing between big buttons */
        }
        
        /* --- PHASE COLORS (Backgrounds) --- */
        body.mode-work { background-color: #30D158; color: black; }
        body.mode-work .progress-fill { background: black; }
        body.mode-work .stat-box { background: rgba(0,0,0,0.15); border-color: rgba(0,0,0,0.2); }
        body.mode-work .stat-box.editable { border-color: #000; } 
        body.mode-work .edit-icon { color: #000; }
        body.mode-work .stat-label { color: rgba(0,0,0,0.6); }
        
        body.mode-rest { background-color: #FF9F0A; color: black; }
        body.mode-rest .progress-fill { background: black; }
        body.mode-rest .stat-box { background: rgba(0,0,0,0.15); border-color: rgba(0,0,0,0.2); }
        body.mode-rest .stat-box.editable { border-color: #000; }
        body.mode-rest .edit-icon { color: #000; }
        body.mode-rest .stat-label { color: rgba(0,0,0,0.6); }

        body.mode-switch { background-color: #BF5AF2; color: white; }
        body.mode-long { background-color: #0A84FF; color: white; }
        body.mode-prep { background-color: #1c1c1e; color: white; }
        body.mode-finish { background-color: #FFD60A; color: black; }
        body.mode-pause { background-color: #333; color: white; }

        /* --- MODALS --- */
        #pause-modal, #calc-modal, #speech-edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1c1c1e; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: white; max-height: 90vh; overflow-y: auto;}
        
        /* SPEECH MODAL FIX */
        #speech-edit-modal .modal-content { width: 98%; max-width: 98%; padding: 15px; }

        .modal-btn { display: block; width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer; text-align: left; position: relative;}
        .modal-btn .btn-subtext { display: block; font-size: 11px; font-weight: normal; opacity: 0.7; margin-top: 2px; }
        
        .calc-input { width: 80px; font-size: 24px; padding: 10px; text-align: center; border-radius: 8px; border: 1px solid #555; background: #222; color: white; margin-bottom: 15px; }
        .option-desc { font-size: 13px; color: #ccc; margin-top: 2px; font-weight: normal; }
        
        /* SPEECH EDIT TEXTAREA - MAXIMIZED */
        #speech-edit-area {
            width: 100%; 
            min-height: 350px; /* Huge height */
            background: #222; border: 1px solid #555; color: white;
            font-size: 16px; padding: 15px; border-radius: 8px; resize: none; margin-bottom: 15px;
            font-family: inherit;
            box-sizing: border-box; 
        }

        .hidden { display: none !important; }
        
        /* TRANSPARENT INPUT STYLES */
        .transparent-input {
            position: absolute; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            z-index: 20; 
            cursor: pointer;
            border: none;
            padding: 0;
            margin: 0;
            appearance: none; -webkit-appearance: none; /* remove default arrow */
        }
        
        .bonus-section-wrapper {
            border: 1px solid #333; padding: 10px; border-radius: 8px; margin-bottom: 15px;
            background: #111; text-align: left;
        }
    </style>
</head>
<body>

    <div id="setup-screen" class="container">
        
        <div class="logo-container">
            <img src="FNH logo.jpg" alt="FNH Logo" class="app-logo">
        </div>

        <div class="header-row">
            <div class="app-header">
                FNH Timer <span class="version-tag">v8.13</span>
            </div>
            <div class="header-buttons">
                <button class="btn-header btn-reset" onclick="resetToDefaults()">üîÑ Reset</button>
                <button class="btn-header btn-save" onclick="shareSettings()">üíæ Save</button>
                <button class="btn-header btn-share-app" onclick="shareApp()">üì§ Delen</button>
            </div>
        </div>

        <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:5px;">TIJDSINSTELLINGEN</div>
        
        <div class="half-row">
             <div class="select-group">
                <label>Klaar om (HH:MM) ‚úèÔ∏è</label>
                <input type="time" id="endTimeValue" class="highlight-input" onchange="syncTime('endtime'); saveToLocal();">
            </div>
             <div class="select-group">
                <label>Totale tijd (min) ‚úèÔ∏è</label>
                <select id="totalMin" class="compact-select highlight-input" onchange="syncTime('duration'); saveToLocal();"></select>
            </div>
        </div>

        <div class="compact-row">
            <div class="select-group">
                <label>Rondes</label>
                <select id="rounds" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Oefeningen</label>
                <select id="exercises" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Sets</label>
                <select id="sets" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
        </div>
        
        <div class="extra-options">
            <div class="collapsible-header resume-header open" onclick="toggleSection('sec-extra')">
                <div>Extra Oefeningen (Bonus)</div>
                <span class="arrow">‚ñº</span>
            </div>
            <div id="sec-extra" class="collapsible-content">
                <div style="font-size:12px; color:#aaa; margin-bottom:12px;">Stel hier 3 bonus workouts in (bijv. Spinning, Tabata, Buikspieren).</div>
                
                <div class="bonus-section-wrapper">
                    <label style="color:#30D158; margin-bottom:6px;">Bonus Oefening 1</label>
                    <input type="text" id="bonus1-name" value="Bonus 1" class="text-input" style="text-align:left; margin-bottom:5px;" oninput="saveToLocal()">
                    <div class="half-row" style="margin-bottom:0;">
                        <select id="bonus1-duration" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
                        <select id="bonus1-freq" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
                    </div>
                </div>

                <div class="bonus-section-wrapper">
                    <label style="color:#30D158; margin-bottom:6px;">Bonus Oefening 2</label>
                    <input type="text" id="bonus2-name" value="Bonus 2" class="text-input" style="text-align:left; margin-bottom:5px;" oninput="saveToLocal()">
                    <div class="half-row" style="margin-bottom:0;">
                        <select id="bonus2-duration" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
                        <select id="bonus2-freq" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
                    </div>
                </div>

                <div class="bonus-section-wrapper" style="margin-bottom:0;">
                    <label style="color:#30D158; margin-bottom:6px;">Bonus Oefening 3</label>
                    <input type="text" id="bonus3-name" value="Bonus 3" class="text-input" style="text-align:left; margin-bottom:5px;" oninput="saveToLocal()">
                    <div class="half-row" style="margin-bottom:0;">
                        <select id="bonus3-duration" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
                        <select id="bonus3-freq" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
                    </div>
                </div>

            </div>
        </div>

        <div class="compact-row">
            <div class="select-group">
                <label>Rust tussen sets</label>
                <select id="restSec" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Rust tijdens wissel</label>
                <select id="exerciseRestSec" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Rust tussen rondes</label>
                <select id="roundRestSec" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
        </div>

        <div class="info-bar">
            <div style="font-size:12px; color:#888;">WERKTIJD PER SET</div>
            <div style="font-size:30px; font-weight:bold; color:#30D158;" id="live-calc-result">--</div>
            <button class="btn-force-edit" onclick="openCalcModal()">‚úèÔ∏è Pas aan</button>
            <div id="live-calc-error" style="color:#FF453A; display:none; font-size:12px;">Onmogelijk schema!</div>
        </div>
        
        <button class="action-btn btn-start" id="btn-start-app" onclick="startWorkout()">START TRAINING</button>
        
        <div class="resume-options">
            <div class="collapsible-header resume-header open" onclick="toggleSection('sec-resume')">
                <div>Beginnen vanaf moment in training</div>
                <span class="arrow">‚ñº</span>
            </div>
            <div id="sec-resume" class="collapsible-content">
                <div style="font-size:12px; color:#aaa; margin-bottom:8px;">Vul hieronder in waar je wilt starten.</div>
                
                <div class="compact-row">
                    <div class="select-group">
                        <label>Ronde</label>
                        <select id="start-round" class="compact-select" onchange="saveToLocal(); calculateRealTime();"></select>
                    </div>
                    <div class="select-group">
                        <label>Oefening</label>
                        <select id="start-ex" class="compact-select" onchange="saveToLocal(); calculateRealTime();"></select>
                    </div>
                    <div class="select-group">
                        <label>Set</label>
                        <select id="start-set" class="compact-select" onchange="saveToLocal(); calculateRealTime();"></select>
                    </div>
                </div>

            </div>
        </div>

        <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:5px;">GELUIDSINSTELLINGEN (SPRAAK)</div>
        
        <div class="toggle-container">
            <button class="toggle-btn active" id="btn-audio-speech" onclick="setAudioMode('speech')">üó£Ô∏è Spraak</button>
            <button class="toggle-btn" id="btn-audio-beep" onclick="setAudioMode('beep')">üîî Piepjes</button>
        </div>

        <div class="input-group" style="margin-bottom: 15px;">
            <label style="color:#30D158; font-weight:bold;">Kies je Coach Stijl</label>
            <select id="coach-preset" class="text-input" onchange="applyCoachPreset(this.value)" style="font-size:16px; padding:12px;">
                <option value="standard" selected>Standaard Coach</option>
                <option value="simple">Simpel (Alleen info)</option>
                <option value="sergeant">Drill Sergeant ü™ñ</option>
                <option value="humor">Humor & Bitterballen ü§£</option>
                <option value="custom" disabled hidden>Ge√Ømporteerd / Aangepast</option>
            </select>
        </div>
        <div style="font-size:11px; color:#888; margin-bottom:10px; margin-top:-10px;">
            Tip: Je kunt meerdere zinnen scheiden met een <b>|</b> teken. De app kiest dan willekeurig een zin (zonder direct te herhalen).
        </div>

        <div id="speech-settings-panel" class="speech-options">
            </div>

        <div style="text-align:left; padding:5px 0; font-size:12px; color:#666; margin-top:20px;">VOORBEELD SCHEMA (VANAF NU):</div>
        <div id="preview-list" class="schedule-list-wrapper">
        </div>
        
        <div class="intro-banner">
            <div class="intro-title">ü¶Ö Welcome to the Friday Night Hawks!</div>
            <div class="intro-text">
                De legendarische triathlon: <b>Spinning üö¥ ¬ª Bootcamp üèãÔ∏è ¬ª Zwemmen üèä</b>.
                <br>Iedere vrijdagavond om 19:45. We sluiten af met <b>bitterballen</b> & gezelligheid! üçñüçª
            </div>
        </div>

    </div>

    <div id="timer-screen">
        <div class="progress-container">
            <div class="progress-fill" id="total-progress"></div>
            <div id="progress-text-center">0%</div>
        </div>
        
        <div class="display-zone">
            <div class="gym-phase-title" id="gym-phase-title">KLAARMAKEN</div>
            <div class="gym-big-time" id="countdown">10</div>
            
            <div class="stats-wrapper" id="gym-stats-container">
                <div class="stats-row-1">
                    <div class="stat-box editable">
                        <select id="jump-round" class="transparent-input" onchange="handleJump()"></select>
                        <div class="edit-icon">‚ñº</div>
                        <div class="stat-label">Ronde</div>
                        <div class="stat-value" id="val-round">-</div>
                    </div>
                    <div class="stat-box editable">
                        <select id="jump-exercise" class="transparent-input" onchange="handleJump()"></select>
                        <div class="edit-icon">‚ñº</div>
                        <div class="stat-label">Oefening</div>
                        <div class="stat-value" id="val-exercise">-</div>
                    </div>
                    <div class="stat-box editable">
                        <select id="jump-set" class="transparent-input" onchange="handleJump()"></select>
                        <div class="edit-icon">‚ñº</div>
                        <div class="stat-label">Set</div>
                        <div class="stat-value" id="val-set">-</div>
                    </div>
                </div>
                <div class="stats-row-2">
                    <div class="stat-box editable">
                        <input type="time" id="live-endtime-input" class="transparent-input" onchange="handleNewEndTime(this.value)">
                        
                        <div class="edit-icon">‚úèÔ∏è</div>
                        <div class="stat-label">Einde (Klik!)</div>
                        <div class="stat-value" id="val-endtime">--:--</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Nog</div>
                        <div class="stat-value" id="val-remaining">--m</div>
                    </div>
                </div>
            </div>

            <div class="gym-next-info" id="gym-next-info">Hierna: Rust</div>
        </div>

        <div class="controls-container">
            <button class="btn-control btn-pause" id="btn-pause" onclick="handlePauseClick()">‚è∏</button>
            <button class="btn-control btn-stop" onclick="confirmStop()">‚èπ</button>
        </div>
    </div>

    <div id="pause-modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Pauze voorbij</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:15px;">Je hebt <span id="pause-duration-display" style="color:white; font-weight:bold;">0s</span> gepauzeerd. Hoe halen we dit in?</p>
            
            <button class="modal-btn" style="background: #333; color: white;" onclick="resolvePause('push')">
                üê¢ Eindtijd verzetten
                <span class="btn-subtext" id="btn-text-push">...</span>
            </button>
            
            <button class="modal-btn" id="btn-catch-work" style="background: #0A84FF; color: white;" onclick="resolvePause('work')">
                ‚è±Ô∏è Inhalen via Werktijd
                <span class="btn-subtext" id="btn-text-work">...</span>
            </button>

            <button class="modal-btn" id="btn-catch-rest" style="background: #FF9F0A; color: black;" onclick="resolvePause('rest')">
                üí§ Inhalen via Rust (Set)
                <span class="btn-subtext" id="btn-text-rest">...</span>
            </button>

            <button class="modal-btn" id="btn-catch-switch" style="background: #BF5AF2; color: white;" onclick="resolvePause('switch')">
                üîÄ Inhalen via Wissels
                <span class="btn-subtext" id="btn-text-switch">...</span>
            </button>
            
            <button class="modal-btn" id="btn-catch-round" style="background: #30D158; color: black;" onclick="resolvePause('round')">
                ‚òï Inhalen via Ronde Rust
                <span class="btn-subtext" id="btn-text-round">...</span>
            </button>
        </div>
    </div>
    
    <div id="calc-modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Gewenste Werktijd?</h3>
            <input type="number" id="target-work-sec" class="calc-input" placeholder="sec" oninput="previewCalc()">
            
            <button class="modal-btn" id="btn-calc-duration" style="background: #0A84FF; color: white;" onclick="applyCalc('duration')">
                ‚è±Ô∏è Tijd aanpassen
                <span class="btn-subtext" id="desc-calc-duration">...</span>
            </button>
            
            <button class="modal-btn" id="btn-calc-rest" style="background: #FF9F0A; color: black;" onclick="applyCalc('rest')">
                üí§ Rust (Set) aanpassen
                <span class="btn-subtext" id="desc-calc-rest">...</span>
            </button>

            <button class="modal-btn" id="btn-calc-switch" style="background: #BF5AF2; color: white;" onclick="applyCalc('exerciseRest')">
                üîÄ Rust (Wissel) aanpassen
                <span class="btn-subtext" id="desc-calc-switch">...</span>
            </button>

            <button class="modal-btn" id="btn-calc-round" style="background: #30D158; color: black;" onclick="applyCalc('roundRest')">
                ‚òï Rust (Ronde) aanpassen
                <span class="btn-subtext" id="desc-calc-round">...</span>
            </button>
            
            <div style="margin-top:15px; font-size:12px; color:#888; text-decoration:underline; cursor:pointer;" onclick="closeCalcModal()">Annuleren</div>
        </div>
    </div>
    
    <div id="speech-edit-modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Spraak aanpassen</h3>
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;">Gebruik | voor variatie</div>
            <textarea id="speech-edit-area"></textarea>
            <button class="modal-btn" style="background: #30D158; color: black;" onclick="saveSpeechEdit()">üíæ Opslaan</button>
            <button class="modal-btn" style="background: #333; color: white; margin-top:10px;" onclick="closeSpeechEdit()">Annuleren</button>
        </div>
    </div>
    
    <input type="time" id="hidden-endtime-input" onchange="handleNewEndTime(this.value)">

    <script>
        // --- VARIABELEN ---
        let audioMode = 'speech';
        let speechPlaylists = {}; 
        let editingSpeechKey = null; 
        
        // --- COACH PRESETS DEFINITIONS (Already Updated) ---
        const coachPresets = {
            standard: {
                prep_intro: { enabled: true, text: "Welkom Hawks! Tijd om te trainen. | Goedemorgen Hawks, laten we beginnen! | Klaar voor de start? We gaan ervoor! | Welkom bij de training, zet hem op vandaag! | Iedereen klaar? Focus aan, verstand op nul! | Tijd voor actie, Hawks! | Laat zien wat je kan vandaag! | Welkom strijders, vandaag gaan we knallen! | Goed dat je er bent, maak er een top training van! | Laten we beginnen met een glimlach (en zweet)!" },
                prep_countdown: { enabled: true, text: "" }, 
                work_start: { enabled: true, text: "Start! En actie | Start! Aan de slag | Start! Beginnen maar | Start! Tijd om te knallen | Start! Focus en ga | Start! Hup, bewegen | Start! Gas erop | Start! Kom op, werken | Start! En... go! | Start! Niet wachten, doen! | Start! Bewegen die hap!" },
                work_halfway: { enabled: true, text: "Halverwege! | Halverwege! Je bent op de helft | Halverwege! Hou dit vast | Halverwege! De helft zit erop | Halverwege! Wissel van kant als dat moet | Halverwege! Wisselen maar | Halverwege! Hou vol | Halverwege! Nog even doorbijten | Halverwege! Je gaat lekker! | Halverwege! Niet verslappen nu!" }, 
                work_30s: { enabled: false, text: "Nog 30 seconden | Laatste 30 seconden lopen | Nog een halve minuut | 30 seconden te gaan | Hou vol, nog 30 | Nog 30, kom op | De klok tikt, nog 30 | Nog 30 seconden focus | 30 seconden, blijf werken | Nog 30, je kan het!" },
                work_10s: { enabled: true, text: "Nog 10 seconden! Hou vol | Nog 10 seconden! Bijna klaar | Nog 10 seconden! Aftellen loopt | Nog 10 seconden! Laatste stukje | Nog 10, eindsprintje | Nog 10, niet stoppen | Nog 10, pers het eruit | Nog 10, kom op! | Nog 10, doorgaan! | Nog 10 seconden, alles geven!" },
                work_5s: { enabled: false, text: "Nog 5 seconden | 5, 4, 3... | Bijna... | Laatste paar seconden | En 5... | Nog heel even... | 5 seconden te gaan | Stop nog niet... | 5 tellen... | Bijna rust..." },
                rest_set_start: { enabled: true, text: "Rust! Even ontspannen | Rust! Stop maar | Rust! Pak je rust | Rust! Ontspan | Rust! Adem in, adem uit | Rust! Even los schudden | Rust! Goed gewerkt, even pauze | Rust! Herstel je ademhaling | Rust! Klaar voor nu | Rust! Neem even de tijd" },
                rest_set_tips: { enabled: true, text: "Adem diep in | Schud je armen los | Blijf gefocust | Denk aan je houding | Neem een slokje water | Ontspan je schouders | Blijf in beweging | Focus op je herstel | Maak je klaar voor de volgende | Even die hartslag omlaag" }, 
                rest_switch_start: { enabled: true, text: "Wissel! Naar de volgende | Wissel! Doorwisselen | Wissel! Volgende station | Wissel! Schuif een plekje op | Wissel! Hup, door | Wissel! Verplaatsen maar | Wissel! Op naar de volgende oefening | Wissel! Niet treuzelen, doorlopen | Wissel! Nieuwe ronde, nieuwe kansen | Wissel! En door!" },
                rest_switch_info: { enabled: true, text: "" }, 
                rest_switch_10s: { enabled: true, text: "Nog 10 seconden! Sta klaar | Nog 10 seconden! In positie | Nog 10, focus! | Nog 10, ben je er klaar voor? | Nog 10, daar gaan we bijna | Nog 10, klaarstaan | Nog 10, concentratie | Nog 10, let op | Nog 10, en... focus | Nog 10, we beginnen bijna" },
                rest_round_start: { enabled: true, text: "Grote pauze! Even bijkomen | Grote pauze! Ronde voorbij | Grote pauze! Tijd voor wat drinken | Grote pauze! Neem je rust | Grote pauze! Even op adem komen | Grote pauze! Goed gedaan, even rust | Grote pauze! Pak je bidon | Grote pauze! Herstel en relax | Grote pauze! Even helemaal niks | Grote pauze! Ontspan" },
                rest_round_15s: { enabled: true, text: "Nog 15 seconden! Ga naar je oefening | Nog 15 seconden! Klaarstaan | Nog 15, zoek je plek | Nog 15, we gaan zo weer | Nog 15, kom in actie | Nog 15, voorbereiden | Nog 15, einde pauze in zicht | Nog 15, focus aan | Nog 15, daar gaan we weer | Nog 15, let op" }, 
                rest_round_info: { enabled: true, text: "" }, 
                mile_start: { enabled: true, text: "Mijlpaal! Goede start, ga zo door | Mijlpaal! Lekker begin, de kop is eraf | Goed bezig, eerste kwart zit erop! | Lekker gewerkt al, ga door! | Het begin is er, hou dit vast! | We zijn los, kom op! | Eerste deel voltooid, klasse! | Goede start is het halve werk! | Jullie gaan lekker! | Top inzet tot nu toe!" },
                mile_half: { enabled: true, text: "Mijlpaal! Je bent op de helft van de training | Mijlpaal! We zijn er bijna, helft gehad | 50% zit erop, de rest lukt ook! | We zijn over de heuvel! | De weg terug is begonnen! | Helft gehad, helft te gaan! | Hou vol, we zijn al op de helft! | Jullie zijn super bezig, 50% klaar! | De tijd vliegt, alweer op de helft! | Kom op, tweede helft knallen!" },
                mile_end: { enabled: true, text: "Mijlpaal! Laatste loodjes, eindsprint | Mijlpaal! Het einde is in zicht | Nog even, we zijn er bijna! | Laatste stukje, hou vol! | Eindsprint inzetten! | Het zwaarste hebben we gehad! | Nog een klein stukje knallen! | Jullie zijn er bijna! | Volhouden nu, laatste fase! | Finish in zicht!" },
                mile_lastround: { enabled: true, text: "Laatste ronde! Alles geven | Laatste ronde! Nog √©√©n keer knallen | Laatste ronde! Maak hem af! | Dit is de laatste, kom op! | Nog √©√©n rondje genieten! | Alles eruit gooien nu! | Finish sterk, laatste ronde! | Geen reserves meer, laatste ronde! | Nog heel even, laatste ronde! | De finale, succes!" },
                finish: { enabled: true, text: "Gefeliciteerd, training voltooid | Dat was hem weer, goed gedaan! | Training klaar, goed gewerkt | Toppers, het zit erop! | Applaus voor jezelf, klaar! | Goed getraind, tot de volgende keer! | Jullie hebben het weer geflikt! | Einde training, rustig uitlopen! | Super gedaan allemaal! | Training volbracht!" }
            },
            simple: {
                prep_intro: { enabled: true, text: "Training start." },
                prep_countdown: { enabled: true, text: "" },
                work_start: { enabled: true, text: "Start." },
                work_halfway: { enabled: true, text: "Halverwege." },
                work_30s: { enabled: false, text: "30." },
                work_10s: { enabled: true, text: "10." },
                rest_set_start: { enabled: true, text: "Rust. | Stop." },
                rest_set_tips: { enabled: false, text: "" }, 
                rest_switch_start: { enabled: true, text: "Wissel." },
                rest_switch_info: { enabled: true, text: "" },
                rest_switch_10s: { enabled: true, text: "10." },
                rest_round_start: { enabled: true, text: "Ronde rust." },
                rest_round_15s: { enabled: true, text: "Klaarstaan." },
                rest_round_info: { enabled: true, text: "" },
                mile_start: { enabled: false, text: "" },
                mile_half: { enabled: true, text: "50 procent." },
                mile_end: { enabled: false, text: "" },
                mile_lastround: { enabled: true, text: "Laatste ronde." },
                finish: { enabled: true, text: "Klaar." }
            },
            sergeant: {
                prep_intro: { enabled: true, text: "Aantreden! Ik wil zweet zien vandaag! | Peloton... AANDACHT! | Geef acht! We gaan beginnen! | Geen genade vandaag! | Rechtop staan, borst vooruit! | Jullie zijn hier om te lijden! | Klaarmaken voor de hel! | Ik wil inzet zien, geen excuses! | Vandaag scheiden we de mannen van de jongens! | Stilte in de gelederen! Focus!" },
                prep_countdown: { enabled: true, text: "" },
                work_start: { enabled: true, text: "Start! Voorwaarts... MARS! | Start! In looppas... MARS! | Start! Aanvallen! | Start! Geen gevangenen maken! | Start! Bewegen! Nu! | Start! Geen smoesjes, werken! | Start! Pijn is fijn, start! | Start! Tempo maken! Go! | Start! Gas erop, nu! | Start! Bewegen tot je erbij neervalt! | Start! Ik wil dat je kruipt van de pijn! | Start! Laat die spieren branden! | Start! Niet nadenken, doen!" },
                work_halfway: { enabled: true, text: "Halverwege! Niet verslappen! | Halverwege! Doorgaan! | Halverwege! Ik wil zweet zien! | Halverwege! Is dat alles wat je hebt? | Halverwege! Kom op, sneller! | Halverwege! Niet janken, doorwerken! | Halverwege! Wisselen en door! | Pijn is een emotie, die kun je uitschakelen! | Zweet is huilend vet! | Mijn oma kan dit sneller! | Niet stoppen! Pijn is zwakte die het lichaam verlaat!" },
                work_30s: { enabled: true, text: "Nog 30 seconden! Tempo! | Nog 30 seconden! Versnel! | Nog 30 seconden! Niet inzakken nu! | Nog 30 seconden! Tandje erbij! | Nog 30 seconden! Pijn is tijdelijk! | Nog 30 seconden! Geen genade! | Nog 30 seconden! Alles geven! | Nog 30 seconden! Doorgaan! | Nog 30 seconden! Niet stoppen! | Nog 30 seconden! Branden!" },
                work_10s: { enabled: true, text: "Nog 10 seconden! Alles geven! | Nog 10 seconden! Niet stoppen nu! | Nog 10 seconden! Doorgaan tot het gaatje! | Nog 10 seconden! Pijn is tijdelijk! | Nog 10 seconden! Pers het eruit! | Nog 10 seconden! Laatste beetje energie! | Nog 10 seconden! Schreeuw het uit als het moet! | Nog 10 seconden! Niet opgeven! | Nog 10 seconden! Sterf staande! | Nog 10 seconden! Kom op!" },
                rest_set_start: { enabled: true, text: "Rust! Op de plaats... RUST! | Rust! Geef... ACHT! | Rust! Herstel! En sta rechtop! | Rust! Stop! Blijf in beweging! | Rust! Niet gaan liggen! | Rust! Staande houden! | Rust! Adem in, borst vooruit! | Rust! Herpak jezelf! | Rust! Drinken en bek houden! | Rust! Focus op de volgende ronde!" },
                rest_set_tips: { enabled: false, text: "" },
                rest_switch_start: { enabled: true, text: "Wissel! Peloton... verplaatsen! | Wissel! Marcheer naar de volgende! | Wissel! Opschieten, doorlopen! | Wissel! Volgende oefening, nu! | Wissel! Geen tijd te verliezen! | Wissel! Rennen! | Wissel! Verplaatsen, dubbele pas! | Wissel! Niet wandelen! | Wissel! Hup, hup, hup! | Wissel! Naar je volgende post!" },
                rest_switch_info: { enabled: true, text: "" },
                rest_switch_10s: { enabled: true, text: "Nog 10 seconden! Opschieten! | Nog 10 seconden! Sta klaar! | Nog 10 seconden! In positie! | Nog 10 seconden! Wachten op mijn teken! | Nog 10 seconden! Focus! | Nog 10 seconden! Klaarstaan! | Nog 10 seconden! Geen beweging meer! | Nog 10 seconden! Aandacht! | Nog 10 seconden! Ogen vooruit! | Nog 10 seconden!" },
                rest_round_start: { enabled: true, text: "Grote pauze! Drinken en bek houden! | Grote pauze! Even bijkomen en dan weer knallen! | Grote pauze! Niet gaan zitten! | Grote pauze! Blijf alert! | Grote pauze! Herstel je ademhaling! | Grote pauze! Maak je klaar voor de volgende hel! | Grote pauze! Geen smoesjes! | Grote pauze! Water drinken, nu! | Grote pauze! Sta rechtop! | Grote pauze! Discipline!" },
                rest_round_15s: { enabled: true, text: "Nog 15 seconden! Terug op je post! | Nog 15 seconden! Aantreden! | Nog 15 seconden! Klaarstaan soldaten! | Nog 15 seconden! In positie! | Nog 15 seconden! Ogen op mij gericht! | Nog 15 seconden! Stop met drinken! | Nog 15 seconden! Focus! | Nog 15 seconden! Geen geluid meer! | Nog 15 seconden! Borst vooruit! | Nog 15 seconden! We gaan weer!" },
                rest_round_info: { enabled: true, text: "" },
                mile_start: { enabled: true, text: "Begin is er, maar we zijn er nog lang niet! | Niet verslappen nu! | Dit is pas het begin! | Laat zien uit welk hout je gesneden bent! | Ik wil bloed, zweet en tranen zien! | Geen genade voor jezelf! | Aanvallen! | Doorzetten! | Discipline is vrijheid! | Pijn is fijn!" },
                mile_half: { enabled: true, text: "Helft erop! Is dat alles wat je hebt? | We zijn pas op de helft! | Tandje erbij! | Niet janken, werken! | Als je nog kunt praten, train je niet hard genoeg! | Ik zie vermoeidheid, ik wil inzet zien! | Opgeven staat niet in mijn woordenboek! | Doorgaan tot je erbij neervalt! | Kom op, sneller! | Nog even en dan mag je kruipen!" },
                mile_end: { enabled: true, text: "Eindsprint! Pijn is fijn! | Alles eruit persen nu! | Ik wil dat je kruipend naar huis gaat! | Laatste loodjes! | Geen medelijden! | Vecht tegen de vermoeidheid! | Je bent hier om te breken of te maken! | Laat zien wie de baas is! | Niet stoppen! | Tot het gaatje!" },
                mile_lastround: { enabled: true, text: "Laatste ronde! Slopen die hap! | Maak me trots, laatste ronde! | Alles of niets! | Dit is de finale! | Geen reserves meer! | Leeg die tank! | Ik wil dat je sterft van de inspanning! | Laatste keer, make it count! | Eer je uniform! | Tot het einde!" },
                finish: { enabled: true, text: "Missie volbracht. Inrukken! | Training voltooid. Douchen en wegwezen. | Goed gewerkt, soldaten. | Jullie hebben het overleefd. | Rust! | Einde oefening. | Trots op jullie inzet. | Volgende keer harder! | Geniet van de pijn morgen. | Ontspan." }
            },
            humor: {
                prep_intro: { enabled: true, text: "H√© atleten, we doen dit voor de bitterballen! | Zijn we er klaar voor? De snackbar is nog dicht! | Vergeet je handdoek niet, voor het zweet of de tranen. | Welkom bij de vrijwillige marteling! | Wie heeft dit bedacht? Oh ja, ik. | Sporten is gezond, zeggen ze... bewijs het maar! | Zijn de frikandellen al bruin? Nee? Dan trainen we nog even! | Klaar voor de start? Ik eigenlijk ook niet. | Laten we doen alsof we dit leuk vinden! | Welkom bij de Bitterballen Bootcamp!" },
                prep_countdown: { enabled: true, text: "" },
                work_start: { enabled: true, text: "Start! Hup, actie in de taxi! | Start! Bewegen met dat lijf! | Start! Hop hop, gas erop! | Start! Niet kletsen, maar zweten! | Start! En... gaan met die banaan! | Start! Doe alsof er gratis bitterballen zijn! | Start! Rennen voor je leven! | Start! Hup, van die bank af! | Start! Doe eens gek, beweeg! | Start! Tijd om die calorie√´n te verbranden (voor straks)!" },
                work_halfway: { enabled: true, text: "Halverwege! De frituur staat al bijna aan! | Halverwege! Denk aan de bitterballen! | Halverwege! Zweten is huilen van het vet! | Halverwege! Kom op, je kan het (denk ik)! | Halverwege! Kijk naar de buren, die zweten ook! | Halverwege! Wissel van kant, of blijf scheef. | Halverwege! Nog even en we mogen naar huis! | Halverwege! Denk aan die koude sportdrank! | Halverwege! Ik ruik al friet! | Halverwege! Niet flauwvallen nu!" },
                work_30s: { enabled: false, text: "Nog 30 seconden, hou die frikandel voor ogen! | 30 seconden, dat is niks! | Nog 30, even doorbijten (niet in je tong)! | 30 seconden, bijna tijd voor pauze! | Nog 30, kom op tijgers! | 30 seconden, ga door! | Nog 30, denk aan het weekend! | 30 seconden, sneller dan het licht! | Nog 30, je zweet staat je goed! | 30 tellen, hup!" },
                work_10s: { enabled: true, text: "Nog 10 seconden! Afzien! | Nog 10 seconden! Bijna klaar, hou vol! | Nog 10 seconden! Nog even doorbijten! | Nog 10 seconden! Denk aan die AA-drink! | Nog 10 seconden! Niet smokkelen! | Nog 10, eindsprintje naar de bar! | Nog 10, bijna verlost! | Nog 10, kom op kanjers! | Nog 10, alles eruit! | Nog 10 seconden lijden!" },
                rest_set_start: { enabled: true, text: "Rust! Hijgen als een postpaard | Rust! En.. relax | Rust! Zo, dat viel mee toch? | Rust! Even bijkomen | Rust! Pfoe, warm h√®? | Rust! Tijd om te klagen! | Rust! Even checken of je hart nog klopt. | Rust! Droom maar van snacks. | Rust! Niet in slaap vallen! | Rust! Adem in, adem uit (belangrijk)!" },
                rest_set_tips: { enabled: true, text: "Drink wat water (geen frisdrank)! | Veeg dat zweet weg, het spettert. | Blijf staan, de grond is vies. | Denk aan iets leuks, zoals... niet sporten. | Lach naar de coach, dat helpt (mij). | Wiebel met je tenen. | Niet stiekem zitten! | Haal diep adem, gratis zuurstof. | Kijk niet zo boos! | Nog heel even volhouden." },
                rest_switch_start: { enabled: true, text: "Wissel! Niet smokkelen! | Wissel! Hup hup, naar de volgende martelgang | Wissel! Doorwisselen, niet stiekem rusten | Wissel! Op naar het volgende pretpark | Wissel! Hopla, doorlopen. | Wissel! Polonaise naar de volgende! | Wissel! Wie het laatst is, trakteert! | Wissel! Schuif eens op! | Wissel! De vloer is lava, doorlopen! | Wissel! Nieuw station, nieuwe pijn!" },
                rest_switch_info: { enabled: true, text: "" },
                rest_switch_10s: { enabled: true, text: "Nog 10 seconden! Opschieten! | Nog 10 seconden! Niet treuzelen! | Nog 10! Is iedereen er al? | Nog 10! Klaar voor de start... bijna! | Nog 10! Sta je goed? | Nog 10! Niet meer kletsen! | Nog 10! Focus op die spieren! | Nog 10! Daar gaan we weer! | Nog 10! Handdoekje mee? | Nog 10! En... wacht even." },
                rest_round_start: { enabled: true, text: "Grote pauze! Tijd voor sterke verhalen | Grote pauze! Neem een slokje, je hebt het nodig | Grote pauze! Even checken of je haar nog goed zit | Grote pauze! Tijd voor een dansje. | Grote pauze! Water is nu je beste vriend. | Grote pauze! Roddelkwartiertje start nu. | Grote pauze! Even bellen naar huis dat je nog leeft? | Grote pauze! Geniet ervan, het duurt niet lang. | Grote pauze! Droom verder over bitterballen. | Grote pauze! Relax, maar niet te veel." },
                rest_round_15s: { enabled: true, text: "Nog 15 seconden! Kom op, buik in en borst vooruit | Nog 15 seconden! We gaan weer bijna beginnen | Nog 15 seconden! Zet je schrap. | Nog 15! Uitgerust? Mooi, jammer dan. | Nog 15! Terug naar de werkvloer. | Nog 15! Bidon weg, actie! | Nog 15! Ben je er weer klaar voor? | Nog 15! Hup, van die vloer af. | Nog 15! Laatste slokje. | Nog 15! Let's go!" },
                rest_round_info: { enabled: true, text: "" },
                mile_start: { enabled: true, text: "Lekker bezig pik! | We zijn los! | De kop is eraf (en hopelijk niet van je sportdrank). | Eerste deel overleefd, applaus! | Het begin is er, nu de rest nog. | Jullie zien er nog fris uit (grapje). | Gaat lekker zo! | Toppers in de dop! | Begin is goed, einde is beter. | Kom op, we zijn net begonnen!" },
                mile_half: { enabled: true, text: "We zijn op de helft, de bitterballen komen dichterbij! | 50% gedaan, 50% te gaan. | De helft zit erop, de zwaarste helft komt nog (grapje). | Kijk, we zijn al op de helft! | Tijd vliegt als je lijdt! | Halverwege! Tijd voor een feestje (straks). | Nog maar de helft, eitje toch? | Jullie gaan als een speer (een trage speer). | Hou vol, de helft is binnen! | Op naar de finish!" },
                mile_end: { enabled: true, text: "Laatste loodjes wegen het zwaarst, maar smaken het best! | Het einde is in zicht, hou vol. | Ik ruik de kantine al! | Nog even en we zijn verlost! | Laatste stukje, kom op! | Bijna tijd voor snacks! | Pers dat laatste beetje eruit! | Jullie kunnen het! | Nog heel even afzien! | Finish in zicht, rennen!" },
                mile_lastround: { enabled: true, text: "Laatste ronde! Daarna snacks! | Laatste ronde! Nog √©√©n keertje vlammen! | Laatste ronde! Alles geven voor de derde helft! | Laatste ronde! Maak me gek! | Laatste keer, beloofd! | Nog √©√©n rondje zweten! | Laatste ronde! Denk aan de bitterbal! | Knal die laatste ronde eruit! | De allerlaatste, echt waar! | Finale!" },
                finish: { enabled: true, text: "Jaaa! Tijd voor ballen! Goed gewerkt! | Jullie hebben het overleefd, proost (met water)! | De kantine is geopend! | Klaar! Wie trakteert? | Applaus! Jullie mogen douchen. | Helden! Tijd voor de derde helft. | Training voorbij, snacktijd begint! | Super gedaan, nu rusten. | Jullie hebben die bitterbal verdiend! | Einde oefening, eet smakelijk!" }
            }
        };

        let speechSettings = JSON.parse(JSON.stringify(coachPresets.standard));

        // UI Config
        const uiConfig = [
            { header: "Voorbereiding" },
            { id: "prep_intro", label: "Introductie tekst", type: "text" },
            { id: "prep_countdown", label: "Aftellen (3, 2, 1)", type: "bool" },
            { header: "Tijdens Oefening (Werken)" },
            { id: "work_start", label: "Start commando", type: "text" },
            { id: "work_halfway", label: "Melding halverwege", type: "text" },
            { id: "work_30s", label: "Nog 30 seconden", type: "text" },
            { id: "work_10s", label: "Nog 10 seconden", type: "text" },
            { id: "work_5s", label: "Nog 5 seconden", type: "text" },
            { header: "Tijdens Rust (Set)" },
            { id: "rest_set_start", label: "Rust commando", type: "text" },
            { id: "rest_set_tips", label: "Willekeurige tips (ademhaling/drinken)", type: "bool" },
            { header: "Tijdens Rust (Wissel)" },
            { id: "rest_switch_start", label: "Wissel commando", type: "text" },
            { id: "rest_switch_info", label: "Noem volgende oefening nummer", type: "bool" },
            { id: "rest_switch_10s", label: "Waarschuwing 10s voor einde", type: "text" },
            { header: "Tijdens Rust (Ronde)" },
            { id: "rest_round_start", label: "Grote pauze commando", type: "text" },
            { id: "rest_round_info", label: "Noem volgende ronde nummer", type: "bool" },
            { id: "rest_round_15s", label: "Waarschuwing 15s voor einde", type: "text" },
            { header: "Mijlpalen & Einde" },
            { id: "mile_start", label: "25% (Goede start)", type: "text" },
            { id: "mile_half", label: "50% (Helft)", type: "text" },
            { id: "mile_end", label: "75% (Eindsprint)", type: "text" },
            { id: "mile_lastround", label: "Start laatste ronde", type: "text" },
            { id: "finish", label: "Einde training", type: "text" }
        ];

        let schedule = [];
        let workTimeSec = 0, restTimeSec = 0, exerciseRestSec = 0, roundRestSec = 0;
        let currentIndex = 0;
        let timerInterval;
        let isPaused = false;
        let pauseStartTime = 0; // NEW for accurate calculation
        let workoutStartTime, targetEndTimeDate;
        let totalWorkSetsGlobal = 0; 
        let audioCtx; 
        let stepEndTime = 0; 
        let currentPauseDuration = 0; // Stored when pause ends

        document.addEventListener('DOMContentLoaded', () => {
            populateDropdowns();
            loadFromLocal();
            checkForSharedSettings();
            renderSpeechSettings();
            
            if(!document.getElementById('endTimeValue').value) {
                syncTime('duration');
            }

            document.querySelectorAll('input.param-input').forEach(i => {
                i.addEventListener('input', () => { calculateRealTime(); saveToLocal(); });
            });
            
            document.getElementById('btn-audio-speech').onclick = () => { setAudioMode('speech'); saveToLocal(); };
            document.getElementById('btn-audio-beep').onclick = () => { setAudioMode('beep'); saveToLocal(); };
            
            document.addEventListener("visibilitychange", handleVisibilityChange);

            calculateRealTime(); 
        });
        
        function syncTime(source) {
            if (source === 'duration') {
                const min = parseInt(document.getElementById('totalMin').value) || 30;
                const now = new Date();
                const target = new Date(now.getTime() + min * 60000);
                const timeStr = target.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('endTimeValue').value = timeStr;
            } else {
                const endStr = document.getElementById('endTimeValue').value;
                if(!endStr) return;
                const now = new Date();
                const [h, m] = endStr.split(':');
                let target = new Date();
                target.setHours(h, m, 0, 0);
                
                if(target < now) {
                     target.setDate(target.getDate() + 1);
                }

                const diffMs = target - now;
                const diffMin = Math.round(diffMs / 60000);

                const sel = document.getElementById('totalMin');
                let exists = false;
                for(let i=0; i<sel.options.length; i++) { if(parseInt(sel.options[i].value) === diffMin) exists = true; }
                
                if(!exists && diffMin > 0) {
                    const opt = document.createElement('option');
                    opt.value = diffMin;
                    opt.text = diffMin + "m";
                    sel.add(opt, 0); 
                    sel.value = diffMin;
                } else if (diffMin > 0) {
                    sel.value = diffMin;
                }
            }
            calculateRealTime(); 
        }
        
        function populateDropdowns() {
            const fill = (id, start, end, step=1, suffix="") => {
                const sel = document.getElementById(id);
                const resumeSel = document.getElementById("start-" + (id === 'rounds' ? 'round' : (id==='exercises'?'ex':(id==='sets'?'set':''))));
                if(sel) sel.innerHTML = "";
                if(resumeSel) resumeSel.innerHTML = "";
                for(let i=start; i<=end; i+=step) {
                    const opt = document.createElement('option'); opt.value = i; opt.text = i + suffix; if(sel) sel.appendChild(opt);
                    if(resumeSel) { const opt2 = document.createElement('option'); opt2.value = i; opt2.text = i + suffix; resumeSel.appendChild(opt2); }
                }
            };
            fill('rounds', 1, 10);
            fill('exercises', 1, 20);
            fill('sets', 1, 10);
            
            const fillTotal = (id) => {
                const sel = document.getElementById(id); sel.innerHTML = "";
                for(let i=1; i<=10; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = i + "m"; sel.appendChild(opt); }
                for(let i=15; i<=120; i+=5) { const opt = document.createElement('option'); opt.value = i; opt.text = i + "m"; sel.appendChild(opt); }
            };
            fillTotal('totalMin');
            
            const fillRest = (id) => {
                const sel = document.getElementById(id); sel.innerHTML = "";
                for(let i=5; i<=60; i+=5) { const opt = document.createElement('option'); opt.value=i; opt.text=i+"s"; sel.appendChild(opt); }
                for(let i=70; i<=180; i+=10) { const opt = document.createElement('option'); opt.value=i; opt.text=i+"s"; sel.appendChild(opt); }
                for(let i=210; i<=300; i+=30) { const opt = document.createElement('option'); opt.value=i; opt.text=i+"s"; sel.appendChild(opt); }
            };
            fillRest('restSec'); fillRest('exerciseRestSec'); fillRest('roundRestSec');
            
            // Helper for Bonus Dropdowns
            const fillBonusDuration = (id) => {
                const sel = document.getElementById(id); sel.innerHTML = "";
                const opt0 = document.createElement('option'); opt0.value=0; opt0.text="0 min (Uit)"; sel.appendChild(opt0);
                for(let i=1; i<=15; i++) { const opt = document.createElement('option'); opt.value=i; opt.text=i+" min"; sel.appendChild(opt); }
            };
            
            const fillBonusFreq = (id) => {
                const sel = document.getElementById(id); sel.innerHTML = "";
                
                const addOpt = (val, txt) => {
                    const opt = document.createElement('option'); opt.value = val; opt.text = txt; sel.appendChild(opt);
                };
                
                addOpt('start_round', 'Begin elke ronde');
                addOpt('warmup', 'Alleen begin (Warming-up)');
                addOpt('end_round', 'Eind elke ronde');
                addOpt('end_session', 'Einde van de les (Toetje)');
                
                const grp = document.createElement('optgroup'); grp.label = "‚îÄ‚îÄ INTERVALLEN ‚îÄ‚îÄ"; sel.appendChild(grp);
                
                for(let i=1; i<=12; i++) {
                    const opt = document.createElement('option'); opt.value = i; opt.text = `Om de ${i} oefeningen`; sel.appendChild(opt);
                }
            };

            // Loop for 3 bonuses
            for(let i=1; i<=3; i++) {
                fillBonusDuration(`bonus${i}-duration`);
                fillBonusFreq(`bonus${i}-freq`);
            }
        }
        
        function handleVisibilityChange() {
            if (document.visibilityState === 'visible' && !isPaused && timerInterval) {
                // Interval logic handles catch up automatically
            }
        }

        function toggleSection(id) {
            const el = document.getElementById(id);
            const header = el.previousElementSibling;
            if(el.style.display === 'none' || el.classList.contains('hidden')) {
                el.style.display = 'block';
                el.classList.remove('hidden');
                header.classList.add('open');
            } else {
                el.style.display = 'none';
                el.classList.add('hidden');
                header.classList.remove('open');
            }
        }

        function applyCoachPreset(presetName) {
            const preset = coachPresets[presetName];
            if (preset) {
                speechSettings = JSON.parse(JSON.stringify(preset));
                speechPlaylists = {};
                saveToLocal();
                renderSpeechSettings();
            }
        }

        function renderSpeechSettings() {
            const container = document.getElementById('speech-settings-panel');
            container.innerHTML = "";
            uiConfig.forEach(item => {
                if(item.header) {
                    const h = document.createElement('div'); h.className = "category-header"; h.innerText = item.header; container.appendChild(h);
                } else {
                    const wrapper = document.createElement('div');
                    const row = document.createElement('div'); row.className = "switch-row";
                    const label = document.createElement('span'); label.className = "switch-label"; label.innerText = item.label;
                    const switchLabel = document.createElement('label'); switchLabel.className = "switch";
                    const cb = document.createElement('input'); cb.type = "checkbox"; cb.id = `sw_${item.id}`;
                    cb.checked = speechSettings[item.id] ? speechSettings[item.id].enabled : false;
                    cb.onchange = () => { if(speechSettings[item.id]) { speechSettings[item.id].enabled = cb.checked; saveToLocal(); } };
                    const slider = document.createElement('span'); slider.className = "slider";
                    switchLabel.appendChild(cb); switchLabel.appendChild(slider); row.appendChild(label); row.appendChild(switchLabel); wrapper.appendChild(row);
                    if(item.type === 'text') {
                        const trigger = document.createElement('div'); trigger.className = "text-input-trigger";
                        const val = speechSettings[item.id] ? speechSettings[item.id].text : "";
                        trigger.innerText = val || "(Klik om te bewerken...)";
                        trigger.onclick = () => openSpeechEdit(item.id, val);
                        wrapper.appendChild(trigger);
                    }
                    container.appendChild(wrapper);
                }
            });
        }
        
        function openSpeechEdit(key, currentText) {
            editingSpeechKey = key;
            document.getElementById('speech-edit-area').value = currentText;
            document.getElementById('speech-edit-modal').style.display = 'flex';
        }
        
        function saveSpeechEdit() {
            if(editingSpeechKey && speechSettings[editingSpeechKey]) {
                speechSettings[editingSpeechKey].text = document.getElementById('speech-edit-area').value;
                saveToLocal();
                renderSpeechSettings();
            }
            closeSpeechEdit();
        }
        
        function closeSpeechEdit() {
            document.getElementById('speech-edit-modal').style.display = 'none';
            editingSpeechKey = null;
        }

        function resetToDefaults() {
            if(!confirm("Weet je zeker dat je alle instellingen wilt resetten naar standaard?")) return;
            document.getElementById('rounds').value = 2; document.getElementById('exercises').value = 6; document.getElementById('sets').value = 2; 
            document.getElementById('restSec').value = 20; document.getElementById('exerciseRestSec').value = 30; document.getElementById('roundRestSec').value = 90;
            document.getElementById('totalMin').value = 30; document.getElementById('start-round').value = 1; document.getElementById('start-ex').value = 1; document.getElementById('start-set').value = 1;
            
            // Reset 3 Bonuses
            for(let i=1; i<=3; i++) {
                document.getElementById(`bonus${i}-name`).value = `Bonus ${i}`;
                document.getElementById(`bonus${i}-duration`).value = 0;
                document.getElementById(`bonus${i}-freq`).value = "start_round";
            }

            syncTime('duration'); setAudioMode('speech');
            document.getElementById('coach-preset').value = 'standard'; speechSettings = JSON.parse(JSON.stringify(coachPresets.standard)); speechPlaylists = {}; 
            saveToLocal(); renderSpeechSettings(); calculateRealTime();
        }

        function shareApp() {
            const cleanUrl = window.location.origin + window.location.pathname;
            let text = "ü¶Ö **Friday Night Hawks Timer**\n\n";
            text += "üèÜ **Uniek:** Jij bepaalt de EINDTIJD üèÅ. De app berekent automatisch de werk- en rusttijden zodat je precies op tijd klaar bent!\n\n";
            text += "De ultieme trainingspartner voor de vrijdagavond! üö¥üèãÔ∏èüèä\n";
            text += "Sluit af met bitterballen & gezelligheid! üçñ\n\n";
            text += "‚úÖ **Wat kan deze app?**\n";
            text += "- üó£Ô∏è Volledige spraakbegeleiding (NL)\n";
            text += "- ‚è±Ô∏è Slimme tijd- & rustberekening\n";
            text += "- üîÑ 'Crash Recovery': Hervat direct na uitval\n";
            text += "- üé® Volledig aanpasbare commando's\n\n";
            text += "üëá Download/Gebruik de app hier (gratis):";
            if (navigator.share) { navigator.share({ title: "Friday Night Hawks Timer ü¶Ö", text: text, url: cleanUrl }).catch(console.error); } 
            else { navigator.clipboard.writeText(text + "\n" + cleanUrl).then(() => alert("Promotietekst en link gekopieerd!")); }
        }

        function shareSettings() {
            const rounds = document.getElementById('rounds').value; const exercises = document.getElementById('exercises').value; const sets = document.getElementById('sets').value;
            const restSec = document.getElementById('restSec').value; const exerciseRestSec = document.getElementById('exerciseRestSec').value; const roundRestSec = document.getElementById('roundRestSec').value;
            const totalMin = document.getElementById('totalMin').value;
            const params = new URLSearchParams();
            params.set('r', rounds); params.set('e', exercises); params.set('s', sets);
            params.set('rs', restSec); params.set('re', exerciseRestSec); params.set('rr', roundRestSec); params.set('tm', totalMin);
            for (const [key, value] of Object.entries(speechSettings)) { if(value.text) { params.set(key, value.text); } }
            const baseUrl = window.location.origin + window.location.pathname; const shareUrl = baseUrl + '?' + params.toString();
            if (navigator.share) { navigator.share({ title: 'FNH Training Settings', url: shareUrl }).catch(console.error); } 
            else { navigator.clipboard.writeText(shareUrl).then(() => { alert("Link met instellingen gekopieerd!"); }); }
        }

        function checkForSharedSettings() {
            const params = new URLSearchParams(window.location.search);
            let dataUpdated = false;
            if(params.has('r')) {
                document.getElementById('rounds').value = params.get('r'); document.getElementById('exercises').value = params.get('e'); document.getElementById('sets').value = params.get('s');
                document.getElementById('restSec').value = params.get('rs'); document.getElementById('exerciseRestSec').value = params.get('re'); document.getElementById('roundRestSec').value = params.get('rr');
                document.getElementById('totalMin').value = params.get('tm'); dataUpdated = true;
            }
            let speechUpdated = false;
            for (const key in speechSettings) { if (params.has(key)) { speechSettings[key].text = params.get(key); speechUpdated = true; dataUpdated = true; } }
            if(speechUpdated) { const dropdown = document.getElementById('coach-preset'); if(dropdown) { dropdown.value = 'custom'; dropdown.querySelector('option[value="custom"]').removeAttribute('hidden'); dropdown.querySelector('option[value="custom"]').removeAttribute('disabled'); } }
            if(dataUpdated) { syncTime('duration'); saveToLocal(); }
        }

        function saveToLocal() {
            const data = {
                rounds: document.getElementById('rounds').value, exercises: document.getElementById('exercises').value, sets: document.getElementById('sets').value,
                restSec: document.getElementById('restSec').value, exerciseRestSec: document.getElementById('exerciseRestSec').value, roundRestSec: document.getElementById('roundRestSec').value,
                totalMin: document.getElementById('totalMin').value, audioMode: audioMode, speechSettings: speechSettings, 
                startRound: document.getElementById('start-round').value, startEx: document.getElementById('start-ex').value, startSet: document.getElementById('start-set').value,
                // Save 3 Bonuses
                bonus1: { name: document.getElementById('bonus1-name').value, dur: document.getElementById('bonus1-duration').value, freq: document.getElementById('bonus1-freq').value },
                bonus2: { name: document.getElementById('bonus2-name').value, dur: document.getElementById('bonus2-duration').value, freq: document.getElementById('bonus2-freq').value },
                bonus3: { name: document.getElementById('bonus3-name').value, dur: document.getElementById('bonus3-duration').value, freq: document.getElementById('bonus3-freq').value }
            };
            localStorage.setItem('fnh_settings_v8', JSON.stringify(data));
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('fnh_settings_v8');
            if(saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('rounds').value = data.rounds || 2; document.getElementById('exercises').value = data.exercises || 6; document.getElementById('sets').value = data.sets || 2;
                    document.getElementById('restSec').value = data.restSec || 20; document.getElementById('exerciseRestSec').value = data.exerciseRestSec || 30; document.getElementById('roundRestSec').value = data.roundRestSec || 90;
                    document.getElementById('totalMin').value = data.totalMin || 30;
                    if(data.startRound) document.getElementById('start-round').value = data.startRound;
                    if(data.startEx) document.getElementById('start-ex').value = data.startEx;
                    if(data.startSet) document.getElementById('start-set').value = data.startSet;
                    
                    // Load 3 Bonuses
                    if(data.bonus1) { document.getElementById('bonus1-name').value = data.bonus1.name; document.getElementById('bonus1-duration').value = data.bonus1.dur; document.getElementById('bonus1-freq').value = data.bonus1.freq; }
                    if(data.bonus2) { document.getElementById('bonus2-name').value = data.bonus2.name; document.getElementById('bonus2-duration').value = data.bonus2.dur; document.getElementById('bonus2-freq').value = data.bonus2.freq; }
                    if(data.bonus3) { document.getElementById('bonus3-name').value = data.bonus3.name; document.getElementById('bonus3-duration').value = data.bonus3.dur; document.getElementById('bonus3-freq').value = data.bonus3.freq; }

                    if(data.audioMode) setAudioMode(data.audioMode);
                    if(data.speechSettings) { for (const key in speechSettings) { if (data.speechSettings[key]) speechSettings[key] = data.speechSettings[key]; } }
                } catch(e) { console.log("Error loading settings", e); }
            }
        }
        
        function setAudioMode(newMode) {
            audioMode = newMode;
            document.getElementById('btn-audio-speech').className = (audioMode==='speech') ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('btn-audio-beep').className = (audioMode==='beep') ? 'toggle-btn active' : 'toggle-btn';
            const panel = document.getElementById('speech-settings-panel');
            if(audioMode === 'speech') panel.classList.remove('hidden'); else panel.classList.add('hidden');
        }

        function calculateRealTime() {
            const rounds = parseInt(document.getElementById('rounds').value) || 1; const ex = parseInt(document.getElementById('exercises').value) || 0; const sts = parseInt(document.getElementById('sets').value) || 0;
            const rst = parseInt(document.getElementById('restSec').value) || 0; const exRst = parseInt(document.getElementById('exerciseRestSec').value) || 0; const roundRst = parseInt(document.getElementById('roundRestSec').value) || 0;
            const startRound = parseInt(document.getElementById('start-round').value) || 1; const startEx = parseInt(document.getElementById('start-ex').value) || 1; const startSet = parseInt(document.getElementById('start-set').value) || 1;

            if (ex === 0 || sts === 0 || rounds === 0) return;

            let remainingWorkSets = 0; let remainingFixedRestTime = 0;
            
            // BONUS LOGIC CALCULATION (Loop 3 bonuses)
            // We iterate through structure and check conditions for all 3 bonuses
            
            // Warmup Check (Start of Session)
            for(let b=1; b<=3; b++) {
                const bMin = parseInt(document.getElementById(`bonus${b}-duration`).value) || 0;
                const bFreq = document.getElementById(`bonus${b}-freq`).value;
                if(bMin > 0 && bFreq === 'warmup') {
                    if (startRound === 1 && startEx === 1 && startSet === 1) {
                        remainingFixedRestTime += (bMin*60) + exRst;
                    }
                }
            }
            
            // Toetje Check (End of Session)
            for(let b=1; b<=3; b++) {
                const bMin = parseInt(document.getElementById(`bonus${b}-duration`).value) || 0;
                const bFreq = document.getElementById(`bonus${b}-freq`).value;
                if(bMin > 0 && bFreq === 'end_session') {
                    remainingFixedRestTime += (bMin*60) + exRst;
                }
            }

            let globalExCount = 0;

            for (let r = 1; r <= rounds; r++) { 
                
                // Start Round Check
                for(let b=1; b<=3; b++) {
                    const bMin = parseInt(document.getElementById(`bonus${b}-duration`).value) || 0;
                    const bFreq = document.getElementById(`bonus${b}-freq`).value;
                    if(bMin > 0 && bFreq === 'start_round') {
                        if (r >= startRound) {
                            if (r > startRound || (r === startRound && startEx === 1 && startSet === 1)) {
                                 remainingFixedRestTime += (bMin*60) + exRst; 
                            }
                        }
                    }
                }

                for (let e = 1; e <= ex; e++) { 
                    globalExCount++;
                    
                    // Interval Check
                    for(let b=1; b<=3; b++) {
                        const bMin = parseInt(document.getElementById(`bonus${b}-duration`).value) || 0;
                        const bFreq = document.getElementById(`bonus${b}-freq`).value;
                        if(bMin > 0 && !isNaN(bFreq) && (globalExCount % parseInt(bFreq) === 0)) {
                             let isFuture = false; 
                             if (r > startRound) isFuture = true; else if (r === startRound && e > startEx) isFuture = true; else if (r === startRound && e === startEx && sts >= startSet) isFuture = true; 
                             if(isFuture) remainingFixedRestTime += (bMin*60) + exRst;
                        }
                    }

                    for (let s = 1; s <= sts; s++) {
                        let isFuture = false; if (r > startRound) isFuture = true; else if (r === startRound && e > startEx) isFuture = true; else if (r === startRound && e === startEx && s >= startSet) isFuture = true;
                        if (isFuture) {
                            remainingWorkSets++;
                            const isLastSetOfWorkout = (r===rounds && e===ex && s===sts); const isLastSetOfRound = (e===ex && s===sts); const isLastSetOfExercise = (s===sts);
                            if (!isLastSetOfWorkout) { if (isLastSetOfRound) remainingFixedRestTime += roundRst; else if (isLastSetOfExercise) remainingFixedRestTime += exRst; else remainingFixedRestTime += rst; }
                        }
                    }
                }
                
                // End Round Check
                for(let b=1; b<=3; b++) {
                    const bMin = parseInt(document.getElementById(`bonus${b}-duration`).value) || 0;
                    const bFreq = document.getElementById(`bonus${b}-freq`).value;
                    if(bMin > 0 && bFreq === 'end_round') {
                        if (r >= startRound) {
                             if (r > startRound || (r === startRound)) { // Loose check for end of round
                                 remainingFixedRestTime += (bMin*60) + exRst;
                             }
                        }
                    }
                }
            }
            remainingFixedRestTime += 10; 

            let availableSec = 0;
            const endStr = document.getElementById('endTimeValue').value; 
            if (endStr) {
                const now = new Date(); const [h, m] = endStr.split(':'); const target = new Date(); target.setHours(h, m, 0, 0);
                if (target < now) target.setDate(target.getDate() + 1);
                availableSec = Math.floor((target - now) / 1000);
            }

            const workSecTotal = availableSec - remainingFixedRestTime;
            const btnEl = document.getElementById('btn-start-app'); const errEl = document.getElementById('live-calc-error'); const resEl = document.getElementById('live-calc-result');

            if (workSecTotal <= 0 || remainingWorkSets <= 0) {
                resEl.innerText = "--"; errEl.style.display = "block"; btnEl.style.opacity = 0.5; btnEl.disabled = true; workTimeSec = 0;
                document.getElementById('preview-list').innerHTML = "<div style='padding:10px; color:#555;'>Geen schema mogelijk</div>";
            } else {
                workTimeSec = Math.floor(workSecTotal / remainingWorkSets);
                resEl.innerText = workTimeSec + "s"; errEl.style.display = "none"; btnEl.style.opacity = 1; btnEl.disabled = false;
                restTimeSec = rst; exerciseRestSec = exRst; roundRestSec = roundRst;
                generateScheduleData(true); renderPreviewList();
            }
        }
        
        // --- NEW REVERSE CALC LOGIC ---
        function openCalcModal() {
            document.getElementById('calc-modal').style.display = 'flex';
            document.getElementById('target-work-sec').value = workTimeSec;
            previewCalc();
        }
        function closeCalcModal() { document.getElementById('calc-modal').style.display = 'none'; }
        
        function previewCalc() {
            const targetW = parseInt(document.getElementById('target-work-sec').value) || 0; const currentW = workTimeSec; 
            const diffPerSet = targetW - currentW; 
            const rounds = parseInt(document.getElementById('rounds').value); const ex = parseInt(document.getElementById('exercises').value); const sts = parseInt(document.getElementById('sets').value);
            const startRound = parseInt(document.getElementById('start-round').value); const startEx = parseInt(document.getElementById('start-ex').value); const startSet = parseInt(document.getElementById('start-set').value);
            let countSets = 0;
            for (let r = 1; r <= rounds; r++) { for (let e = 1; e <= ex; e++) { for (let s = 1; s <= sts; s++) {
                let isFuture = false; if (r > startRound) isFuture = true; else if (r === startRound && e > startEx) isFuture = true; else if (r === startRound && e === startEx && s >= startSet) isFuture = true;
                if (isFuture) countSets++;
            }}}
            
            const totalDiffSec = diffPerSet * countSets; 
            const totalDiffMin = Math.round(totalDiffSec / 60); 
            let sign = totalDiffMin >= 0 ? "+" : "";
            const currentEnd = document.getElementById('endTimeValue').value; const [h,m] = currentEnd.split(':'); const d = new Date(); d.setHours(h,m,0,0);
            d.setMinutes(d.getMinutes() + totalDiffMin);
            const endText = `Nieuw einde: ${d.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'})} (${sign}${totalDiffMin} min)`;
            document.getElementById('desc-calc-duration').innerText = endText;
            
            updateRestCalcButton('rest', 'btn-calc-rest', 'desc-calc-rest', totalDiffSec);
            updateRestCalcButton('exerciseRest', 'btn-calc-switch', 'desc-calc-switch', totalDiffSec);
            updateRestCalcButton('roundRest', 'btn-calc-round', 'desc-calc-round', totalDiffSec);
        }
        
        function updateRestCalcButton(type, btnId, textId, totalWorkDiff) {
            const btn = document.getElementById(btnId);
            const steps = countFutureRestSteps(type);
            if (steps > 0) {
                let currentVal = 0;
                if(type === 'rest') currentVal = parseInt(document.getElementById('restSec').value);
                if(type === 'exerciseRest') currentVal = parseInt(document.getElementById('exerciseRestSec').value);
                if(type === 'roundRest') currentVal = parseInt(document.getElementById('roundRestSec').value);
                const reductionPerStep = Math.ceil(totalWorkDiff / steps);
                const newVal = currentVal - reductionPerStep;
                if (newVal >= 5) {
                    btn.disabled = false; btn.style.opacity = 1;
                    document.getElementById(textId).innerText = `${currentVal}s -> ${newVal}s`;
                } else {
                    btn.disabled = true; btn.style.opacity = 0.5;
                    document.getElementById(textId).innerText = `Niet mogelijk (${newVal}s < 5s)`;
                }
            } else {
                btn.disabled = true; btn.style.opacity = 0.5; document.getElementById(textId).innerText = "Niet van toepassing";
            }
        }
        
        function countFutureRestSteps(type) {
            const rounds = parseInt(document.getElementById('rounds').value); const ex = parseInt(document.getElementById('exercises').value); const sts = parseInt(document.getElementById('sets').value);
            const startRound = parseInt(document.getElementById('start-round').value); const startEx = parseInt(document.getElementById('start-ex').value); const startSet = parseInt(document.getElementById('start-set').value);
            let count = 0;
            for (let r = 1; r <= rounds; r++) { for (let e = 1; e <= ex; e++) { for (let s = 1; s <= sts; s++) {
                let isFuture = false; if (r > startRound) isFuture = true; else if (r === startRound && e > startEx) isFuture = true; else if (r === startRound && e === startEx && s >= startSet) isFuture = true;
                if (isFuture) {
                    const isLastSetOfWorkout = (r===rounds && e===ex && s===sts); const isLastSetOfRound = (e===ex && s===sts); const isLastSetOfExercise = (s===sts);
                    if (!isLastSetOfWorkout) {
                        if (isLastSetOfRound) { if(type === 'roundRest') count++; }
                        else if (isLastSetOfExercise) { if(type === 'exerciseRest') count++; }
                        else { if(type === 'rest') count++; }
                    }
                }
            }}}
            return count;
        }
        
        function applyCalc(targetType) {
            const targetW = parseInt(document.getElementById('target-work-sec').value) || 0; 
            const currentW = workTimeSec; 
            const diffPerSet = targetW - currentW;
            const rounds = parseInt(document.getElementById('rounds').value); const ex = parseInt(document.getElementById('exercises').value); const sts = parseInt(document.getElementById('sets').value);
            const startRound = parseInt(document.getElementById('start-round').value); const startEx = parseInt(document.getElementById('start-ex').value); const startSet = parseInt(document.getElementById('start-set').value);
            let countSets = 0; for (let r = 1; r <= rounds; r++) { for (let e = 1; e <= ex; e++) { for (let s = 1; s <= sts; s++) { let isFuture = false; if (r > startRound) isFuture = true; else if (r === startRound && e > startEx) isFuture = true; else if (r === startRound && e === startEx && s >= startSet) isFuture = true; if (isFuture) countSets++; }}}
            const totalWorkDiff = diffPerSet * countSets;

            if (targetType === 'duration') {
                const totalAddSec = totalWorkDiff; 
                const addMin = Math.ceil(totalAddSec / 60);
                const el = document.getElementById('endTimeValue'); const [h,m] = el.value.split(':'); const d = new Date(); d.setHours(h,m,0,0);
                d.setMinutes(d.getMinutes() + addMin); el.value = d.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'});
                syncTime('endtime'); 
            } else {
                const steps = countFutureRestSteps(targetType);
                let elementId = '';
                if(targetType === 'rest') elementId = 'restSec';
                if(targetType === 'exerciseRest') elementId = 'exerciseRestSec';
                if(targetType === 'roundRest') elementId = 'roundRestSec';
                const currentRest = parseInt(document.getElementById(elementId).value);
                const reductionPerStep = Math.ceil(totalWorkDiff / steps);
                const newVal = currentRest - reductionPerStep;
                const sel = document.getElementById(elementId);
                let exists = false; for(let i=0; i<sel.options.length; i++){ if(parseInt(sel.options[i].value) === newVal) exists=true; }
                if(!exists) { const opt = document.createElement('option'); opt.value = newVal; opt.text = newVal+"s"; sel.appendChild(opt); }
                sel.value = newVal;
            }
            calculateRealTime(); saveToLocal(); closeCalcModal();
        }

        function generateScheduleData(applyResumeFilter) {
            const rounds = parseInt(document.getElementById('rounds').value); const ex = parseInt(document.getElementById('exercises').value); const sts = parseInt(document.getElementById('sets').value);
            const startRound = parseInt(document.getElementById('start-round').value); const startEx = parseInt(document.getElementById('start-ex').value); const startSet = parseInt(document.getElementById('start-set').value);
            const exerciseRestSec = parseInt(document.getElementById('exerciseRestSec').value);

            totalWorkSetsGlobal = rounds * ex * sts; let currentSetGlobal = 0;
            schedule = []; schedule.push({ type: 'prep', time: 10, label: "Voorbereiden", initialTime: 10, info: { round:1, exercise:1, set:1, maxRounds:rounds, maxEx:ex, maxSets:sts } });

            // Helper to get Bonus Settings
            const getBonus = (i) => {
                return {
                    name: document.getElementById(`bonus${i}-name`).value || `Bonus ${i}`,
                    min: parseInt(document.getElementById(`bonus${i}-duration`).value) || 0,
                    freq: document.getElementById(`bonus${i}-freq`).value
                };
            };

            // WARMUP BONUS (Check all 3)
            for(let b=1; b<=3; b++) {
                const bonus = getBonus(b);
                if (bonus.min > 0 && bonus.freq === 'warmup') {
                    if (!applyResumeFilter || (startRound === 1 && startEx === 1 && startSet === 1)) {
                        addBonusStep(0, bonus.name.toUpperCase(), bonus.min*60, exerciseRestSec);
                    }
                }
            }

            let globalExCount = 0;

            for (let r = 1; r <= rounds; r++) { 
                
                // START ROUND BONUS
                for(let b=1; b<=3; b++) {
                    const bonus = getBonus(b);
                    if(bonus.min > 0 && bonus.freq === 'start_round') {
                        let include = true;
                        if (applyResumeFilter) {
                            if (r < startRound) include = false;
                            else if (r === startRound && (startEx > 1 || startSet > 1)) include = false;
                        }
                        if (include) addBonusStep(r, bonus.name.toUpperCase(), bonus.min*60, exerciseRestSec);
                    }
                }

                for (let e = 1; e <= ex; e++) { 
                    globalExCount++;
                    
                    for (let s = 1; s <= sts; s++) {
                        currentSetGlobal++; let include = true;
                        if (applyResumeFilter) { if (r < startRound) include = false; else if (r === startRound && e < startEx) include = false; else if (r === startRound && e === startEx && s < startSet) include = false; }
                        if(include) {
                            schedule.push({ type: 'work', time: workTimeSec, initialTime: workTimeSec, label: "WERKEN", info: { round: r, exercise: e, set: s, maxRounds: rounds, maxEx: ex, maxSets: sts, globalSet: currentSetGlobal } });
                            const isLastSetOfWorkout = (r===rounds && e===ex && s===sts); const isLastSetOfRound = (e===ex && s===sts); const isLastSetOfExercise = (s===sts);
                            if (!isLastSetOfWorkout) {
                                let restLabel = "RUST"; let infoText = "";
                                if (isLastSetOfRound) { restLabel = "RONDE PAUZE"; infoText = "Even bijkomen..."; }
                                else if (isLastSetOfExercise) { restLabel = "WISSEL OEFENING"; infoText = `Op naar oefening ${e < ex ? e+1 : 1}`; }
                                else { infoText = "Even ontspannen"; }
                                let type = isLastSetOfRound ? 'rest-long' : (isLastSetOfExercise ? 'rest-exercise' : 'rest');
                                schedule.push({ type: type, time: (isLastSetOfRound ? roundRestSec : (isLastSetOfExercise ? exerciseRestSec : restTimeSec)), initialTime: (isLastSetOfRound ? roundRestSec : (isLastSetOfExercise ? exerciseRestSec : restTimeSec)), label: restLabel, info: { round: r, exercise: e, set: s, maxRounds: rounds, maxEx: ex, maxSets: sts, text: infoText } });
                            }
                        }
                    }
                    
                    // INTERVAL BONUS
                    for(let b=1; b<=3; b++) {
                        const bonus = getBonus(b);
                        if (bonus.min > 0 && !isNaN(bonus.freq) && (globalExCount % parseInt(bonus.freq) === 0)) {
                            let include = true;
                            if (applyResumeFilter) { if (r < startRound) include = false; else if (r === startRound && e < startEx) include = false; else if (r === startRound && e === startEx && sts < startSet) include = false; }
                            
                            if(include) addBonusStep(r, bonus.name.toUpperCase(), bonus.min*60, exerciseRestSec);
                        }
                    }
                }
                
                // END ROUND BONUS
                for(let b=1; b<=3; b++) {
                    const bonus = getBonus(b);
                    if(bonus.min > 0 && bonus.freq === 'end_round') {
                        let include = true;
                        if (applyResumeFilter && r < startRound) include = false;
                        if (include) addBonusStep(r, bonus.name.toUpperCase(), bonus.min*60, exerciseRestSec);
                    }
                }
            }
            
            // TOETJE BONUS
            for(let b=1; b<=3; b++) {
                const bonus = getBonus(b);
                if (bonus.min > 0 && bonus.freq === 'end_session') {
                    addBonusStep(0, bonus.name.toUpperCase(), bonus.min*60, exerciseRestSec);
                }
            }

            if(schedule.length > 1) schedule.push({ type: 'finish', time: 0, label: "KLAAR!", initialTime: 0, info: { text: "Goed gewerkt!" } }); else schedule = [];
        }
        
        function addBonusStep(r, label, time, rest) {
            schedule.push({ 
                type: 'work', 
                time: time, 
                initialTime: time, 
                label: label, 
                info: { round: r, exercise: 0, set: 0, globalSet: 0 } // 0 indicates bonus
            });
            schedule.push({ 
                type: 'rest-exercise', 
                time: rest, 
                initialTime: rest, 
                label: "WISSEL", 
                info: { round: r, exercise: 0, set: 0, text: "Klaarmaken..." } 
            });
        }

        function renderPreviewList() {
            const list = document.getElementById('preview-list'); list.innerHTML = ""; let runningDate = new Date();
            schedule.forEach((item) => {
                if (item.type==='finish') return;
                let timeStr = runningDate.toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                runningDate.setSeconds(runningDate.getSeconds() + item.time);
                const div = document.createElement('div'); div.className = `schedule-item`;
                let icon = ""; if(item.type==='rest-long') { div.style.borderLeft = "4px solid #0A84FF"; icon='‚òï'; } else if(item.type==='rest-exercise') { div.style.borderLeft = "4px solid #BF5AF2"; icon='üîÄ'; } else if(item.type==='work') icon='üî•'; else if(item.type==='rest') icon='üí§'; else icon='üöÄ';
                let desc = item.label; if(item.info && item.info.round && item.info.exercise > 0) desc += ` (R${item.info.round}/E${item.info.exercise}/S${item.info.set})`;
                div.innerHTML = `<div class="col-time">${timeStr}</div><div class="col-desc">${icon} ${desc}</div><div class="col-dur">${item.time}s</div>`;
                list.appendChild(div);
            });
        }

        function triggerAudio(key, fallbackText, extraInfo = "") {
            if (audioMode === 'beep') { if (key.includes('work')) playBeep(800, 'start'); else if (key.includes('rest')) playBeep(400, 'end'); else if (key === 'tick') playBeep(600, 'tick'); else if (key === 'finish') playBeep(1000, 'win'); return; } 
            if (!window.speechSynthesis) return;
            if(key === 'manual_override') { const utterance = new SpeechSynthesisUtterance(fallbackText); utterance.lang = 'nl-NL'; window.speechSynthesis.speak(utterance); return; }
            let setting = speechSettings[key]; if (!setting && key === 'tick') setting = speechSettings.prep_countdown; 
            if (!setting || !setting.enabled) return;
            let textToSpeak = fallbackText;
            if (setting.text && setting.text.trim() !== "") {
                const rawText = setting.text;
                if (!speechPlaylists[key] || speechPlaylists[key].originalText !== rawText) {
                    let phrases = rawText.split('|').map(s => s.trim()).filter(s => s !== "");
                    for (let i = phrases.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [phrases[i], phrases[j]] = [phrases[j], phrases[i]]; }
                    speechPlaylists[key] = { phrases: phrases, index: 0, originalText: rawText };
                }
                let pl = speechPlaylists[key]; if (pl.phrases.length > 0) { textToSpeak = pl.phrases[pl.index]; pl.index++; if (pl.index >= pl.phrases.length) pl.index = 0; }
            }
            if (extraInfo) textToSpeak += ". " + extraInfo;
            window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(textToSpeak); utterance.lang = 'nl-NL'; window.speechSynthesis.speak(utterance);
        }

        function playBeep(f,t){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g);g.connect(audioCtx.destination); o.frequency.value=f;o.type='sine'; const n=audioCtx.currentTime; if(t==='tick'){g.gain.setValueAtTime(0.1,n);o.start(n);o.stop(n+0.1);} else if(t==='win'){g.gain.setValueAtTime(0.1,n);o.start(n);o.stop(n+0.2);setTimeout(()=>playBeep(1200,'tick'),300);} else{g.gain.setValueAtTime(0.3,n);o.start(n);o.stop(n+0.5);} }

        function startWorkout() {
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(console.log);
            if(audioMode === 'beep') { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); } else { if(window.speechSynthesis) window.speechSynthesis.cancel(); }

            generateScheduleData(true);
            populateJumpMenus();

            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('timer-screen').style.display = 'flex';

            workoutStartTime = new Date();
            const [h, m] = document.getElementById('endTimeValue').value.split(':');
            targetEndTimeDate = new Date(); targetEndTimeDate.setHours(h, m, 0, 0);
            if (targetEndTimeDate < workoutStartTime) targetEndTimeDate.setDate(targetEndTimeDate.getDate() + 1);

            updateEndTimeDisplay();
            currentIndex = 0;
            speechPlaylists = {}; 
            stepEndTime = Date.now() + (schedule[0].time * 1000);
            runStep();
        }
        
        function populateJumpMenus() {
            const rounds = parseInt(document.getElementById('rounds').value); const ex = parseInt(document.getElementById('exercises').value); const sets = parseInt(document.getElementById('sets').value);
            const rSel = document.getElementById('jump-round'); const eSel = document.getElementById('jump-exercise'); const sSel = document.getElementById('jump-set');
            rSel.innerHTML = ""; eSel.innerHTML = ""; sSel.innerHTML = "";
            for(let i=1; i<=rounds; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = "Ronde " + i; rSel.appendChild(opt); }
            for(let i=1; i<=ex; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = "Oef " + i; eSel.appendChild(opt); }
            for(let i=1; i<=sets; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = "Set " + i; sSel.appendChild(opt); }
        }
        
        function handleJump() {
            const r = parseInt(document.getElementById('jump-round').value); const e = parseInt(document.getElementById('jump-exercise').value); const s = parseInt(document.getElementById('jump-set').value);
            const newIndex = schedule.findIndex(step => { return step.type === 'work' && step.info && step.info.round === r && step.info.exercise === e && step.info.set === s; });
            if(newIndex > -1) {
                currentIndex = newIndex;
                triggerAudio('manual_override', "Springen naar ronde " + r);
                stepEndTime = Date.now(); 
                runStep();
                recalculateForFixedEnd();
            }
        }

        function runStep() {
            if (currentIndex >= schedule.length) return;
            const step = schedule[currentIndex];
            const nextStep = schedule[currentIndex + 1];
            const totalRounds = parseInt(document.getElementById('rounds').value);
            const totalEx = document.getElementById('exercises').value;

            const body = document.body; body.className = ''; 
            const titleEl = document.getElementById('gym-phase-title'); const nextEl = document.getElementById('gym-next-info');
            
            if(step.info && step.info.maxRounds) {
                document.getElementById('val-round').innerText = `${step.info.round}/${step.info.maxRounds}`;
                // Only show exercise/set if not 0 (extra phase)
                if(step.info.exercise > 0) {
                    document.getElementById('val-exercise').innerText = `${step.info.exercise}/${step.info.maxEx}`;
                    document.getElementById('val-set').innerText = `${step.info.set}/${step.info.maxSets}`;
                    document.getElementById('jump-round').value = step.info.round; document.getElementById('jump-exercise').value = step.info.exercise; document.getElementById('jump-set').value = step.info.set;
                } else {
                    document.getElementById('val-exercise').innerText = "-";
                    document.getElementById('val-set').innerText = "-";
                }
                document.getElementById('gym-stats-container').style.opacity = 1;
            } else { document.getElementById('gym-stats-container').style.opacity = 0.5; }

            titleEl.innerText = step.label;
            titleEl.className = 'gym-phase-title';
            if (step.label === 'WERKEN' || step.label === 'RUST' || step.type === 'work') { 
                titleEl.classList.add('huge-text'); 
            }
            
            let nextText = "Hierna: Klaar";
            if(nextStep) { nextText = "Hierna: " + nextStep.label; if(nextStep.type === 'work' && nextStep.info && nextStep.info.exercise > 0) nextText += ` (Oef ${nextStep.info.exercise})`; }
            nextEl.innerText = nextText;

            if (step.type==='work') { 
                body.classList.add('mode-work');
                // Standard work audio triggers
                if (step.info.exercise > 0) {
                    if(step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.25)) triggerAudio('mile_start', "Goede start");
                    else if(step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.5)) triggerAudio('mile_half', "Helft");
                    else if(step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.75)) triggerAudio('mile_end', "Eindsprint");
                    else if(step.info.round === totalRounds && step.info.set === 1 && step.info.exercise === 1) triggerAudio('mile_lastround', "Laatste ronde");
                    else triggerAudio('work_start', "Start");
                } else {
                    // Custom Extra Start Audio
                    triggerAudio('work_start', `Start ${step.label}`);
                }
            }
            else if (step.type==='rest') { 
                body.classList.add('mode-rest');
                let info = ""; if (speechSettings.rest_set_tips.enabled) { const tips = ["Adem in, adem uit", "Schud je spieren los", "Slokje water", "Blijf gefocust"]; info = tips[Math.floor(Math.random()*tips.length)]; }
                triggerAudio('rest_set_start', "Rust", info);
            }
            else if (step.type==='rest-exercise') {
                body.classList.add('mode-switch');
                let info = ""; if (speechSettings.rest_switch_info.enabled && nextStep && nextStep.info && nextStep.info.exercise > 0) { info = `Hierna oefening ${nextStep.info.exercise} van de ${totalEx}`; }
                triggerAudio('rest_switch_start', "Wissel", info);
            }
            else if (step.type==='rest-long') { 
                body.classList.add('mode-long');
                let info = ""; if (speechSettings.rest_round_info.enabled && nextStep && nextStep.info) { info = `Hierna ronde ${nextStep.info.round} van de ${totalRounds}`; }
                triggerAudio('rest_round_start', "Grote pauze", info);
            }
            else if (step.type==='prep') { body.classList.add('mode-prep'); triggerAudio('prep_intro', "Welkom"); }
            else { finish(); return; }

            stepEndTime = Date.now() + (step.time * 1000); 
            document.getElementById('countdown').innerText = step.time;

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    const now = Date.now();
                    const remainingMs = stepEndTime - now;
                    let remainingSec = Math.ceil(remainingMs / 1000);
                    
                    if (remainingSec < 0) {
                        while (remainingSec < 0) {
                            currentIndex++; if(currentIndex >= schedule.length) { finish(); return; }
                            const skippedStep = schedule[currentIndex];
                            stepEndTime += (skippedStep.time * 1000); 
                            remainingSec = Math.ceil((stepEndTime - Date.now()) / 1000);
                        }
                        runStep(); return;
                    }

                    step.time = remainingSec;
                    document.getElementById('countdown').innerText = step.time;
                    updateProgressBar();
                    
                    const totalDiff = targetEndTimeDate - now;
                    if(totalDiff > 0) {
                        const m = Math.floor(totalDiff / 60000); const s = Math.floor((totalDiff % 60000) / 1000);
                        document.getElementById('val-remaining').innerText = `${m}m ${s}s`;
                    } else { document.getElementById('val-remaining').innerText = "0m 0s"; }

                    const init = step.initialTime;
                    if (step.type === 'work') {
                        if (step.time === Math.floor(init / 2) && init >= 30) triggerAudio('work_halfway', "Halverwege");
                        if (step.time === 30 && init > 40) triggerAudio('work_30s', "30 seconden");
                        if (step.time === 10 && init > 15) triggerAudio('work_10s', "10 seconden");
                        if (step.time === 5 && init > 10) triggerAudio('work_5s', "5 seconden");
                    }
                    if (step.type === 'rest-long' && step.time === 15 && init > 20) triggerAudio('rest_round_15s', "Nog 15 seconden, ga naar je oefening");
                    if (step.type === 'rest-exercise' && step.time === 10 && init > 15) triggerAudio('rest_switch_10s', "Nog 10 seconden");

                    if (step.time <= 0) { clearInterval(timerInterval); currentIndex++; runStep(); } 
                    else if (step.time <= 3) { triggerAudio('tick', step.time.toString()); }
                } else {
                    // Do nothing while paused
                }
            }, 1000);
        }

        function triggerEndTimeEdit() {
            const timeStr = targetEndTimeDate.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'});
            const input = document.getElementById('hidden-endtime-input'); input.value = timeStr;
            if ('showPicker' in HTMLInputElement.prototype) { try { input.showPicker(); } catch(e) { input.click(); } } else { input.click(); }
        }

        function handleNewEndTime(newVal) {
            if(!newVal) return;
            const [h, m] = newVal.split(':'); const newDate = new Date(); newDate.setHours(h, m, 0, 0);
            const now = new Date();
            if (newDate < now) { if (newDate.getTime() < now.getTime() - 12*3600*1000) { newDate.setDate(newDate.getDate() + 1); } }

            targetEndTimeDate = newDate;
            updateEndTimeDisplay(); recalculateForFixedEnd();
            triggerAudio('manual_override', "Eindtijd aangepast, schema herberekend");
        }

        function recalculateForFixedEnd() {
            const now = new Date();
            const secsRemaining = Math.floor((targetEndTimeDate - now) / 1000);
            let workStepsLeft = 0; let fixedRest = 0;
            for(let i=currentIndex; i<schedule.length; i++){
                if (schedule[i].type==='finish') continue;
                if (schedule[i].type.includes('rest')) fixedRest += schedule[i].time; 
                else if (schedule[i].type==='work') {
                    if (schedule[i].info && schedule[i].info.exercise > 0) {
                        workStepsLeft++;
                    } else {
                        fixedRest += schedule[i].time; 
                    }
                }
                else if (schedule[i].type==='prep') workStepsLeft++; 
            }
            
            if (workStepsLeft > 0) {
                const availableForWork = secsRemaining - fixedRest;
                let newWork = Math.floor(availableForWork / workStepsLeft);
                if (newWork < 5) newWork = 5; 
                
                const currentIsWork = (schedule[currentIndex].type === 'work' && schedule[currentIndex].info.exercise > 0);
                const oldWorkVal = schedule[currentIndex].initialTime; 

                for(let i=currentIndex; i<schedule.length; i++){
                    if (schedule[i].type==='work' && schedule[i].info.exercise > 0) { 
                        schedule[i].time = newWork; schedule[i].initialTime = newWork; 
                    }
                }
                if(currentIsWork) {
                    const diff = newWork - oldWorkVal;
                    stepEndTime += (diff * 1000);
                    document.getElementById('countdown').innerText = Math.ceil((stepEndTime - Date.now())/1000);
                }
            }
        }

        function handlePauseClick() {
            const btn = document.getElementById('btn-pause');
            if (!isPaused) {
                isPaused = true;
                pauseStartTime = Date.now();
                btn.innerText = "‚ñ∂Ô∏è"; 
                document.body.classList.add('mode-pause'); 
                document.getElementById('gym-phase-title').innerText = "GEPAUZEERD";
                triggerAudio('manual_override', "Gepauzeerd");
            } else {
                 previewPauseOptions(); 
                 document.getElementById('pause-modal').style.display = 'flex';
            }
        }

        function previewPauseOptions() {
            const now = Date.now();
            currentPauseDuration = Math.ceil((now - pauseStartTime) / 1000); 
            document.getElementById('pause-duration-display').innerText = currentPauseDuration + "s";
            
            const newEndDate = new Date(targetEndTimeDate.getTime() + (currentPauseDuration * 1000));
            const oldEndStr = targetEndTimeDate.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'});
            const newEndStr = newEndDate.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'});
            const extraMin = Math.ceil(currentPauseDuration / 60);
            document.getElementById('btn-text-push').innerText = `Van ${oldEndStr} naar ${newEndStr} (+${extraMin}m)`;
            
            const workSteps = countRemainingSteps('work');
            const btnWork = document.getElementById('btn-catch-work');
            if (workSteps > 0) {
                const deduction = Math.ceil(currentPauseDuration / workSteps);
                const currentWork = getFirstStepTime('work');
                const newWork = currentWork - deduction;
                if (newWork >= 5) {
                    btnWork.disabled = false; btnWork.style.opacity = 1;
                    document.getElementById('btn-text-work').innerText = `Werk: ${currentWork}s -> ${newWork}s`;
                } else {
                    btnWork.disabled = true; btnWork.style.opacity = 0.5;
                    document.getElementById('btn-text-work').innerText = `Niet mogelijk (Werk wordt < 5s)`;
                }
            } else {
                 btnWork.disabled = true; btnWork.style.opacity = 0.5; document.getElementById('btn-text-work').innerText = "Geen werksets meer";
            }
            
            updateCatchUpButton('rest', 'btn-catch-rest', 'btn-text-rest', "Rust");
            updateCatchUpButton('rest-exercise', 'btn-catch-switch', 'btn-text-switch', "Wissel");
            updateCatchUpButton('rest-long', 'btn-catch-round', 'btn-text-round', "Pauze");
        }
        
        function updateCatchUpButton(type, btnId, textId, label) {
            const steps = countRemainingSteps(type);
            const btn = document.getElementById(btnId);
            if (steps > 0) {
                const deduction = Math.ceil(currentPauseDuration / steps);
                const currentVal = getFirstStepTime(type);
                const newVal = currentVal - deduction;
                if (newVal >= 5) {
                    btn.disabled = false; btn.style.opacity = 1;
                    document.getElementById(textId).innerText = `${label}: ${currentVal}s -> ${newVal}s`;
                } else {
                    btn.disabled = true; btn.style.opacity = 0.5;
                    document.getElementById(textId).innerText = `Niet mogelijk (${label} < 5s)`;
                }
            } else {
                btn.disabled = true; btn.style.opacity = 0.5; document.getElementById(textId).innerText = "Niet van toepassing";
            }
        }
        
        function countRemainingSteps(type) {
            let count = 0;
            for(let i=currentIndex; i<schedule.length; i++) { 
                if (schedule[i].type === type) {
                    if (type === 'work') {
                        if (schedule[i].info && schedule[i].info.exercise > 0) count++;
                    } else {
                        count++;
                    }
                } 
            }
            return count;
        }
        
        function getFirstStepTime(type) {
            for(let i=currentIndex; i<schedule.length; i++) { if (schedule[i].type === type) return schedule[i].time; }
            return 0;
        }

        function resolvePause(choice) {
            document.getElementById('pause-modal').style.display = 'none';
            const btn = document.getElementById('btn-pause');
            btn.innerText = "‚è∏"; 
            isPaused = false;
            document.body.classList.remove('mode-pause');
            
            if (choice === 'push') {
                targetEndTimeDate = new Date(targetEndTimeDate.getTime() + (currentPauseDuration * 1000));
                updateEndTimeDisplay();
                stepEndTime += (currentPauseDuration * 1000); 
            } else {
                stepEndTime += (currentPauseDuration * 1000); 
                
                let typeToReduce = '';
                if(choice === 'work') typeToReduce = 'work';
                else if(choice === 'rest') typeToReduce = 'rest';
                else if(choice === 'switch') typeToReduce = 'rest-exercise';
                else if(choice === 'round') typeToReduce = 'rest-long';
                
                const steps = countRemainingSteps(typeToReduce);
                const deduction = Math.ceil(currentPauseDuration / steps);
                
                let currentStepReduced = false;
                for(let i=currentIndex; i<schedule.length; i++) { 
                    if (schedule[i].type === typeToReduce) {
                        if (typeToReduce === 'work' && schedule[i].info.exercise === 0) continue;

                        schedule[i].time = Math.max(5, schedule[i].time - deduction);
                        schedule[i].initialTime = schedule[i].time;
                        if(i === currentIndex) currentStepReduced = true;
                    }
                }
                
                if(currentStepReduced) {
                    stepEndTime -= (deduction * 1000);
                    document.getElementById('countdown').innerText = Math.ceil((stepEndTime - Date.now())/1000);
                }
            }
            
            const step = schedule[currentIndex];
            if (step.type==='work') document.body.classList.add('mode-work');
            else if (step.type==='rest') document.body.classList.add('mode-rest');
            else if (step.type==='rest-exercise') document.body.classList.add('mode-switch');
            else if (step.type==='rest-long') document.body.classList.add('mode-long');

            triggerAudio('manual_override', "We gaan weer door");
            document.getElementById('gym-phase-title').innerText = step.label;
            
             const titleEl = document.getElementById('gym-phase-title');
             titleEl.className = 'gym-phase-title';
             if (step.label === 'WERKEN' || step.label === 'RUST' || step.type === 'work') { titleEl.classList.add('huge-text'); }
        }

        function updateEndTimeDisplay() { 
            const timeStr = targetEndTimeDate.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'});
            document.getElementById('val-endtime').innerText = timeStr;
            document.getElementById('live-endtime-input').value = timeStr;
        }
        
        function updateProgressBar() {
            const now = new Date(); const totalMs = targetEndTimeDate - workoutStartTime; 
            if (totalMs <= 0) return;
            const elapsed = now - workoutStartTime;
            let pct = (elapsed / totalMs) * 100; if (pct>100) pct=100; if(pct<0) pct=0;
            document.getElementById('total-progress').style.width = pct + "%";
            document.getElementById('progress-text-center').innerText = Math.floor(pct) + "%";
        }
        
        function finish() {
            document.body.className = 'mode-finish';
            document.getElementById('gym-phase-title').innerText = "KLAAR!";
            document.getElementById('gym-phase-title').classList.remove('huge-text');
            document.getElementById('countdown').innerText = "üéâ";
            document.getElementById('gym-stats-container').style.display='none';
            document.getElementById('btn-pause').style.display='none';
            clearInterval(timerInterval);
            triggerAudio('finish', "Training klaar");
        }
        
        function resetApp() { clearInterval(timerInterval); location.reload(); }
        
        function confirmStop() { if(confirm("Weet je zeker dat je de training wilt stoppen?")) { resetApp(); } }
    </script>
</body>
</html>
