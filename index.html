<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Friday-night-hawk-s Timer v7.9</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --app-height: 100dvh;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            margin: 0; padding: 0;
            height: var(--app-height);
            width: 100vw;
            display: flex; flex-direction: column;
            overflow: hidden;
            overscroll-behavior: none; 
        }
        
        .container {
            padding: calc(10px + var(--safe-top)) 10px calc(10px + var(--safe-bottom)) 10px;
            height: 100%;
            display: flex; flex-direction: column;
            overflow-y: auto; 
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* --- INTRO BANNER --- */
        .intro-banner {
            background: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .intro-title {
            font-size: 16px;
            font-weight: 900;
            color: #30D158;
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }
        .intro-text {
            font-size: 13px;
            color: #ccc;
            line-height: 1.4;
        }

        /* --- LOGO & HEADER --- */
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .app-logo {
            width: 120px;
            height: auto;
            border-radius: 50%;
            border: 2px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
        }

        .app-header {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            text-align: left;
        }
        .version-tag {
            font-size: 11px;
            color: #30D158;
            background: #1c1c1e;
            padding: 2px 5px;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 5px;
            font-weight: bold;
            border: 1px solid #333;
        }
        
        .header-buttons { display: flex; gap: 5px; }

        .btn-header {
            border: none;
            border-radius: 20px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s;
        }
        .btn-header:active { opacity: 0.6; }
        .btn-save { background: #0A84FF; color: white; }
        .btn-reset { background: #333; color: #ccc; border: 1px solid #444; }
        .btn-share-app { background: #BF5AF2; color: white; }

        /* --- GRID SYSTEM --- */
        .grid-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .input-group { display: flex; flex-direction: column; min-width: 0; }

        label { 
            display: block; font-size: 12px; color: #888; margin-bottom: 4px; text-align: left; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        
        .input-wrapper { display: flex; align-items: center; width: 100%; }
        .input-wrapper input {
            flex: 1; text-align: center; font-size: 18px; padding: 10px 0;
            background: #1c1c1e; border: 1px solid #333;
            border-left: none; border-right: none; color: white;
            border-radius: 0; 
            appearance: none; -webkit-appearance: none; -moz-appearance: textfield;
            min-width: 0; width: 100%;
        }
        .btn-adjust {
            background: #333; color: #fff; border: 1px solid #333;
            font-size: 20px; font-weight: bold; 
            width: 40px; height: 44px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; touch-action: manipulation;
            user-select: none;
            flex-shrink: 0;
        }
        .btn-minus { border-radius: 8px 0 0 8px; }
        .btn-plus { border-radius: 0 8px 8px 0; }

        input[type="time"] {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; 
            background: #1c1c1e; color: white; font-size: 20px;
            display: block;
            appearance: none; -webkit-appearance: none;
            font-family: inherit;
        }

        /* --- TOGGLES --- */
        .toggle-container { display: flex; background: #1c1c1e; border-radius: 8px; padding: 4px; margin-bottom: 12px; flex-shrink: 0; }
        .toggle-btn {
            flex: 1; padding: 10px; border: none; background: transparent;
            color: #666; font-weight: bold; border-radius: 6px; cursor: pointer; font-size: 14px; transition: 0.2s;
        }
        .toggle-btn.active { background: #333; color: #fff; }

        /* --- SPEECH SETTINGS --- */
        .speech-options, .resume-options {
            background: #1c1c1e;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #333;
            text-align: left;
        }
        .resume-options { border-color: #555; margin-top: 15px; margin-bottom: 30px; } 

        .category-header {
            margin-top: 20px; margin-bottom: 10px;
            font-size: 12px; font-weight: 900; color: #30D158; 
            text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid #333; padding-bottom: 5px;
        }
        .category-header:first-child { margin-top: 0; }

        .switch-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0;
        }
        .switch-label { font-size: 14px; color: #fff; flex: 1; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; flex-shrink: 0;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .4s; border-radius: 30px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #30D158; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Custom Text Input */
        .text-input { 
            width: 100%; background: #2a2a2c; border: 1px solid #444; color: #ccc; 
            padding: 8px; border-radius: 6px; font-size: 13px; margin-bottom: 10px; margin-top: 2px;
        }
        select.text-input {
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }
        .text-input::placeholder { color: #555; }

        /* --- COLLAPSIBLE (Resume only) --- */
        .collapsible-header {
            background: #2c2c2e; padding: 10px; font-size: 12px; font-weight: bold;
            color: #fff; text-transform: uppercase; cursor: pointer; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .collapsible-header:hover { background: #3a3a3c; }
        .collapsible-content { padding: 10px; background: #151516; border-radius: 6px; margin-top: 5px; }
        .collapsible-content.hidden { display: none; }
        .arrow { font-size: 10px; transition: transform 0.2s; }
        .open .arrow { transform: rotate(180deg); }


        /* --- BUTTONS --- */
        button.action-btn {
            width: 100%; padding: 16px; font-size: 18px; font-weight: bold;
            border: none; border-radius: 12px; cursor: pointer; margin-top: 5px; margin-bottom: 20px; flex-shrink: 0;
        }
        .btn-start { background-color: #30D158; color: black; }
        .btn-stop { background-color: #FF453A; color: white; width: auto; padding: 10px 20px; font-size: 14px; border-radius: 8px;}
        .btn-pause { background-color: #FF9F0A; color: black; flex: 1; margin: 0 10px; border-radius: 8px; font-weight: bold; font-size: 18px; border:none;}
        .btn-nav { background: #333; color: white; border: none; width: 55px; border-radius: 8px; font-size: 24px; font-weight: bold; cursor: pointer;}

        /* --- INFO BOX --- */
        .info-bar {
            background: #111; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; flex-shrink: 0; margin-top: 5px;
        }

        /* --- LISTS --- */
        .schedule-list-wrapper {
            flex: 1; text-align: left; background: #000; border-top: 1px solid #222; overflow-y: auto; min-height: 100px;
        }
        .schedule-item { padding: 10px; border-bottom: 1px solid #1a1a1a; color: #555; display: flex; align-items: center; font-size: 14px; }
        .schedule-item.active { color: #fff; background: #1c1c1e; border-left: 4px solid #30D158; }
        .col-time { width: 60px; font-family: monospace; color: #888; font-size: 12px; flex-shrink: 0; }
        .col-desc { flex: 1; padding: 0 8px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .col-dur  { width: 40px; text-align: right; font-weight: bold; flex-shrink: 0;}
        
        /* --- TIMER SCREEN --- */
        #timer-screen { display: none; height: 100%; flex-direction: column; padding-bottom: var(--safe-bottom); }
        
        /* PROGRESS BAR */
        .progress-container { 
            width: 100%; height: 30px; background: #222; margin-top: var(--safe-top); 
            position: relative; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #333;
        }
        .progress-fill { 
            position: absolute; left: 0; top: 0; bottom: 0; background: #30D158; width: 0%; 
            transition: width 0.2s linear; z-index: 1; 
        }
        #progress-text {
            z-index: 2; color: white; font-size: 14px; font-weight: bold; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .timer-top { flex: 0 0 auto; padding: 15px; border-bottom: 1px solid #333; background: #000; z-index: 10; }
        .top-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .big-time { font-size: 64px; font-weight: bold; font-variant-numeric: tabular-nums; line-height: 1; letter-spacing: -2px; }
        .status-text { font-size: 14px; font-weight: bold; text-transform: uppercase; color: #888; margin-bottom: 5px;}
        .controls-row { display: flex; justify-content: space-between; height: 55px; margin-top: 10px; }

        /* --- MODAL --- */
        #pause-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #1c1c1e; padding: 25px; border-radius: 16px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-btn { display: block; width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="setup-screen" class="container">
        
        <div class="logo-container">
            <img src="FNH logo.jpg" alt="FNH Logo" class="app-logo">
        </div>

        <div class="header-row">
            <div class="app-header">
                FNH Timer <span class="version-tag">v7.9</span>
            </div>
            <div class="header-buttons">
                <button class="btn-header btn-reset" onclick="resetToDefaults()">üîÑ Reset</button>
                <button class="btn-header btn-save" onclick="shareSettings()">üíæ Save</button>
                <button class="btn-header btn-share-app" onclick="shareApp()">üì§ Delen</button>
            </div>
        </div>

        <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:5px;">TIJDSINSTELLINGEN</div>
        
        <div class="toggle-container">
            <button class="toggle-btn active" id="btn-mode-endtime" onclick="setMode('endtime')">Eindtijd</button>
            <button class="toggle-btn" id="btn-mode-duration" onclick="setMode('duration')">Tijdsduur</button>
        </div>

        <div id="input-endtime" style="margin-bottom: 10px;">
            <label>Klaar om (HH:MM)</label>
            <input type="time" id="endTimeValue">
        </div>

        <div class="hidden" id="input-duration">
            <label>Totale trainingstijd (min)</label>
            <div class="input-wrapper">
                <button class="btn-adjust btn-minus" onclick="adjustValue('totalMin', -5)">‚àí</button>
                <input type="number" id="totalMin" value="30" inputmode="numeric">
                <button class="btn-adjust btn-plus" onclick="adjustValue('totalMin', 5)">+</button>
            </div>
        </div>
        
        <div class="grid-row">
            <div class="input-group">
                <label>Rondes</label>
                <div class="input-wrapper">
                    <button class="btn-adjust btn-minus" onclick="adjustValue('rounds', -1)">‚àí</button>
                    <input type="number" id="rounds" value="2" inputmode="numeric">
                    <button class="btn-adjust btn-plus" onclick="adjustValue('rounds', 1)">+</button>
                </div>
            </div>
            <div class="input-group">
                <label>Oefeningen</label>
                <div class="input-wrapper">
                    <button class="btn-adjust btn-minus" onclick="adjustValue('exercises', -1)">‚àí</button>
                    <input type="number" id="exercises" value="6" inputmode="numeric">
                    <button class="btn-adjust btn-plus" onclick="adjustValue('exercises', 1)">+</button>
                </div>
            </div>
        </div>

        <div class="input-group" style="margin-bottom: 8px;">
            <label>Sets per oefening</label>
            <div class="input-wrapper">
                <button class="btn-adjust btn-minus" onclick="adjustValue('sets', -1)">‚àí</button>
                <input type="number" id="sets" value="2" inputmode="numeric">
                <button class="btn-adjust btn-plus" onclick="adjustValue('sets', 1)">+</button>
            </div>
        </div>

        <div class="grid-row">
            <div class="input-group">
                <label>Rust (set)</label>
                <div class="input-wrapper">
                    <button class="btn-adjust btn-minus" onclick="adjustValue('restSec', -5)">‚àí</button>
                    <input type="number" id="restSec" value="20" inputmode="numeric">
                    <button class="btn-adjust btn-plus" onclick="adjustValue('restSec', 5)">+</button>
                </div>
            </div>
            <div class="input-group">
                <label>Rust (wissel)</label>
                <div class="input-wrapper">
                    <button class="btn-adjust btn-minus" onclick="adjustValue('exerciseRestSec', -5)">‚àí</button>
                    <input type="number" id="exerciseRestSec" value="30" inputmode="numeric">
                    <button class="btn-adjust btn-plus" onclick="adjustValue('exerciseRestSec', 5)">+</button>
                </div>
            </div>
        </div>

        <div class="input-group" style="margin-bottom: 8px;">
            <label>Rust (ronde)</label>
            <div class="input-wrapper">
                <button class="btn-adjust btn-minus" onclick="adjustValue('roundRestSec', -10)">‚àí</button>
                <input type="number" id="roundRestSec" value="90" inputmode="numeric">
                <button class="btn-adjust btn-plus" onclick="adjustValue('roundRestSec', 10)">+</button>
            </div>
        </div>

        <div class="info-bar">
            <div style="font-size:12px; color:#888;">WERKTIJD PER SET</div>
            <div style="font-size:30px; font-weight:bold; color:#30D158;" id="live-calc-result">--</div>
            <div id="live-calc-error" style="color:#FF453A; display:none; font-size:12px;">Onmogelijk schema!</div>
        </div>
        
        <button class="action-btn btn-start" id="btn-start-app" onclick="startWorkout()">START TRAINING</button>
        
        <div class="resume-options">
            <div class="collapsible-header resume-header open" onclick="toggleSection('sec-resume')">
                <div>Beginnen vanaf moment in training</div>
                <span class="arrow">‚ñº</span>
            </div>
            <div id="sec-resume" class="collapsible-content">
                <div style="font-size:12px; color:#aaa; margin-bottom:8px;">Vul hieronder in waar je wilt starten.</div>
                <div class="grid-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="input-group">
                        <label>Ronde</label>
                        <div class="input-wrapper">
                            <button class="btn-adjust btn-minus" onclick="adjustValue('start-round', -1)">‚àí</button>
                            <input type="number" id="start-round" value="1" inputmode="numeric">
                            <button class="btn-adjust btn-plus" onclick="adjustValue('start-round', 1)">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Oefening</label>
                        <div class="input-wrapper">
                             <button class="btn-adjust btn-minus" onclick="adjustValue('start-ex', -1)">‚àí</button>
                            <input type="number" id="start-ex" value="1" inputmode="numeric">
                             <button class="btn-adjust btn-plus" onclick="adjustValue('start-ex', 1)">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Set</label>
                        <div class="input-wrapper">
                             <button class="btn-adjust btn-minus" onclick="adjustValue('start-set', -1)">‚àí</button>
                            <input type="number" id="start-set" value="1" inputmode="numeric">
                             <button class="btn-adjust btn-plus" onclick="adjustValue('start-set', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:5px;">GELUIDSINSTELLINGEN (SPRAAK)</div>
        
        <div class="toggle-container">
            <button class="toggle-btn active" id="btn-audio-speech" onclick="setAudioMode('speech')">üó£Ô∏è Spraak</button>
            <button class="toggle-btn" id="btn-audio-beep" onclick="setAudioMode('beep')">üîî Piepjes</button>
        </div>

        <div class="input-group" style="margin-bottom: 15px;">
            <label style="color:#30D158; font-weight:bold;">Kies je Coach Stijl</label>
            <select id="coach-preset" class="text-input" onchange="applyCoachPreset(this.value)" style="font-size:16px; padding:12px;">
                <option value="standard" selected>Standaard Coach</option>
                <option value="simple">Simpel (Alleen info)</option>
                <option value="sergeant">Drill Sergeant ü™ñ</option>
                <option value="humor">Humor & Bitterballen ü§£</option>
                <option value="custom" disabled hidden>Ge√Ømporteerd / Aangepast</option>
            </select>
        </div>
        <div style="font-size:11px; color:#888; margin-bottom:10px; margin-top:-10px;">
            Tip: Je kunt meerdere zinnen scheiden met een <b>|</b> teken. De app kiest dan willekeurig een zin (zonder direct te herhalen).
        </div>

        <div id="speech-settings-panel" class="speech-options">
            </div>

        <div style="text-align:left; padding:5px 0; font-size:12px; color:#666; margin-top:20px;">VOORBEELD SCHEMA (VANAF NU):</div>
        <div id="preview-list" class="schedule-list-wrapper">
        </div>
        
        <div class="intro-banner">
            <div class="intro-title">ü¶Ö Welcome to the Friday Night Hawks!</div>
            <div class="intro-text">
                De legendarische triathlon: <b>Spinning üö¥ ¬ª Bootcamp üèãÔ∏è ¬ª Zwemmen üèä</b>.
                <br>Iedere vrijdagavond om 19:45. We sluiten af met <b>bitterballen</b> & gezelligheid! üçñüçª
            </div>
        </div>

    </div>

    <div id="timer-screen">
        <div class="progress-container">
            <div class="progress-fill" id="total-progress"></div>
            <div id="progress-text">0%</div>
        </div>
        <div class="timer-top">
            <div class="top-row">
                <div style="text-align: left;">
                    <div class="status-text" id="current-status">KLAARMAKEN</div>
                    <div class="big-time" id="countdown">--</div>
                </div>
                <div style="text-align: right;">
                    <div class="status-text">KLAAR OM</div>
                    <div style="font-size: 20px; font-weight: bold;" id="display-end-time">--:--</div>
                    <div style="font-size: 14px; color: #888; margin-top: 4px;" id="total-time-left">Nog --:--:--</div>
                </div>
            </div>
            <div class="controls-row">
                <button class="btn-nav" onclick="skipStep(-1)">‚ùÆ</button>
                <button class="btn-pause" id="btn-pause" onclick="handlePauseClick()">PAUZE</button>
                <button class="btn-nav" onclick="skipStep(1)">‚ùØ</button>
                <button class="btn-stop" style="margin-left: 10px;" onclick="resetApp()">STOP</button>
            </div>
        </div>
        <div class="schedule-list-wrapper" id="schedule-list-active"></div>
    </div>

    <div id="pause-modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Pauze voorbij</h2>
            <p style="color:#aaa;">Wat wil je doen?</p>
            <button class="modal-btn" style="background: #0A84FF; color: white;" onclick="resolvePause('recalc')">‚è±Ô∏è Inhalen (korter werken)</button>
            <button class="modal-btn" style="background: #333; color: white;" onclick="resolvePause('push')">üê¢ Eindtijd verzetten</button>
        </div>
    </div>

    <script>
        // --- VARIABELEN ---
        let mode = 'endtime';
        let audioMode = 'speech';
        let speechPlaylists = {}; 
        
        // --- COACH PRESETS DEFINITIONS (v7.8) ---
        const coachPresets = {
            standard: {
                prep_intro: { enabled: true, text: "Welkom hawks bij leukste training van de week!" },
                prep_countdown: { enabled: true, text: "" }, 
                work_start: { enabled: true, text: "Start met werken | Go, aan de slag | En... actie | Kom op, beginnen | Tijd om te knallen" },
                work_halfway: { enabled: true, text: "Halverwege!" }, 
                work_30s: { enabled: false, text: "Nog 30 seconden" },
                work_10s: { enabled: true, text: "Nog 10 seconden | Laatste 10 | Bijna klaar | Aftellen loopt" },
                rest_set_start: { enabled: true, text: "Rust | Even ontspannen | Stop maar | Pak je rust | Ontspan" },
                rest_set_tips: { enabled: true, text: "" }, 
                rest_switch_start: { enabled: true, text: "Wissel van oefening | Door naar de volgende | Wisselen maar | Volgende station" },
                rest_switch_info: { enabled: true, text: "" }, 
                rest_switch_10s: { enabled: true, text: "Nog 10 seconden" },
                rest_round_start: { enabled: true, text: "Grote pauze | Even bijkomen | Ronde voorbij | Tijd voor wat drinken" },
                rest_round_15s: { enabled: true, text: "Nog 15 seconden, ga naar je oefening" }, 
                rest_round_info: { enabled: true, text: "" }, 
                mile_start: { enabled: true, text: "Goede start, ga zo door | Lekker begin!" },
                mile_half: { enabled: true, text: "Je bent op de helft van de training | We zijn er bijna, helft gehad" },
                mile_end: { enabled: true, text: "Laatste loodjes, eindsprint | Het einde is in zicht" },
                mile_lastround: { enabled: true, text: "Laatste ronde, alles geven | Nog √©√©n ronde te gaan" },
                finish: { enabled: true, text: "Gefeliciteerd, training voltooid | Dat was hem weer, goed gedaan!" }
            },
            simple: {
                prep_intro: { enabled: true, text: "Training start." },
                prep_countdown: { enabled: true, text: "" },
                work_start: { enabled: true, text: "Start. | Go. | Begin." },
                work_halfway: { enabled: true, text: "Helft." },
                work_30s: { enabled: false, text: "30." },
                work_10s: { enabled: true, text: "10." },
                rest_set_start: { enabled: true, text: "Rust. | Stop." },
                rest_set_tips: { enabled: false, text: "" }, 
                rest_switch_start: { enabled: true, text: "Wissel." },
                rest_switch_info: { enabled: true, text: "" },
                rest_switch_10s: { enabled: true, text: "Nog 10." },
                rest_round_start: { enabled: true, text: "Ronde rust." },
                rest_round_15s: { enabled: true, text: "Klaarstaan." },
                rest_round_info: { enabled: true, text: "" },
                mile_start: { enabled: false, text: "" },
                mile_half: { enabled: true, text: "50 procent." },
                mile_end: { enabled: false, text: "" },
                mile_lastround: { enabled: true, text: "Laatste ronde." },
                finish: { enabled: true, text: "Klaar." }
            },
            sergeant: {
                prep_intro: { enabled: true, text: "Aantreden! Ik wil zweet zien vandaag! | Klaarstaan! We gaan beginnen! | Geen genade vandaag!" },
                prep_countdown: { enabled: true, text: "" },
                work_start: { enabled: true, text: "Bewegen! Nu! | Geen smoesjes, werken! | Pijn is fijn, start! | Tempo maken! Go! | Aan het werk! | Gas erop, nu! | Niet nadenken, doen!" },
                work_halfway: { enabled: true, text: "Niet verslappen! | Doorgaan! | Ik wil zweet zien! | Is dat alles wat je hebt? | Kom op, sneller! | Niet janken, doorwerken!" },
                work_30s: { enabled: true, text: "Nog 30 seconden, tempo! | Versnel!" },
                work_10s: { enabled: true, text: "Laatste 10, alles geven! | Niet stoppen nu! | Doorgaan tot het gaatje! | Pijn is tijdelijk!" },
                rest_set_start: { enabled: true, text: "Herstel! En sta rechtop! | Stop! Blijf in beweging! | Rust! Niet gaan liggen! | Staande houden!" },
                rest_set_tips: { enabled: false, text: "" },
                rest_switch_start: { enabled: true, text: "Wissel! Marcheer naar de volgende! | Opschieten, doorlopen! | Volgende oefening, nu! | Geen tijd te verliezen, wissel!" },
                rest_switch_info: { enabled: true, text: "" },
                rest_switch_10s: { enabled: true, text: "Opschieten! Nog 10! | Sta klaar!" },
                rest_round_start: { enabled: true, text: "Ronde rust! Drinken en bek houden! | Pauze! Even bijkomen en dan weer knallen!" },
                rest_round_15s: { enabled: true, text: "Terug op je post! Nu! | Aantreden voor de volgende ronde! | Klaarstaan soldaten!" },
                rest_round_info: { enabled: true, text: "" },
                mile_start: { enabled: true, text: "Begin is er, maar we zijn er nog lang niet!" },
                mile_half: { enabled: true, text: "Helft erop! Is dat alles wat je hebt? | We zijn pas op de helft!" },
                mile_end: { enabled: true, text: "Eindsprint! Pijn is fijn! | Alles eruit persen nu!" },
                mile_lastround: { enabled: true, text: "Laatste ronde! Slopen die hap! | Maak me trots, laatste ronde!" },
                finish: { enabled: true, text: "Missie volbracht. Inrukken! | Training voltooid. Douchen en wegwezen." }
            },
            humor: {
                prep_intro: { enabled: true, text: "H√© atleten, we doen dit voor de bitterballen! | Zijn we er klaar voor? De bar is nog dicht! | Vergeet je handdoek niet, voor het zweet of de tranen." },
                prep_countdown: { enabled: true, text: "" },
                work_start: { enabled: true, text: "Hup, actie in de taxi! | Bewegen met dat lijf! | Hop hop, gas erop! | Niet kletsen, maar zweten! | En... gaan met die banaan! | Doe alsof er gratis bier is! | Rennen voor je leven! | Hup, die calorie√´n moeten eraf!" },
                work_halfway: { enabled: true, text: "Nog even, de bar is al bijna open! | Denk aan de bitterballen! | Zweten is huilen van het vet! | Kom op, je kan het (denk ik)! | Kijk naar de buren, die zweten ook." },
                work_30s: { enabled: false, text: "" },
                work_10s: { enabled: true, text: "Nog 10 seconden afzien! | Bijna klaar, hou vol! | Nog even doorbijten! | De verlossing is nabij!" },
                rest_set_start: { enabled: true, text: "Even hijgen als een postpaard. | En.. relax. | Zo, dat viel mee toch? | Even bijkomen." },
                rest_set_tips: { enabled: true, text: "" },
                rest_switch_start: { enabled: true, text: "Wissel! Niet smokkelen! | Hup hup, naar de volgende martelgang. | Doorwisselen, niet stiekem rusten. | Op naar het volgende pretpark." },
                rest_switch_info: { enabled: true, text: "" },
                rest_switch_10s: { enabled: true, text: "Nog 10 tellen, opschieten!" },
                rest_round_start: { enabled: true, text: "Grote pauze! Tijd voor sterke verhalen. | Neem een slokje, je hebt het nodig. | Even checken of je haar nog goed zit." },
                rest_round_15s: { enabled: true, text: "Kom op, buik in en borst vooruit. | We gaan weer bijna beginnen! | Zet je schrap." },
                rest_round_info: { enabled: true, text: "" },
                mile_start: { enabled: true, text: "Lekker bezig pik! | We zijn los!" },
                mile_half: { enabled: true, text: "We zijn op de helft, de bitterballen komen dichterbij! | 50% gedaan, 50% te gaan." },
                mile_end: { enabled: true, text: "Laatste loodjes wegen het zwaarst, maar smaken het best! | Het einde is in zicht, hou vol." },
                mile_lastround: { enabled: true, text: "Laatste ronde, daarna bier! | Nog √©√©n keertje vlammen!" },
                finish: { enabled: true, text: "Jaaa! Tijd voor bier en ballen! Goed gewerkt! | Jullie hebben het overleefd, proost!" }
            }
        };

        // Initialize
        let speechSettings = JSON.parse(JSON.stringify(coachPresets.standard));

        // UI Config
        const uiConfig = [
            { header: "Voorbereiding" },
            { id: "prep_intro", label: "Introductie tekst", type: "text" },
            { id: "prep_countdown", label: "Aftellen (3, 2, 1)", type: "bool" },
            { header: "Tijdens Oefening (Werken)" },
            { id: "work_start", label: "Start commando", type: "text" },
            { id: "work_halfway", label: "Melding halverwege", type: "text" },
            { id: "work_30s", label: "Nog 30 seconden", type: "text" },
            { id: "work_10s", label: "Nog 10 seconden", type: "text" },
            { id: "work_5s", label: "Nog 5 seconden", type: "text" },
            { header: "Tijdens Rust (Set)" },
            { id: "rest_set_start", label: "Rust commando", type: "text" },
            { id: "rest_set_tips", label: "Willekeurige tips (ademhaling/drinken)", type: "bool" },
            { header: "Tijdens Rust (Wissel)" },
            { id: "rest_switch_start", label: "Wissel commando", type: "text" },
            { id: "rest_switch_info", label: "Noem volgende oefening nummer", type: "bool" },
            { id: "rest_switch_10s", label: "Waarschuwing 10s voor einde", type: "text" },
            { header: "Tijdens Rust (Ronde)" },
            { id: "rest_round_start", label: "Grote pauze commando", type: "text" },
            { id: "rest_round_info", label: "Noem volgende ronde nummer", type: "bool" },
            { id: "rest_round_15s", label: "Waarschuwing 15s voor einde", type: "text" },
            { header: "Mijlpalen & Einde" },
            { id: "mile_start", label: "25% (Goede start)", type: "text" },
            { id: "mile_half", label: "50% (Helft)", type: "text" },
            { id: "mile_end", label: "75% (Eindsprint)", type: "text" },
            { id: "mile_lastround", label: "Start laatste ronde", type: "text" },
            { id: "finish", label: "Einde training", type: "text" }
        ];

        let schedule = [];
        let workTimeSec = 0, restTimeSec = 0, exerciseRestSec = 0, roundRestSec = 0;
        let currentIndex = 0;
        let timerInterval;
        let isPaused = false;
        let workoutStartTime, targetEndTimeDate;
        let totalWorkSetsGlobal = 0; 
        let audioCtx; 
        let stepEndTime = 0; 

        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocal();
            renderSpeechSettings(); 
            checkForSharedSettings();

            if(!document.getElementById('endTimeValue').value) {
                const d = new Date(); 
                d.setMinutes(d.getMinutes() + 30);
                const timeString = d.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('endTimeValue').value = timeString;
            }

            document.querySelectorAll('input.param-input').forEach(i => {
                i.addEventListener('input', () => { calculateRealTime(); saveToLocal(); });
            });
            
            document.getElementById('btn-audio-speech').onclick = () => { setAudioMode('speech'); saveToLocal(); };
            document.getElementById('btn-audio-beep').onclick = () => { setAudioMode('beep'); saveToLocal(); };
            
            document.getElementById('btn-mode-endtime').onclick = () => { setMode('endtime'); saveToLocal(); };
            document.getElementById('btn-mode-duration').onclick = () => { setMode('duration'); saveToLocal(); };
            
            document.addEventListener("visibilitychange", handleVisibilityChange);

            calculateRealTime(); 
        });
        
        function handleVisibilityChange() {
            if (document.visibilityState === 'visible' && !isPaused && timerInterval) { }
        }

        // --- NEW: APPLY PRESET FUNCTION ---
        function applyCoachPreset(presetName) {
            const preset = coachPresets[presetName];
            if (preset) {
                speechSettings = JSON.parse(JSON.stringify(preset));
                speechPlaylists = {};
                saveToLocal();
                renderSpeechSettings();
            }
        }

        // --- RENDER SPEECH SETTINGS ---
        function renderSpeechSettings() {
            const container = document.getElementById('speech-settings-panel');
            container.innerHTML = "";

            uiConfig.forEach(item => {
                if(item.header) {
                    const h = document.createElement('div');
                    h.className = "category-header";
                    h.innerText = item.header;
                    container.appendChild(h);
                } else {
                    const wrapper = document.createElement('div');
                    const row = document.createElement('div');
                    row.className = "switch-row";
                    const label = document.createElement('span');
                    label.className = "switch-label";
                    label.innerText = item.label;
                    const switchLabel = document.createElement('label');
                    switchLabel.className = "switch";
                    const cb = document.createElement('input');
                    cb.type = "checkbox";
                    cb.id = `sw_${item.id}`;
                    cb.checked = speechSettings[item.id] ? speechSettings[item.id].enabled : false;
                    cb.onchange = () => { if(speechSettings[item.id]) { speechSettings[item.id].enabled = cb.checked; saveToLocal(); } };
                    const slider = document.createElement('span');
                    slider.className = "slider";
                    switchLabel.appendChild(cb);
                    switchLabel.appendChild(slider);
                    row.appendChild(label);
                    row.appendChild(switchLabel);
                    wrapper.appendChild(row);

                    if(item.type === 'text') {
                        const input = document.createElement('input');
                        input.type = "text";
                        input.className = "text-input";
                        input.value = speechSettings[item.id] ? speechSettings[item.id].text : "";
                        input.placeholder = "Typ tekst om uit te spreken...";
                        input.oninput = () => { 
                            if(speechSettings[item.id]) { 
                                speechSettings[item.id].text = input.value; 
                                saveToLocal(); 
                            } 
                        };
                        wrapper.appendChild(input);
                    }
                    container.appendChild(wrapper);
                }
            });
        }

        function resetToDefaults() {
            if(!confirm("Weet je zeker dat je alle instellingen wilt resetten naar standaard?")) return;
            document.getElementById('rounds').value = 2; 
            document.getElementById('exercises').value = 6; 
            document.getElementById('sets').value = 2; 
            document.getElementById('restSec').value = 20; 
            document.getElementById('exerciseRestSec').value = 30; 
            document.getElementById('roundRestSec').value = 90;
            document.getElementById('totalMin').value = 30; 
            document.getElementById('start-round').value = 1;
            document.getElementById('start-ex').value = 1;
            document.getElementById('start-set').value = 1;
            const d = new Date(); d.setMinutes(d.getMinutes() + 30);
            document.getElementById('endTimeValue').value = d.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
            setMode('endtime'); setAudioMode('speech');
            
            document.getElementById('coach-preset').value = 'standard';
            speechSettings = JSON.parse(JSON.stringify(coachPresets.standard));
            speechPlaylists = {}; 

            saveToLocal(); renderSpeechSettings(); calculateRealTime();
        }

        function shareApp() {
            const cleanUrl = window.location.origin + window.location.pathname;
            let text = "ü¶Ö **Friday Night Hawks Timer**\n\n";
            text += "üèÜ **Uniek:** Jij bepaalt de EINDTIJD üèÅ. De app berekent automatisch de werk- en rusttijden zodat je precies op tijd klaar bent!\n\n";
            text += "De ultieme trainingspartner voor de vrijdagavond! üö¥üèãÔ∏èüèä\n";
            text += "Sluit af met bitterballen & gezelligheid! üçñ\n\n";
            text += "‚úÖ **Wat kan deze app?**\n";
            text += "- üó£Ô∏è Volledige spraakbegeleiding (NL)\n";
            text += "- ‚è±Ô∏è Slimme tijd- & rustberekening\n";
            text += "- üîÑ 'Crash Recovery': Hervat direct na uitval\n";
            text += "- üé® Volledig aanpasbare commando's\n\n";
            text += "üëá Download/Gebruik de app hier (gratis):";
            if (navigator.share) { navigator.share({ title: "Friday Night Hawks Timer ü¶Ö", text: text, url: cleanUrl }).catch(console.error); } 
            else { navigator.clipboard.writeText(text + "\n" + cleanUrl).then(() => alert("Promotietekst en link gekopieerd!")); }
        }

        function shareSettings() {
            const rounds = document.getElementById('rounds').value;
            const exercises = document.getElementById('exercises').value;
            const sets = document.getElementById('sets').value;
            const restSec = document.getElementById('restSec').value;
            const exerciseRestSec = document.getElementById('exerciseRestSec').value;
            const roundRestSec = document.getElementById('roundRestSec').value;
            const totalMin = document.getElementById('totalMin').value;
            const params = new URLSearchParams();
            params.set('r', rounds); params.set('e', exercises); params.set('s', sets);
            params.set('rs', restSec); params.set('re', exerciseRestSec); params.set('rr', roundRestSec); params.set('tm', totalMin);
            
            // Add custom speech settings to url
            for (const [key, value] of Object.entries(speechSettings)) {
                if(value.text) { params.set(key, value.text); }
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = baseUrl + '?' + params.toString();
            if (navigator.share) { navigator.share({ title: 'FNH Training Settings', url: shareUrl }).catch(console.error); } 
            else { navigator.clipboard.writeText(shareUrl).then(() => { alert("Link met instellingen gekopieerd!"); }); }
        }

        function checkForSharedSettings() {
            const params = new URLSearchParams(window.location.search);
            if(params.has('r')) {
                document.getElementById('rounds').value = params.get('r');
                document.getElementById('exercises').value = params.get('e');
                document.getElementById('sets').value = params.get('s');
                document.getElementById('restSec').value = params.get('rs');
                document.getElementById('exerciseRestSec').value = params.get('re');
                document.getElementById('roundRestSec').value = params.get('rr');
                document.getElementById('totalMin').value = params.get('tm');
                
                // Custom speech logic
                let speechUpdated = false;
                for (const key in speechSettings) {
                    if (params.has(key)) {
                        speechSettings[key].text = params.get(key);
                        speechUpdated = true;
                    }
                }
                if(speechUpdated) {
                    // Set dropdown to custom
                    const dropdown = document.getElementById('coach-preset');
                    if(dropdown) {
                        dropdown.value = 'custom';
                        dropdown.querySelector('option[value="custom"]').removeAttribute('hidden');
                        dropdown.querySelector('option[value="custom"]').removeAttribute('disabled');
                    }
                }

                saveToLocal();
            }
        }

        function saveToLocal() {
            const data = {
                rounds: document.getElementById('rounds').value, exercises: document.getElementById('exercises').value,
                sets: document.getElementById('sets').value, restSec: document.getElementById('restSec').value,
                exerciseRestSec: document.getElementById('exerciseRestSec').value, roundRestSec: document.getElementById('roundRestSec').value,
                totalMin: document.getElementById('totalMin').value, mode: mode, audioMode: audioMode, speechSettings: speechSettings, 
                startRound: document.getElementById('start-round').value, startEx: document.getElementById('start-ex').value, startSet: document.getElementById('start-set').value
            };
            localStorage.setItem('fnh_settings_v7', JSON.stringify(data));
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('fnh_settings_v7');
            if(saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('rounds').value = data.rounds || 2;
                    document.getElementById('exercises').value = data.exercises || 6;
                    document.getElementById('sets').value = data.sets || 2;
                    document.getElementById('restSec').value = data.restSec || 20;
                    document.getElementById('exerciseRestSec').value = data.exerciseRestSec || 30;
                    document.getElementById('roundRestSec').value = data.roundRestSec || 90;
                    document.getElementById('totalMin').value = data.totalMin || 30;
                    if(data.startRound) document.getElementById('start-round').value = data.startRound;
                    if(data.startEx) document.getElementById('start-ex').value = data.startEx;
                    if(data.startSet) document.getElementById('start-set').value = data.startSet;
                    if(data.mode) setMode(data.mode);
                    if(data.audioMode) setAudioMode(data.audioMode);
                    if(data.speechSettings) { for (const key in speechSettings) { if (data.speechSettings[key]) speechSettings[key] = data.speechSettings[key]; } }
                } catch(e) { console.log("Error loading settings", e); }
            }
        }
        
        function setAudioMode(newMode) {
            audioMode = newMode;
            document.getElementById('btn-audio-speech').className = (audioMode==='speech') ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('btn-audio-beep').className = (audioMode==='beep') ? 'toggle-btn active' : 'toggle-btn';
            const panel = document.getElementById('speech-settings-panel');
            if(audioMode === 'speech') panel.classList.remove('hidden'); else panel.classList.add('hidden');
        }

        function adjustValue(id, delta) {
            const el = document.getElementById(id); let val = parseInt(el.value) || 0; val += delta; if (val < 1) val = 1; 
            if(id === 'start-round') { const max = parseInt(document.getElementById('rounds').value); if(val > max) val = max; }
            if(id === 'start-ex') { const max = parseInt(document.getElementById('exercises').value); if(val > max) val = max; }
            if(id === 'start-set') { const max = parseInt(document.getElementById('sets').value); if(val > max) val = max; }
            el.value = val; validateResumeInputs(); calculateRealTime(); saveToLocal();
        }

        function validateResumeInputs() {
            const maxR = parseInt(document.getElementById('rounds').value) || 1;
            const maxE = parseInt(document.getElementById('exercises').value) || 1;
            const maxS = parseInt(document.getElementById('sets').value) || 1;
            const rEl = document.getElementById('start-round'); const eEl = document.getElementById('start-ex'); const sEl = document.getElementById('start-set');
            if(parseInt(rEl.value) > maxR) rEl.value = maxR; if(parseInt(eEl.value) > maxE) eEl.value = maxE; if(parseInt(sEl.value) > maxS) sEl.value = maxS;
        }

        function setMode(newMode) {
            mode = newMode;
            document.getElementById('btn-mode-duration').className = mode==='duration'?'toggle-btn active':'toggle-btn';
            document.getElementById('btn-mode-endtime').className = mode==='endtime'?'toggle-btn active':'toggle-btn';
            if (mode==='duration') { document.getElementById('input-duration').classList.remove('hidden'); document.getElementById('input-endtime').classList.add('hidden'); } 
            else { document.getElementById('input-duration').classList.add('hidden'); document.getElementById('input-endtime').classList.remove('hidden'); }
            calculateRealTime();
        }

        function calculateRealTime() {
            const rounds = parseInt(document.getElementById('rounds').value) || 1;
            const ex = parseInt(document.getElementById('exercises').value) || 0;
            const sts = parseInt(document.getElementById('sets').value) || 0;
            const rst = parseInt(document.getElementById('restSec').value) || 0;
            const exRst = parseInt(document.getElementById('exerciseRestSec').value) || 0;
            const roundRst = parseInt(document.getElementById('roundRestSec').value) || 0;
            const startRound = parseInt(document.getElementById('start-round').value) || 1;
            const startEx = parseInt(document.getElementById('start-ex').value) || 1;
            const startSet = parseInt(document.getElementById('start-set').value) || 1;

            if (ex === 0 || sts === 0 || rounds === 0) return;

            let remainingWorkSets = 0; let remainingFixedRestTime = 0;
            for (let r = 1; r <= rounds; r++) {
                for (let e = 1; e <= ex; e++) {
                    for (let s = 1; s <= sts; s++) {
                        let isFuture = false;
                        if (r > startRound) isFuture = true; else if (r === startRound && e > startEx) isFuture = true; else if (r === startRound && e === startEx && s >= startSet) isFuture = true;
                        if (isFuture) {
                            remainingWorkSets++;
                            const isLastSetOfWorkout = (r===rounds && e===ex && s===sts); const isLastSetOfRound = (e===ex && s===sts); const isLastSetOfExercise = (s===sts);
                            if (!isLastSetOfWorkout) {
                                if (isLastSetOfRound) remainingFixedRestTime += roundRst; else if (isLastSetOfExercise) remainingFixedRestTime += exRst; else remainingFixedRestTime += rst;
                            }
                        }
                    }
                }
            }
            remainingFixedRestTime += 10; 

            let availableSec = 0;
            if (mode === 'duration') { availableSec = (parseInt(document.getElementById('totalMin').value) || 0) * 60; } 
            else {
                const endStr = document.getElementById('endTimeValue').value; if (!endStr) return;
                const now = new Date(); const [h, m] = endStr.split(':'); const target = new Date(); target.setHours(h, m, 0, 0);
                if (target < now) target.setDate(target.getDate() + 1);
                availableSec = Math.floor((target - now) / 1000);
            }

            const workSecTotal = availableSec - remainingFixedRestTime;
            const btnEl = document.getElementById('btn-start-app'); const errEl = document.getElementById('live-calc-error'); const resEl = document.getElementById('live-calc-result');

            if (workSecTotal <= 0 || remainingWorkSets <= 0) {
                resEl.innerText = "--"; errEl.style.display = "block"; btnEl.style.opacity = 0.5; btnEl.disabled = true; workTimeSec = 0;
                document.getElementById('preview-list').innerHTML = "<div style='padding:10px; color:#555;'>Geen schema mogelijk</div>";
            } else {
                workTimeSec = Math.floor(workSecTotal / remainingWorkSets);
                resEl.innerText = workTimeSec + "s"; errEl.style.display = "none"; btnEl.style.opacity = 1; btnEl.disabled = false;
                restTimeSec = rst; exerciseRestSec = exRst; roundRestSec = roundRst;
                generateScheduleData(true); renderPreviewList();
            }
        }

        function generateScheduleData(applyResumeFilter) {
            const rounds = parseInt(document.getElementById('rounds').value); const ex = parseInt(document.getElementById('exercises').value); const sts = parseInt(document.getElementById('sets').value);
            const startRound = parseInt(document.getElementById('start-round').value); const startEx = parseInt(document.getElementById('start-ex').value); const startSet = parseInt(document.getElementById('start-set').value);
            totalWorkSetsGlobal = rounds * ex * sts; let currentSetGlobal = 0;
            schedule = []; schedule.push({ type: 'prep', time: 10, label: "Voorbereiden", initialTime: 10 });

            for (let r = 1; r <= rounds; r++) {
                for (let e = 1; e <= ex; e++) {
                    for (let s = 1; s <= sts; s++) {
                        currentSetGlobal++;
                        let include = true;
                        if (applyResumeFilter) { if (r < startRound) include = false; else if (r === startRound && e < startEx) include = false; else if (r === startRound && e === startEx && s < startSet) include = false; }
                        if(include) {
                            schedule.push({ type: 'work', time: workTimeSec, initialTime: workTimeSec, label: `Ronde ${r} | Oef ${e} (Set ${s})`, info: { round: r, exercise: e, set: s, globalSet: currentSetGlobal } });
                            const isLastSetOfWorkout = (r===rounds && e===ex && s===sts); const isLastSetOfRound = (e===ex && s===sts); const isLastSetOfExercise = (s===sts);
                            if (!isLastSetOfWorkout) {
                                if (isLastSetOfRound) schedule.push({ type: 'rest-long', time: roundRestSec, initialTime: roundRestSec, label: "GROTE PAUZE" });
                                else if (isLastSetOfExercise) schedule.push({ type: 'rest-exercise', time: exerciseRestSec, initialTime: exerciseRestSec, label: "WISSEL OEFENING" });
                                else schedule.push({ type: 'rest', time: restTimeSec, initialTime: restTimeSec, label: "Rust" });
                            }
                        }
                    }
                }
            }
            if(schedule.length > 1) schedule.push({ type: 'finish', time: 0, label: "KLAAR!", initialTime: 0 }); else schedule = [];
        }

        function renderPreviewList() {
            const list = document.getElementById('preview-list'); list.innerHTML = ""; let runningDate = new Date();
            schedule.forEach((item) => {
                if (item.type==='finish') return;
                let timeStr = runningDate.toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
                runningDate.setSeconds(runningDate.getSeconds() + item.time);
                const div = document.createElement('div'); div.className = `schedule-item`;
                let icon = ""; if(item.type==='rest-long') { div.style.borderLeft = "4px solid #0A84FF"; icon='‚òï'; } else if(item.type==='rest-exercise') { div.style.borderLeft = "4px solid #BF5AF2"; icon='üîÄ'; } else if(item.type==='work') icon='üî•'; else if(item.type==='rest') icon='üí§'; else icon='üöÄ';
                div.innerHTML = `<div class="col-time">${timeStr}</div><div class="col-desc">${icon} ${item.label}</div><div class="col-dur">${item.time}s</div>`;
                list.appendChild(div);
            });
        }

        function renderActiveList() {
            const list = document.getElementById('schedule-list-active'); list.innerHTML = ""; let runningDate = new Date();
            schedule.forEach((item, idx) => {
                if (item.type==='finish') return;
                let timeStr = "";
                if (idx >= currentIndex) { timeStr = runningDate.toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit', second:'2-digit'}); runningDate.setSeconds(runningDate.getSeconds() + item.time); } else { timeStr = "klaar"; }
                const div = document.createElement('div'); div.className = `schedule-item ${idx===currentIndex?'active':''}`; div.id = `step-${idx}`;
                if(item.type==='rest-long') div.style.borderLeft = "4px solid #0A84FF"; else if(item.type==='rest-exercise') div.style.borderLeft = "4px solid #BF5AF2";
                let icon = ""; if(item.type==='work') icon='üî•'; else if(item.type==='rest') icon='üí§'; else if(item.type==='rest-exercise') icon='üîÄ'; else if(item.type==='rest-long') icon='‚òï'; else icon='üöÄ';
                div.innerHTML = `<div class="col-time">${timeStr}</div><div class="col-desc" style="${item.type==='work'?'color:white':''}">${icon} ${item.label}</div><div class="col-dur">${item.time}s</div>`;
                list.appendChild(div);
            });
        }

        function triggerAudio(key, fallbackText, extraInfo = "") {
            if (audioMode === 'beep') { if (key.includes('work')) playBeep(800, 'start'); else if (key.includes('rest')) playBeep(400, 'end'); else if (key === 'tick') playBeep(600, 'tick'); else if (key === 'finish') playBeep(1000, 'win'); return; } 
            if (!window.speechSynthesis) return;
            if(key === 'manual_override') { const utterance = new SpeechSynthesisUtterance(fallbackText); utterance.lang = 'nl-NL'; window.speechSynthesis.speak(utterance); return; }
            
            let setting = speechSettings[key]; if (!setting && key === 'tick') setting = speechSettings.prep_countdown; 
            if (!setting || !setting.enabled) return;

            let textToSpeak = fallbackText;
            
            if (setting.text && setting.text.trim() !== "") {
                const rawText = setting.text;
                
                if (!speechPlaylists[key] || speechPlaylists[key].originalText !== rawText) {
                    let phrases = rawText.split('|').map(s => s.trim()).filter(s => s !== "");
                    for (let i = phrases.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [phrases[i], phrases[j]] = [phrases[j], phrases[i]];
                    }
                    speechPlaylists[key] = {
                        phrases: phrases,
                        index: 0,
                        originalText: rawText
                    };
                }

                let pl = speechPlaylists[key];
                if (pl.phrases.length > 0) {
                    textToSpeak = pl.phrases[pl.index];
                    pl.index++;
                    if (pl.index >= pl.phrases.length) {
                        pl.index = 0; 
                    }
                }
            }

            if (extraInfo) textToSpeak += ". " + extraInfo;

            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'nl-NL';
            window.speechSynthesis.speak(utterance);
        }

        function playBeep(f,t){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g);g.connect(audioCtx.destination); o.frequency.value=f;o.type='sine'; const n=audioCtx.currentTime; if(t==='tick'){g.gain.setValueAtTime(0.1,n);o.start(n);o.stop(n+0.1);} else if(t==='win'){g.gain.setValueAtTime(0.1,n);o.start(n);o.stop(n+0.2);setTimeout(()=>playBeep(1200,'tick'),300);} else{g.gain.setValueAtTime(0.3,n);o.start(n);o.stop(n+0.5);} }

        function startWorkout() {
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(console.log);
            if(audioMode === 'beep') { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); } else { if(window.speechSynthesis) window.speechSynthesis.cancel(); }

            generateScheduleData(true);
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('timer-screen').style.display = 'flex';

            workoutStartTime = new Date();
            if (mode === 'endtime') {
                const [h, m] = document.getElementById('endTimeValue').value.split(':');
                targetEndTimeDate = new Date(); targetEndTimeDate.setHours(h, m, 0, 0);
                if (targetEndTimeDate < workoutStartTime) targetEndTimeDate.setDate(targetEndTimeDate.getDate() + 1);
            } else {
                let totalDur = 0; schedule.forEach(s => totalDur += s.time);
                targetEndTimeDate = new Date(workoutStartTime.getTime() + totalDur * 1000);
            }

            updateEndTimeDisplay();
            renderActiveList();
            currentIndex = 0;
            
            speechPlaylists = {}; 

            stepEndTime = Date.now() + (schedule[0].time * 1000);
            runStep();
        }

        function runStep() {
            if (currentIndex >= schedule.length) return;
            const step = schedule[currentIndex];
            const nextStep = schedule[currentIndex + 1];
            const totalRounds = parseInt(document.getElementById('rounds').value);
            const totalEx = document.getElementById('exercises').value;

            document.querySelectorAll('.schedule-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById(`step-${currentIndex}`);
            if (activeItem) { activeItem.classList.add('active'); activeItem.scrollIntoView({behavior:'smooth', block:'center'}); }

            const statusEl = document.getElementById('current-status');

            if (step.type==='work') { 
                statusEl.innerText="WERKEN"; statusEl.style.color="#30D158"; 
                if(step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.25)) triggerAudio('mile_start', "Goede start");
                else if(step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.5)) triggerAudio('mile_half', "Helft");
                else if(step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.75)) triggerAudio('mile_end', "Eindsprint");
                else if(step.info.round === totalRounds && step.info.set === 1 && step.info.exercise === 1) triggerAudio('mile_lastround', "Laatste ronde");
                else triggerAudio('work_start', "Start");
            }
            else if (step.type==='rest') { 
                statusEl.innerText="RUST"; statusEl.style.color="#FF9F0A"; 
                let info = "";
                if (speechSettings.rest_set_tips.enabled) { const tips = ["Adem in, adem uit", "Schud je spieren los", "Slokje water", "Blijf gefocust"]; info = tips[Math.floor(Math.random()*tips.length)]; }
                triggerAudio('rest_set_start', "Rust", info);
            }
            else if (step.type==='rest-exercise') {
                statusEl.innerText="WISSEL OEFENING"; statusEl.style.color="#BF5AF2";
                let info = "";
                if (speechSettings.rest_switch_info.enabled && nextStep && nextStep.info) { info = `Hierna oefening ${nextStep.info.exercise} van de ${totalEx}`; }
                triggerAudio('rest_switch_start', "Wissel", info);
            }
            else if (step.type==='rest-long') { 
                statusEl.innerText="RONDE PAUZE"; statusEl.style.color="#0A84FF"; 
                let info = "";
                if (speechSettings.rest_round_info.enabled && nextStep && nextStep.info) { info = `Hierna ronde ${nextStep.info.round} van de ${totalRounds}`; }
                triggerAudio('rest_round_start', "Grote pauze", info);
            }
            else if (step.type==='prep') { statusEl.innerText="STARTEN"; statusEl.style.color="#0A84FF"; triggerAudio('prep_intro', "Welkom"); }
            else { finish(); return; }

            stepEndTime = Date.now() + (step.time * 1000); 
            document.getElementById('countdown').innerText = step.time;

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    const now = Date.now();
                    const remainingMs = stepEndTime - now;
                    let remainingSec = Math.ceil(remainingMs / 1000);
                    
                    if (remainingSec < 0) {
                        while (remainingSec < 0) {
                            currentIndex++;
                            if(currentIndex >= schedule.length) { finish(); return; }
                            const skippedStep = schedule[currentIndex];
                            stepEndTime += (skippedStep.time * 1000); 
                            remainingSec = Math.ceil((stepEndTime - Date.now()) / 1000);
                        }
                        runStep(); return;
                    }

                    step.time = remainingSec;
                    document.getElementById('countdown').innerText = step.time;
                    updateProgressBar();
                    
                    const totalDiff = targetEndTimeDate - now;
                    if(totalDiff > 0) {
                        const h = Math.floor(totalDiff / 3600000);
                        const m = Math.floor((totalDiff % 3600000) / 60000);
                        const s = Math.floor((totalDiff % 60000) / 1000);
                        document.getElementById('total-time-left').innerText = `Nog ${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    } else { document.getElementById('total-time-left').innerText = "0:00:00"; }

                    const init = step.initialTime;
                    if (step.type === 'work') {
                        if (step.time === Math.floor(init / 2) && init >= 30) triggerAudio('work_halfway', "Halverwege");
                        if (step.time === 30 && init > 40) triggerAudio('work_30s', "30 seconden");
                        if (step.time === 10 && init > 15) triggerAudio('work_10s', "10 seconden");
                        if (step.time === 5 && init > 10) triggerAudio('work_5s', "5 seconden");
                    }
                    if (step.type === 'rest-long' && step.time === 15 && init > 20) triggerAudio('rest_round_15s', "Nog 15 seconden, ga naar je oefening");
                    if (step.type === 'rest-exercise' && step.time === 10 && init > 15) triggerAudio('rest_switch_10s', "Nog 10 seconden");

                    if (step.time <= 0) { clearInterval(timerInterval); currentIndex++; runStep(); } 
                    else if (step.time <= 3) { triggerAudio('tick', step.time.toString()); }
                } else {
                    stepEndTime += 1000; 
                    targetEndTimeDate = new Date(targetEndTimeDate.getTime() + 1000); 
                    updateEndTimeDisplay();
                }
            }, 1000);
        }

        function skipStep(dir) {
            let newIndex = currentIndex + dir;
            if (newIndex < 0) newIndex = 0;
            if (newIndex >= schedule.length - 1) newIndex = schedule.length - 1;
            currentIndex = newIndex;
            renderActiveList(); 
            runStep(); 
        }

        function handlePauseClick() {
            const btn = document.getElementById('btn-pause');
            if (!isPaused) {
                isPaused = true;
                btn.innerText = "HERVAT"; btn.style.backgroundColor = "#30D158";
                document.getElementById('current-status').innerText = "GEPAUZEERD";
                document.getElementById('current-status').style.color = "white";
                triggerAudio('manual_override', "Gepauzeerd");
            } else {
                if (mode === 'endtime') document.getElementById('pause-modal').style.display = 'flex';
                else resolvePause('push');
            }
        }

        function resolvePause(choice) {
            document.getElementById('pause-modal').style.display = 'none';
            document.getElementById('btn-pause').innerText = "PAUZE";
            document.getElementById('btn-pause').style.backgroundColor = "#FF9F0A";
            isPaused = false;
            triggerAudio('manual_override', "We gaan weer door");
            if (choice === 'recalc') recalculateForFixedEnd();
            renderActiveList();
        }

        function recalculateForFixedEnd() {
            const now = new Date();
            const secsRemaining = Math.floor((targetEndTimeDate - now) / 1000);
            if (secsRemaining <= 0) { alert("Tijd is op!"); finish(); return; }

            let workStepsLeft = 0; let fixedRest = 0;
            for(let i=currentIndex; i<schedule.length; i++){
                if (schedule[i].type==='finish') continue;
                if (schedule[i].type.includes('rest')) fixedRest += schedule[i].time;
                else if (schedule[i].type==='work' || schedule[i].type==='prep') workStepsLeft++;
            }

            if (workStepsLeft > 0) {
                const availableForWork = secsRemaining - fixedRest;
                let newWork = Math.floor(availableForWork / workStepsLeft);
                if (newWork < 5) newWork = 5; 
                for(let i=currentIndex; i<schedule.length; i++){
                    if (schedule[i].type==='work') {
                         schedule[i].time = newWork;
                         schedule[i].initialTime = newWork; 
                    }
                }
                stepEndTime = Date.now() + (schedule[currentIndex].time * 1000);
                document.getElementById('countdown').innerText = schedule[currentIndex].time;
            }
        }

        function updateTargetTimeFromNow() {}

        function updateEndTimeDisplay() { document.getElementById('display-end-time').innerText = targetEndTimeDate.toLocaleTimeString('nl-NL',{hour:'2-digit',minute:'2-digit'}); }
        
        function updateProgressBar() {
            const now = new Date();
            const totalMs = targetEndTimeDate - workoutStartTime; 
            if (totalMs <= 0) return;
            const elapsed = now - workoutStartTime;
            let pct = (elapsed / totalMs) * 100; if (pct>100) pct=100;
            document.getElementById('total-progress').style.width = pct + "%";
            document.getElementById('progress-text').innerText = Math.floor(pct) + "%";
        }
        
        function finish() {
            document.getElementById('current-status').innerText = "KLAAR!";
            document.getElementById('current-status').style.color = "white";
            document.getElementById('countdown').innerText = "üéâ";
            document.getElementById('btn-pause').style.display='none';
            document.getElementById('total-time-left').innerText = "0:00:00";
            clearInterval(timerInterval);
            triggerAudio('finish', "Training klaar");
        }
        
        function resetApp() { clearInterval(timerInterval); location.reload(); }
    </script>
</body>
</html>
