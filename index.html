<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Friday-night-hawk-s Timer v1.29.03</title>
    <script src="workout_data.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // FIX: Ensure jsPDF is available globally for autotable
        window.jsPDF = window.jspdf.jsPDF;
    </script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --app-height: 100dvh;

            /* Modern Sporty Palette */
            --bg-main: #000000;
            --bg-card: #1C1C1E;
            --bg-glass: rgba(28, 28, 30, 0.85);

            --accent-primary: #30D158;
            /* Neon Green */
            --accent-secondary: #0A84FF;
            /* Electric Blue */
            --accent-danger: #FF453A;
            --accent-warm: #FF9F0A;

            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;

            --radius-card: 20px;
            --radius-btn: 16px;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: var(--font-main);
            text-align: center;
            margin: 0;
            padding: 0;
            height: var(--app-height);
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overscroll-behavior: none;
            transition: background-color 0.3s ease;
        }

        .container {
            padding: calc(10px + var(--safe-top)) 10px calc(10px + var(--safe-bottom)) 10px;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        /* --- INTRO BANNER --- */
        .intro-banner {
            background: linear-gradient(135deg, var(--bg-card) 0%, #2c2c2e 100%);
            border: 1px solid #333;
            border-radius: var(--radius-card);
            padding: 20px;
            margin-top: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .intro-title {
            font-size: 14px;
            font-weight: 900;
            color: var(--accent-primary);
            text-transform: uppercase;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .intro-text {
            font-size: 13px;
            color: #ccc;
            line-height: 1.4;
        }

        /* --- LOGO & HEADER --- */
        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }

        .app-logo {
            width: 120px;
            height: auto;
            border-radius: 50%;
            border: 2px solid #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #222;
        }

        .app-header {
            font-size: 18px;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: -0.5px;
            text-align: left;
        }

        .version-tag {
            font-size: 11px;
            color: #30D158;
            background: #1c1c1e;
            padding: 2px 5px;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 5px;
            font-weight: bold;
            border: 1px solid #333;
        }

        .header-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-header {
            border: none;
            border-radius: 20px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s;
        }

        .btn-header:active {
            opacity: 0.6;
        }

        .btn-save {
            background: #0A84FF;
            color: white;
        }

        .btn-reset {
            background: #333;
            color: #ccc;
            border: 1px solid #444;
        }

        .btn-share-app {
            background: #BF5AF2;
            color: white;
        }

        /* --- GRID SYSTEMS --- */
        .compact-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            width: 100%;
            margin-bottom: 10px;
        }

        .bonus-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr;
            gap: 5px;
            width: 100%;
            margin-bottom: 8px;
            align-items: end;
        }

        .half-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            margin-bottom: 15px;
        }

        .select-group {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 600;
        }

        /* --- CARDS & INPUTS --- */
        .card-group {
            background: var(--bg-card);
            border-radius: var(--radius-card);
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        select.compact-select,
        input[type="time"],
        input[type="text"],
        .text-input-trigger,
        select.text-input {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid transparent;
            background: #2C2C2E;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
            appearance: none;
            -webkit-appearance: none;
            text-align: center;
        }

        select.compact-select:focus,
        input:focus {
            background: #3A3A3C;
            border-color: var(--accent-primary);
            outline: none;
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* --- TOGGLES (Segmented Control) --- */
        .toggle-container {
            display: flex;
            background: #2C2C2E;
            border-radius: 99px;
            /* Pill shape */
            padding: 4px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            border-radius: 99px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-btn.active {
            background: #636366;
            /* Lighter grey for active state in dark mode */
            background: var(--text-primary);
            color: #000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* --- SECTIONS (Cards) --- */
        .speech-options,
        .resume-options,
        .extra-options {
            background: var(--bg-card);
            border-radius: var(--radius-card);
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: left;
        }

        .resume-options,
        .extra-options {
            border-color: rgba(255, 255, 255, 0.05);
            margin-top: 15px;
            margin-bottom: 20px;
        }

        .category-header {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: 900;
            color: #30D158;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .category-header:first-child {
            margin-top: 0;
        }

        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }

        .switch-label {
            font-size: 14px;
            color: #fff;
            flex: 1;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #30D158;
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        /* Custom Text Input (Read only trigger) */
        .text-input-trigger {
            width: 100%;
            background: #2a2a2c;
            border: 1px solid #444;
            color: #ccc;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            margin-top: 5px;
            white-space: pre-wrap;
            overflow: visible;
            min-height: 80px;
            line-height: 1.4;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .text-input-trigger:active {
            background: #3a3a3c;
        }

        /* Custom Text Input (Real select for coach) */
        select.text-input {
            width: 100%;
            background: #2a2a2c;
            border: 1px solid #444;
            color: #ccc;
            padding: 8px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 10px;
            margin-top: 2px;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }

        /* --- COLLAPSIBLE (Resume only) --- */
        .collapsible-header {
            background: #2c2c2e;
            padding: 10px;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            background: #3a3a3c;
        }

        .collapsible-content {
            padding: 10px;
            background: #151516;
            border-radius: 6px;
            margin-top: 5px;
        }

        .collapsible-content.hidden {
            display: none;
        }

        .arrow {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .open .arrow {
            transform: rotate(180deg);
        }


        /* --- BUTTONS --- */
        button.action-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-weight: 800;
            border: none;
            border-radius: var(--radius-btn);
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 25px;
            flex-shrink: 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(48, 209, 88, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button.action-btn:active {
            transform: scale(0.98);
        }

        .btn-start {
            background: var(--accent-primary);
            color: #000;
        }

        .btn-view-schedule {
            background-color: #0A84FF;
            color: white;
            margin-bottom: 10px;
        }



        /* Updated Control Buttons */
        /* Updated Control Buttons */
        .controls-container {
            background: rgba(28, 28, 30, 0.6) !important;
            /* Glass effect */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 25px !important;
            margin-bottom: 0 !important;
            gap: 20px !important;
        }

        .btn-control {
            flex: 1;
            height: 80px;
            border: none;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            border-radius: 24px;
            /* More rounded */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .btn-control:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        .btn-control.paused {
            background: rgba(255, 159, 10, 0.2);
            color: var(--accent-warm);
            border: 1px solid var(--accent-warm);
        }

        .btn-stop {
            color: var(--accent-danger);
            background: rgba(255, 69, 58, 0.15);
        }

        .btn-skip {
            font-size: 24px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 60px;
            /* Fixed width for small buttons */
            flex: 0 0 60px;
        }

        /* LIVE SCHEDULE TABLE */
        /* LIVE SCHEDULE TABLE (Timeline Style) */
        #live-schedule-container {
            width: 100%;
            background: var(--bg-main);
            /* Match body */
            margin-top: 0;
            padding: 20px 0 80px 0;
            border-top: none;
        }

        .live-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            /* Gap between rows */
            padding: 0 15px;
        }

        .live-table th {
            text-transform: uppercase;
            font-size: 10px;
            color: var(--text-secondary);
            letter-spacing: 1px;
            padding-bottom: 10px;
            background: var(--bg-main);
        }

        .live-table td {
            padding: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: none;
        }

        .live-table tr td:first-child {
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
        }

        .live-table tr td:last-child {
            border-top-right-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        .live-table tr.active-row td {
            background: #2C2C2E;
            color: #fff;
            box-shadow: 0 0 0 2px var(--accent-primary);
            /* Ring border */
        }

        .live-table tr.active-row td {
            border: none !important;
        }

        .live-table tr.active-row td:first-child {
            border-left: none;
        }

        /* Remove old border */

        .live-table tr.future-row td {
            opacity: 0.5;
            background: #111;
        }

        .live-table tr.past-row td {
            opacity: 0.2;
        }

        /* Audio Debug Log */
        #audio-debug-log {
            display: none;
            /* Hidden via user request */
            position: fixed;
            bottom: 15px;
            right: 15px;
            width: 320px;
            height: 150px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #444;
            border-radius: 8px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 8px;
            overflow-y: auto;
            z-index: 10000;
            pointer-events: none;
            /* display: flex; */
            flex-direction: column-reverse;
            /* Newest items at bottom */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        #audio-debug-log div {
            border-bottom: 1px solid #222;
            padding: 2px 0;
            white-space: pre-wrap;
        }

        /* Audio Debug Log */



        .live-table tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .live-table tr:active {
            background: #333;
        }


        /* High Z-Index for Modals */
        .modal-overlay,
        #schedule-modal,
        #exercise-selector-modal {
            z-index: 9999 !important;
            position: fixed;
            /* Ensure fixed positioning */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            /* Proper backdrop */
        }

        /* --- INFO BOX --- */
        .info-bar {
            background: #111;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #333;
            flex-shrink: 0;
            margin-top: 5px;
            position: relative;
        }

        .btn-force-edit {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #333;
            border: 1px solid #555;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
        }

        .exercise-click-target {
            padding: 8px 10px;
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
            background: #222;
            color: #fff;
            min-height: 44px;
            /* Touch friendly */
            display: flex;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
            transition: background 0.1s;
        }

        .exercise-click-target:active {
            background: #444;
            transform: scale(0.98);
        }

        /* --- LISTS --- */
        .schedule-list-wrapper {
            flex: 1;
            text-align: left;
            background: #000;
            border-top: 1px solid #222;
            overflow-y: auto;
            min-height: 100px;
        }

        .schedule-item {
            padding: 10px;
            border-bottom: 1px solid #1a1a1a;
            color: #555;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .schedule-item.active {
            color: #fff;
            background: #1c1c1e;
            border-left: 4px solid #30D158;
        }

        .col-time {
            width: 60px;
            font-family: monospace;
            color: #888;
            font-size: 12px;
            flex-shrink: 0;
        }

        .col-desc {
            flex: 1;
            padding: 0 8px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .col-dur {
            width: 40px;
            text-align: right;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* --- TIMER SCREEN (GYM MODE) --- */
        #timer-screen {
            display: none;
            /* Scroll Fix v1.14: Restore full height container for scrolling */
            height: 100%;
            width: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            flex-direction: column;
            padding-bottom: 20px;
        }

        /* PROGRESS RINGS */
        .timer-ring-container {
            position: relative;
            width: 80vw;
            max-width: 350px;
            aspect-ratio: 1;
            margin: 0 auto 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            /* Start at top */
            pointer-events: none;
        }

        /* --- EXERCISE SELECTOR MODAL --- */
        #exercise-selector-modal .modal-content {
            max-width: 500px;
            width: 95vw;
            height: 80vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            background: #1c1c1e;
            border: 1px solid #333;
        }

        .ex-modal-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ex-modal-body {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .ex-search-container {
            padding: 10px;
            background: #111;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #ex-search-input {
            width: 100%;
            padding: 12px;
            background: #2c2c2e;
            border: none;
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
        }

        .ex-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ex-list-item {
            padding: 15px;
            border-bottom: 1px solid #2c2c2e;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ex-list-item:hover {
            background: #2c2c2e;
        }

        .ex-cat-tag {
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 4px;
            background: #333;
            color: #aaa;
            margin-right: 10px;
        }

        .ex-detail-view {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
        }

        .ex-detail-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #30D158;
        }

        .ex-detail-meta {
            font-size: 13px;
            color: #888;
            margin-bottom: 15px;
        }

        .ex-detail-desc {
            font-size: 14px;
            line-height: 1.5;
            color: #ccc;
            margin-bottom: 20px;
            background: #222;
            padding: 10px;
            border-radius: 8px;
        }

        .ex-video-btn {
            background: #FF3B30;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            text-decoration: none;
            margin-bottom: 20px;
        }

        .ex-scope-section {
            margin-top: auto;
            border-top: 1px solid #333;
            padding-top: 15px;
        }

        .ex-scope-title {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 10px;
            display: block;
        }

        .ex-scope-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .scope-radio {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #2c2c2e;
            border-radius: 8px;
            cursor: pointer;
        }

        .scope-radio input {
            margin-right: 10px;
            accent-color: #30D158;
            transform: scale(1.2);
        }

        .scope-label-main {
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .scope-label-sub {
            font-size: 11px;
            color: #888;
            display: block;
        }

        /* Ring Styles */
        .ring-bg-outer {
            fill: none;
            stroke: rgba(255, 255, 255, 0.05);
            stroke-width: 4;
        }

        .ring-val-outer {
            fill: none;
            stroke: var(--accent-secondary);
            stroke-width: 4;
            stroke-linecap: round;
            filter: drop-shadow(0 0 8px rgba(10, 132, 255, 0.5));
            /* Glow */
            transition: stroke-dashoffset 0.5s linear;
        }

        .ring-bg-inner {
            fill: none;
            stroke: rgba(255, 255, 255, 0.05);
            stroke-width: 8;
        }

        .ring-val-inner {
            fill: none;
            stroke: #BF5AF2;
            stroke-width: 8;
            stroke-linecap: round;
            filter: drop-shadow(0 0 10px rgba(191, 90, 242, 0.6));
            /* Glow */
            transition: stroke-dashoffset 0.2s linear;
        }

        /* Text inside ring */
        .gym-big-time {
            font-size: 28vw;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            line-height: 0.9;
            letter-spacing: -5px;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 2;
            pointer-events: none;
            margin: 0;
        }

        @media (min-width: 600px) {
            .gym-big-time {
                font-size: 140px;
            }
        }

        /* THE MAIN DISPLAY ZONE */
        .display-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 10px;
            position: relative;
        }

        .gym-phase-title {
            font-size: 8vw;
            /* Normal size for long text */
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 5px;
            opacity: 0.8;
            line-height: 1;
            position: relative;
            z-index: 1;
            pointer-events: none;
            transition: font-size 0.3s;
        }

        .gym-phase-title.huge-text {
            font-size: 16vw;
        }



        /* NEW STATS GRID STRUCTURE */
        .stats-wrapper {
            width: 95%;
            max-width: 600px;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            z-index: 50;
            pointer-events: none;
        }

        .stats-row-1 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .stats-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: auto;
            /* CRITICAL: Re-enable clicks on the boxes */
            position: relative;
        }

        /* --- EDITABLE STYLES --- */
        .stat-box.editable {
            border: 2px solid #30D158;
            position: relative;
            z-index: 60;
        }

        .stat-box.editable:active {
            transform: scale(0.98);
            background: rgba(48, 209, 88, 0.2);
        }

        .edit-icon {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            color: #30D158;
        }

        .stat-label {
            font-size: 2.5vw;
            text-transform: uppercase;
            opacity: 0.8;
            font-weight: bold;
            margin-bottom: 2px;
            color: #ddd;
        }

        .stat-value {
            font-size: 6vw;
            /* Bigger as requested */
            font-weight: 900;
            font-variant-numeric: tabular-nums;
        }

        /* Fallback for very small or very large screens */
        @media (min-width: 600px) {
            .stat-label {
                font-size: 14px;
            }

            .stat-value {
                font-size: 36px;
            }

            .gym-phase-title {
                font-size: 40px;
            }

            .gym-phase-title.huge-text {
                font-size: 80px;
            }

            /* .gym-big-time {
                font-size: 180px;
            } */
        }

        .gym-next-info {
            font-size: 3vw;
            opacity: 0.7;
            margin-top: 20px;
            position: relative;
            z-index: 1;
            pointer-events: none;
        }

        .controls-container {
            flex: 0 0 100px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 100;
            /* Highest priority */
            pointer-events: auto;
            gap: 15px;
            /* Spacing between big buttons */
        }

        /* --- PHASE COLORS (Backgrounds) --- */
        /* --- PRE-WORKOUT EPIC EFFECTS --- */
        @keyframes epic-pulse {
            0% {
                transform: scale(1);
                text-shadow: 0 0 20px rgba(48, 209, 88, 0.2);
            }

            50% {
                transform: scale(1.02);
                text-shadow: 0 0 40px rgba(48, 209, 88, 0.6), 0 0 10px rgba(48, 209, 88, 0.8);
            }

            100% {
                transform: scale(1);
                text-shadow: 0 0 20px rgba(48, 209, 88, 0.2);
            }
        }

        .epic-timer {
            animation: epic-pulse 2s infinite ease-in-out;
            font-variant-numeric: tabular-nums;
        }

        .epic-overlay {
            background: radial-gradient(circle at center, #222 0%, #000 100%) !important;
        }

        body.mode-work {
            background-color: #30D158;
            color: black;
        }

        body.mode-work .progress-fill {
            background: black;
        }

        body.mode-work .stat-box {
            background: rgba(0, 0, 0, 0.15);
            border-color: rgba(0, 0, 0, 0.2);
        }

        body.mode-work .stat-box.editable {
            border-color: #000;
        }

        body.mode-work .edit-icon {
            color: #000;
        }

        body.mode-work .stat-label {
            color: rgba(0, 0, 0, 0.6);
        }

        body.mode-rest {
            background-color: #FF9F0A;
            color: black;
        }

        body.mode-rest .progress-fill {
            background: black;
        }

        body.mode-rest .stat-box {
            background: rgba(0, 0, 0, 0.15);
            border-color: rgba(0, 0, 0, 0.2);
        }

        body.mode-rest .stat-box.editable {
            border-color: #000;
        }

        body.mode-rest .edit-icon {
            color: #000;
        }

        body.mode-rest .stat-label {
            color: rgba(0, 0, 0, 0.6);
        }

        body.mode-switch {
            background-color: #BF5AF2;
            color: white;
        }

        body.mode-long {
            background-color: #0A84FF;
            color: white;
        }

        body.mode-prep {
            background-color: #1c1c1e;
            color: white;
        }

        body.mode-finish {
            background-color: #FFD60A;
            color: black;
        }

        body.mode-pause {
            background-color: #333;
            color: white;
        }

        /* --- MODALS --- */
        /* --- MODALS --- */
        #pause-modal,
        #calc-modal,
        #speech-edit-modal,
        #schedule-modal,
        #edit-scope-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 25px;
            border-radius: var(--radius-card);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            color: var(--text-primary);
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* SPEECH MODAL FIX */
        #speech-edit-modal .modal-content {
            width: 98%;
            max-width: 98%;
            padding: 15px;
        }

        /* SCHEDULE MODAL STYLES */
        #schedule-modal .modal-content {
            max-width: 600px;
            width: 95%;
            text-align: left;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        .schedule-table-container {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #333;
            border-radius: 8px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .schedule-table th {
            background: #333;
            color: #fff;
            padding: 8px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .schedule-table td {
            padding: 8px;
            border-bottom: 1px solid #222;
            color: #ccc;
        }

        .schedule-table tr.row-work td {
            color: #fff;
            font-weight: bold;
        }

        .schedule-table tr.row-work input {
            background: #222;
            border: 1px solid #444;
            color: #30D158;
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }

        .schedule-table tr.row-bonus td {
            color: #BF5AF2;
            font-weight: bold;
        }

        .modal-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            text-align: left;
            position: relative;
        }

        .modal-btn .btn-subtext {
            display: block;
            font-size: 11px;
            font-weight: normal;
            opacity: 0.7;
            margin-top: 2px;
        }

        .calc-input {
            width: 80px;
            font-size: 24px;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            border: 1px solid #555;
            background: #222;
            color: white;
            margin-bottom: 15px;
        }

        .option-desc {
            font-size: 13px;
            color: #ccc;
            margin-top: 2px;
            font-weight: normal;
        }

        /* SPEECH EDIT TEXTAREA */
        #speech-edit-area {
            width: 100%;
            min-height: 350px;
            background: #222;
            border: 1px solid #555;
            color: white;
            font-size: 16px;
            padding: 15px;
            border-radius: 8px;
            resize: none;
            margin-bottom: 15px;
            font-family: inherit;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        /* SAFETY: Prevent Timer Screen leaks if markup is broken */
        #setup-screen #timer-screen,
        #setup-screen .controls-container,
        #setup-screen #pause-modal {
            display: none !important;
        }

        /* TRANSPARENT INPUT STYLES */
        .transparent-input {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            z-index: 20;
            cursor: pointer;
            border: none;
            padding: 0;
            margin: 0;
            appearance: none;
        }

        /* --- GENERATOR MODAL STYLES --- */
        #generator-modal .modal-content {
            max-width: 500px;
            width: 95%;
            padding: 0;
            display: flex;
            flex-direction: column;
            background: #1c1c1e;
            height: 85vh;
        }

        .gen-section {
            padding: 15px;
            border-bottom: 1px solid #333;
        }

        .gen-section-title {
            font-size: 13px;
            font-weight: 900;
            color: #BF5AF2;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .gen-checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .gen-checkbox-item {
            background: #2c2c2e;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #ccc;
            cursor: pointer;
            user-select: none;
        }

        .gen-checkbox-item input {
            margin-right: 8px;
            accent-color: #BF5AF2;
        }

        .gen-radio-group {
            display: flex;
            background: #2c2c2e;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 5px;
        }

        .gen-radio-opt {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            color: #888;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gen-radio-opt.active {
            background: #BF5AF2;
            color: white;
            font-weight: bold;
        }

        .gen-btn-generate {
            background: linear-gradient(135deg, #BF5AF2, #5E5CE6);
            color: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 12px;
            margin: 15px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(191, 90, 242, 0.4);
        }
    </style>
</head>

<body>

    <div id="setup-screen" class="container">

        <div class="logo-container">
            <img src="FNH logo.jpg" alt="FNH Logo" class="app-logo">
        </div>

        <div class="header-row">
            <div class="app-header">
                FNH Timer <span class="version-tag">v1.29.03</span>
            </div>
            <div class="header-buttons">
                <button class="btn-header btn-reset" onclick="resetToDefaults()">üîÑ Reset</button>
                <button class="btn-header btn-reset" style="background:#FF9F0A; color:white;"
                    onclick="applyTabataPreset()">‚è±Ô∏è Tabata</button>
                <button class="btn-header btn-save" onclick="shareSettings()">üíæ Save</button>
                <button class="btn-header btn-share-app" onclick="shareApp()">üì§ Delen</button>
            </div>
        </div>

        <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:5px;">TIJDSINSTELLINGEN</div>

        <div class="compact-row">
            <div class="select-group">
                <label>Starttijd</label>
                <input type="time" id="startTimeValue" class="highlight-input"
                    onchange="syncTime('starttime'); saveToLocal();">
            </div>
            <div class="select-group">
                <label>Duur (min)</label>
                <select id="totalMin" class="compact-select highlight-input"
                    onchange="syncTime('duration'); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Eindtijd</label>
                <input type="time" id="endTimeValue" class="highlight-input"
                    onchange="syncTime('endtime'); saveToLocal();">
            </div>
        </div>

        <div class="compact-row">
            <div class="select-group">
                <label>Rondes</label>
                <select id="rounds" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Oefeningen</label>
                <select id="exercises" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Sets</label>
                <select id="sets" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
        </div>

        <div style="margin-bottom:15px; margin-top:5px;">
            <div
                style="font-size:11px; color:#888; margin-bottom:4px; text-align:left; font-weight:600; text-transform:uppercase;">
                EXTRA OEFENINGEN (BONUS)</div>
            <div style="font-size:11px; color:#aaa; margin-bottom:10px; text-align:left;">
                Bijv: Warming-up (eenmalig start), Spinning (begin elke ronde) of Toetje/Finisher (einde les).
            </div>

            <div class="bonus-row">
                <input type="text" id="bonus1-name" value="Bonus 1" class="text-input" style="text-align:left;"
                    oninput="saveToLocal()">
                <select id="bonus1-duration" class="compact-select"
                    onchange="calculateRealTime(); saveToLocal();"></select>
                <select id="bonus1-freq" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>

            <div class="bonus-row">
                <input type="text" id="bonus2-name" value="Bonus 2" class="text-input" style="text-align:left;"
                    oninput="saveToLocal()">
                <select id="bonus2-duration" class="compact-select"
                    onchange="calculateRealTime(); saveToLocal();"></select>
                <select id="bonus2-freq" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>

            <div class="bonus-row">
                <input type="text" id="bonus3-name" value="Bonus 3" class="text-input" style="text-align:left;"
                    oninput="saveToLocal()">
                <select id="bonus3-duration" class="compact-select"
                    onchange="calculateRealTime(); saveToLocal();"></select>
                <select id="bonus3-freq" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
        </div>

        <div class="compact-row">
            <div class="select-group">
                <label>Rust tussen sets</label>
                <select id="restSec" class="compact-select" onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Rust tijdens wissel</label>
                <select id="exerciseRestSec" class="compact-select"
                    onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
            <div class="select-group">
                <label>Rust tussen rondes</label>
                <select id="roundRestSec" class="compact-select"
                    onchange="calculateRealTime(); saveToLocal();"></select>
            </div>
        </div>

        <div class="info-bar">
            <div style="font-size:12px; color:#888;">WERKTIJD PER SET</div>
            <div style="font-size:30px; font-weight:bold; color:#30D158;" id="live-calc-result">--</div>

            <div id="live-calc-error" style="color:#FF453A; display:none; font-size:12px;">Onmogelijk schema!</div>
        </div>

        <button class="action-btn btn-view-schedule" onclick="showScheduleModal()">üìÖ Bekijk & Bewerk Schema</button>
        <button class="action-btn" style="background: #BF5AF2; color: white; margin-bottom: 25px;"
            onclick="openGeneratorModal()">ü§ñ AI Training Generator</button>
        <button class="action-btn btn-start" id="btn-start-app" onclick="startWorkout()">START TRAINING</button>

        <div class="resume-options">
            <div class="collapsible-header resume-header open" onclick="toggleSection('sec-resume')">
                <div>Beginnen vanaf moment in training</div>
                <span class="arrow">‚ñº</span>
            </div>
            <div id="sec-resume" class="collapsible-content">
                <div style="font-size:12px; color:#aaa; margin-bottom:8px;">Vul hieronder in waar je wilt starten.</div>

                <div class="compact-row">
                    <div class="select-group">
                        <label>Ronde</label>
                        <select id="start-round" class="compact-select"
                            onchange="saveToLocal(); calculateRealTime();"></select>
                    </div>
                    <div class="select-group">
                        <label>Oefening</label>
                        <select id="start-ex" class="compact-select"
                            onchange="saveToLocal(); calculateRealTime();"></select>
                    </div>
                    <div class="select-group">
                        <label>Set</label>
                        <select id="start-set" class="compact-select"
                            onchange="saveToLocal(); calculateRealTime();"></select>
                    </div>
                </div>

            </div>
        </div>

        <div style="font-size:12px; color:#666; text-transform:uppercase; margin-bottom:5px;">GELUIDSINSTELLINGEN
            (SPRAAK) (Piepjes) werken alleen als je telefoon niet op stil staat!</div>

        <div class="toggle-container">
            <button class="toggle-btn active" id="btn-audio-speech" onclick="setAudioMode('speech')">üó£Ô∏è Spraak</button>
            <button class="toggle-btn" id="btn-audio-beep" onclick="setAudioMode('beep')">üîî Piepjes</button>
        </div>

        <!-- NEW: Mix Mode Switch for iOS -->
        <div id="ios-mix-container"
            style="background:#222; padding:10px; border-radius:12px; margin-bottom:15px; border:1px solid #333; text-align:left; display:none;">
            <div class="switch-row">
                <span class="switch-label" style="font-size:14px; font-weight:bold; color:#fff;">Mix Modus (Music
                    Fix)</span>
                <label class="switch">
                    <input type="checkbox" id="ios-mix-mode" onchange="toggleMixMode(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="font-size:11px; color:#aaa; margin-top:5px; line-height:1.4;">
                <span style="color:#FF9F0A; font-weight:bold;">‚ö†Ô∏è LET OP:</span> Voorkomt dat muziek stopt op iPhone.
                <br><b>VEREISTE:</b> Je belsignaal-schakelaar (zijkant) MOET AAN staan, anders hoor je niets!
            </div>
        </div>

        <div class="input-group" style="margin-bottom: 15px;">
            <label style="color:#30D158; font-weight:bold;">Kies je Coach Stijl</label>
            <select id="coach-preset" class="text-input" onchange="applyCoachPreset(this.value); saveToLocal();"
                style="font-size:16px; padding:12px;">
            </select>
        </div>
        <div style="font-size:11px; color:#888; margin-bottom:10px; margin-top:-10px;">
            Tip: Je kunt meerdere zinnen scheiden met een <b>|</b> teken. De app kiest dan willekeurig een zin (zonder
            direct te herhalen).
        </div>

        <div id="audio-toggles-panel" class="speech-options">
        </div>

        <div style="text-align:left; padding:5px 0; font-size:12px; color:#666; margin-top:20px;">VOORBEELD SCHEMA
            (VANAF NU):</div>
        <div id="preview-list" class="schedule-list-wrapper">
        </div>

        <div class="intro-banner">
            <div class="intro-title">ü¶Ö Welcome to the Friday Night Hawks!</div>
            <div class="intro-text">
                De legendarische triathlon: <b>Spinning üö¥ ¬ª Bootcamp üèãÔ∏è ¬ª Zwemmen üèä</b>.
                <br>Iedere vrijdagavond om 19:45. We sluiten af met <b>bitterballen</b> & gezelligheid! üçñüçª
            </div>
        </div>

    </div>

    <div id="timer-screen" style="display:none !important;">
        <div class="display-zone">
            <div class="gym-phase-title" id="gym-phase-title">KLAARMAKEN</div>

            <div class="timer-ring-container">
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <!-- Outer Ring (Total) -->
                    <circle class="ring-bg-outer" cx="50" cy="50" r="48"></circle>
                    <circle class="ring-val-outer" id="ring-total" cx="50" cy="50" r="48" stroke-dasharray="301.6"
                        stroke-dashoffset="0"></circle>

                    <!-- Inner Ring (Step) -->
                    <circle class="ring-bg-inner" cx="50" cy="50" r="40"></circle>
                    <circle class="ring-val-inner" id="ring-step" cx="50" cy="50" r="40" stroke-dasharray="251.3"
                        stroke-dashoffset="0"></circle>
                </svg>
                <div class="gym-big-time" id="countdown">10</div>
            </div>

            <div class="stats-wrapper" id="gym-stats-container">
                <div class="stats-row-1">
                    <div class="stat-box editable">
                        <select id="jump-round" class="transparent-input" onchange="handleJump()"></select>
                        <div class="edit-icon">‚ñº</div>
                        <div class="stat-label">Ronde</div>
                        <div class="stat-value" id="val-round">-</div>
                    </div>
                    <div class="stat-box editable">
                        <select id="jump-exercise" class="transparent-input" onchange="handleJump()"></select>
                        <div class="edit-icon">‚ñº</div>
                        <div class="stat-label">Oefening</div>
                        <div class="stat-value" id="val-exercise">-</div>
                    </div>
                    <div class="stat-box editable">
                        <select id="jump-set" class="transparent-input" onchange="handleJump()"></select>
                        <div class="edit-icon">‚ñº</div>
                        <div class="stat-label">Set</div>
                        <div class="stat-value" id="val-set">-</div>
                    </div>
                </div>
                <div class="stats-row-2">
                    <div class="stat-box editable">
                        <input type="time" id="live-endtime-input" class="transparent-input"
                            onchange="handleNewEndTime(this.value)">

                        <div class="edit-icon">‚úèÔ∏è</div>
                        <div class="stat-label">Einde (Klik!)</div>
                        <div class="stat-value" id="val-endtime">--:--</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Nog</div>
                        <div class="stat-value" id="val-remaining">--m</div>
                    </div>
                </div>
            </div>

            <div class="gym-next-info" id="gym-next-info">Hierna: Rust</div>
        </div>

        <div class="controls-container">
            <button class="btn-control btn-skip" onclick="handlePrevClick()">‚èÆ</button>
            <button class="btn-control btn-pause" id="btn-pause" onclick="handlePauseClick()">‚è∏</button>
            <button class="btn-control btn-skip" onclick="handleNextClick()">‚è≠</button>
            <button class="btn-control btn-stop" onclick="confirmStop()">‚èπ</button>
        </div>

        <div id="live-schedule-container">
            <table class="live-table" id="live-table">
                <thead>
                    <tr>
                        <th style="width:60px;">Tijd</th>
                        <th>Activiteit</th>
                        <th style="width:50px; text-align:right;">Duur</th>
                    </tr>
                </thead>
                <tbody id="live-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="pause-modal" style="display:none;">
        <div class="modal-content">
            <h2 style="margin-top:0;">Pauze voorbij</h2>
            <p style="color:#aaa; font-size:13px; margin-bottom:15px;">Je hebt <span id="pause-duration-display"
                    style="color:white; font-weight:bold;">0s</span> gepauzeerd. Hoe halen we dit in?</p>

            <button class="modal-btn" style="background: #333; color: white;" onclick="resolvePause('push')">
                üê¢ Eindtijd verzetten
                <span class="btn-subtext" id="btn-text-push">...</span>
            </button>

            <button class="modal-btn" id="btn-catch-work" style="background: #0A84FF; color: white;"
                onclick="resolvePause('work')">
                ‚è±Ô∏è Inhalen via Werktijd
                <span class="btn-subtext" id="btn-text-work">...</span>
            </button>

            <button class="modal-btn" id="btn-catch-rest" style="background: #FF9F0A; color: black;"
                onclick="resolvePause('rest')">
                üí§ Inhalen via Rust (Set)
                <span class="btn-subtext" id="btn-text-rest">...</span>
            </button>

            <button class="modal-btn" id="btn-catch-switch" style="background: #BF5AF2; color: white;"
                onclick="resolvePause('switch')">
                üîÄ Inhalen via Wissels
                <span class="btn-subtext" id="btn-text-switch">...</span>
            </button>

            <button class="modal-btn" id="btn-catch-round" style="background: #30D158; color: black;"
                onclick="resolvePause('round')">
                ‚òï Inhalen via Ronde Rust
                <span class="btn-subtext" id="btn-text-round">...</span>
            </button>
        </div>
    </div>



    <div id="speech-edit-modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Spraak aanpassen</h3>
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;">Gebruik | voor variatie</div>
            <textarea id="speech-edit-area"></textarea>
            <button class="modal-btn" style="background: #30D158; color: black;" onclick="saveSpeechEdit()">üíæ
                Opslaan</button>
            <button class="modal-btn" style="background: #333; color: white; margin-top:10px;"
                onclick="closeSpeechEdit()">Annuleren</button>
        </div>
    </div>

    <div id="schedule-modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">Volledig Schema</h3>
                <span style="font-size:24px; cursor:pointer;" onclick="closeScheduleModal()">√ó</span>
            </div>
            <div style="font-size:12px; color:#888; margin-bottom:5px;">Klik op een naam om deze te wijzigen.</div>
            <div class="schedule-table-container">
                <table class="schedule-table" id="full-schedule-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">Tijd</th>
                            <th>Oefening / Fase</th>
                            <th style="width:40px;">Sec</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="modal-btn" style="flex:1; background: #333; color: white; margin-top:0;"
                    onclick="closeScheduleModal()">Sluiten</button>
                <button class="modal-btn" style="flex:1; background: #0A84FF; color: white; margin-top:0;"
                    onclick="shareSchedulePDF()">Delen (PDF)</button>
            </div>
        </div>
    </div>

    <div id="exercise-selector-modal" class="modal-overlay"
        style="display:none; align-items:center; justify-content:center;">
        <div class="modal-content"
            style="max-width:400px; padding:0; overflow:hidden; display:flex; flex-direction:column; height:80vh; max-height:600px; width:95%;">

            <!-- Header -->
            <div
                style="padding:15px; background:#1c1c1e; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
                <h3 id="ex-modal-title" style="margin:0; font-size:16px; color:white;">Kies Oefening</h3>
                <div style="font-size:24px; cursor:pointer; padding:5px;" onclick="closeExerciseSelector()">√ó</div>
            </div>

            <!-- Hidden Inputs (Needed for Logic) -->
            <input type="hidden" id="edit-round-idx">
            <input type="hidden" id="edit-ex-idx">
            <input type="hidden" id="edit-set-idx">
            <input type="hidden" id="edit-new-val">

            <!-- List View -->
            <div id="ex-list-view" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">

                <!-- Filters -->
                <div style="padding:10px 10px 0 10px; background:#000; flex-shrink:0; display:flex; gap:10px;">
                    <select id="filter-category"
                        style="flex:1; padding:8px; border-radius:6px; background:#333; color:white; border:none; font-size:14px;"
                        onchange="filterExercises()">
                        <option value="">Alle Categorie√´n</option>
                    </select>
                    <select id="filter-material"
                        style="flex:1; padding:8px; border-radius:6px; background:#333; color:white; border:none; font-size:14px;"
                        onchange="filterExercises()">
                        <option value="">Alle Materialen</option>
                    </select>
                </div>

                <div style="padding:10px; background:#000; flex-shrink:0;">
                    <input type="text" id="ex-search-input" placeholder="Zoek oefening..."
                        style="width:100%; padding:12px; border-radius:8px; border:none; background:#333; color:white; font-size:16px;"
                        onkeyup="filterExercises()">
                </div>
                <ul id="ex-list-ul"
                    style="list-style:none; padding:0; margin:0; overflow-y:auto; flex:1; -webkit-overflow-scrolling: touch;">
                    <!-- JS Populated -->
                </ul>
            </div>

            <!-- Validation Modal -->
            <div id="validation-modal" class="modal" style="display:none;">
                <div class="modal-content">
                    <h3>Audio Bestanden Controleren</h3>
                    <p id="validation-status">Bezig met controleren...</p>
                    <ul id="validation-list"
                        style="text-align:left; font-size:12px; color:#ff453a; max-height:200px; overflow-y:auto; margin:10px 0;">
                    </ul>
                    <div class="modal-buttons">
                        <button class="btn-primary"
                            onclick="document.getElementById('validation-modal').style.display='none'">OK</button>
                    </div>
                </div>
            </div>

            <!-- Setup Screen -->
            <!-- Detail View -->
            <div id="ex-detail-view"
                style="display:none; flex:1; flex-direction:column; padding:20px; overflow-y:auto; background:#111;">
                <h2 id="detail-tit" style="margin-top:0; color:white;">Oefening</h2>
                <span id="detail-meta"
                    style="color:#30D158; font-size:14px; margin-bottom:10px; display:inline-block; border:1px solid #30D158; padding:2px 6px; border-radius:4px;">Type</span>

                <div style="background:#222; padding:15px; border-radius:8px; margin: 15px 0;">
                    <p id="detail-desc" style="color:#ccc; font-size:14px; line-height:1.4; margin:0;">Instructies...
                    </p>
                </div>

                <a id="detail-vid-btn" href="#" target="_blank" class="modal-btn"
                    style="background:#5856D6; color:white; text-decoration:none; display:flex; justify-content:center; align-items:center; margin-bottom:20px; flex-shrink:0;">
                    üì∫ Bekijk Video
                </a>

                <a id="detail-yt-shorts-btn" href="#" target="_blank" class="modal-btn"
                    style="background:#FF0000; color:white; text-decoration:none; display:flex; justify-content:center; align-items:center; margin-bottom:20px; flex-shrink:0;">
                    üì± Zoek op YouTube Shorts
                </a>

                <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:20px; flex-shrink:0;">
                    <div style="font-size:12px; color:#888; margin-bottom:10px; text-transform:uppercase;">Wijziging
                        toepassen op:</div>

                    <label style="display:flex; align-items:center; margin-bottom:15px; cursor:pointer;">
                        <input type="radio" name="scope_sel" value="all_rounds" checked
                            style="margin-right:15px; transform:scale(1.2);">
                        <div>
                            <div style="font-weight:bold; color:white;">Totaal (Alle Rondes)</div>
                            <div style="font-size:11px; color:#aaa;">Vervang deze oefening in het hele schema</div>
                        </div>
                    </label>

                    <label style="display:flex; align-items:center; margin-bottom:15px; cursor:pointer;">
                        <input type="radio" name="scope_sel" value="set_all_rounds"
                            style="margin-right:15px; transform:scale(1.2);">
                        <div>
                            <div style="font-weight:bold; color:white;">Alleen Set <span id="scope-set-force">1</span>
                                (Alle Rondes)</div>
                            <div style="font-size:11px; color:#aaa;">Bijv. alleen de 1e set van elke ronde</div>
                        </div>
                    </label>

                    <label style="display:flex; align-items:center; cursor:pointer;">
                        <input type="radio" name="scope_sel" value="single"
                            style="margin-right:15px; transform:scale(1.2);">
                        <div>
                            <div style="font-weight:bold; color:white;">Alleen DIT blokje</div>
                            <div style="font-size:11px; color:#aaa;">Eenmalige wijziging voor dit moment</div>
                        </div>
                    </label>
                </div>

                <div style="display:flex; gap:10px; margin-top:auto;">
                    <button class="modal-btn" style="background:#333; flex:1;" onclick="backToExList()">Terug</button>
                    <button class="modal-btn" style="background:#30D158; color:black; flex:1;"
                        onclick="confirmExerciseSelection()">Bevestigen</button>
                </div>
            </div>

        </div>
    </div>


    <!-- Audio Debug Log -->


    <input type="time" id="hidden-endtime-input" onchange="handleNewEndTime(this.value)" style="display:none;">

    <div id="generator-modal" class="modal-overlay" style="display:none; align-items:center; justify-content:center;">
        <div class="modal-content">
            <div
                style="padding:15px; background:#1c1c1e; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:16px; color:white;">‚ö° AI Generator</h3>
                <div style="font-size:24px; cursor:pointer;" onclick="closeGeneratorModal()">√ó</div>
            </div>

            <div style="flex:1; overflow-y:auto;">
                <!-- MATERIALEN -->
                <div class="gen-section">
                    <div class="gen-section-title"
                        style="display:flex; justify-content:space-between; align-items:center;">
                        <span>1. Kies Materialen (Volgorde van boven naar beneden)</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-micro" onclick="toggleGenCheckboxes('gen_mat', true)">Alles</button>
                            <button class="btn-micro" onclick="toggleGenCheckboxes('gen_mat', false)">Niets</button>
                        </div>
                    </div>
                    <div style="font-size:11px; color:#666; margin-bottom:5px;">De app rouleert door geselecteerde
                        materialen.</div>
                    <div class="gen-checkbox-grid" id="gen-materials-list">
                        <!-- JS Insert -->
                    </div>
                </div>

                <!-- CATEGORIEEN -->
                <div class="gen-section">
                    <div class="gen-section-title"
                        style="display:flex; justify-content:space-between; align-items:center;">
                        <span>2. Kies Spiergroepen</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-micro" onclick="toggleGenCheckboxes('gen_cat', true)">Alles</button>
                            <button class="btn-micro" onclick="toggleGenCheckboxes('gen_cat', false)">Niets</button>
                        </div>
                    </div>
                    <div class="gen-checkbox-grid" id="gen-categories-list">
                        <!-- JS Insert -->
                    </div>
                </div>

                <!-- LOGICA SETS -->
                <div class="gen-section">
                    <div class="gen-section-title">3. Herhaling per Set (Binnen 1 ronde)</div>
                    <div class="gen-radio-group">
                        <div class="gen-radio-opt active" onclick="setGenLogic('set', 'same', this)">Zelfde Oefening
                            (1.1 = 1.2)</div>
                        <div class="gen-radio-opt" onclick="setGenLogic('set', 'diff', this)">Elke Set Anders</div>
                    </div>
                </div>

                <!-- LOGICA RONDES -->
                <div class="gen-section">
                    <div class="gen-section-title">4. Herhaling per Ronde</div>
                    <div class="gen-radio-group">
                        <div class="gen-radio-opt active" onclick="setGenLogic('round', 'same', this)">Zelfde als Ronde
                            1</div>
                        <div class="gen-radio-opt" onclick="setGenLogic('round', 'diff', this)">Elke Ronde Anders
                        </div>
                    </div>
                </div>
            </div>

            <button class="gen-btn-generate" onclick="runGenerator()">‚ú® Genereer Training</button>
        </div>
    </div>

    <script>
        // --- v1.16: SIMPLIFIED AUDIO (MP3 ONLY) ---
        // --- VARIABELEN ---
        let audioMode = 'speech';
        let speechPlaylists = {};
        let editingSpeechKey = null;
        let customNames = {};
        let failedAudioKeys = new Set(); // Cache for missing MP3s

        // CONTAINERS
        // HARDE FALLBACK DEFAULTS (Zodat de app altijd werkt)
        const appDefaults = {
            rounds: 2, exercises: 6, sets: 2,
            restSec: 20, exerciseRestSec: 30, roundRestSec: 90,
            totalMin: 30,
            coachPreset: 'tabataman', // Default to MP3
            bonuses: [
                { name: "Bonus 1", duration: 0, freq: "start_round" },
                { name: "Bonus 2", duration: 0, freq: "start_round" },
                { name: "Bonus 3", duration: 0, freq: "start_round" }
            ]
        };

        const coachPresets = {
            'tabataman': { use_mp3: true },
            'nl_female': { use_mp3: true },
            'nl_male': { use_mp3: true }
        };

        let currentCoachName = "Tabataman (Standaard)";

        let speechSettings = {}; // This will now only hold the current coach's settings (use_mp3: true)

        // UI Config (still used for validation and structure, but not for TTS text)
        const uiConfig = [
            { header: "Voorbereiding" },
            { id: "prep_intro", label: "Introductie tekst", type: "text" },
            { id: "prep_countdown", label: "Aftellen (3, 2, 1)", type: "bool" },
            { header: "Tijdens Oefening (Werken)" },
            { id: "work_start", label: "Start commando", type: "text" },
            { id: "work_halfway", label: "Melding halverwege", type: "text" },
            { id: "work_30s", label: "Nog 30 seconden", type: "text" },
            { id: "work_10s", label: "Nog 10 seconden", type: "text" },

            { header: "Tijdens Rust (Set)" },
            { id: "rest_set_start", label: "Rust commando", type: "text" },
            { id: "rest_set_tips", label: "Willekeurige tips (ademhaling/drinken)", type: "bool" },
            { header: "Tijdens Rust (Wissel)" },
            { id: "rest_switch_start", label: "Wissel commando", type: "text" },
            { id: "rest_switch_info", label: "Noem volgende oefening nummer", type: "bool" },
            { id: "rest_switch_10s", label: "Waarschuwing 10s voor einde", type: "text" },
            { header: "Tijdens Rust (Ronde)" },
            { id: "rest_round_start", label: "Grote pauze commando", type: "text" },
            { id: "rest_round_info", label: "Noem volgende ronde nummer", type: "bool" },
            { id: "rest_round_15s", label: "Waarschuwing 15s voor einde", type: "text" },
            { header: "Mijlpalen & Einde" },
            { id: "mile_start", label: "25% (Goede start)", type: "text" },
            { id: "mile_half", label: "50% (Helft)", type: "text" },
            { id: "mile_end", label: "75% (Eindsprint)", type: "text" },
            { id: "mile_lastround", label: "Start laatste ronde", type: "text" },
            { id: "finish", label: "Einde training", type: "text" }
        ];

        let schedule = [];
        let workTimeSec = 0, restTimeSec = 0, exerciseRestSec = 0, roundRestSec = 0;
        let currentIndex = 0;
        let timerInterval;
        let isPaused = false;
        let pauseStartTime = 0;
        let workoutStartTime, targetEndTimeDate;
        let totalWorkSetsGlobal = 0;
        let audioCtx;
        let currentPauseDuration = 0;

        // HELPER: Get Bonus Data
        function getBonusData(i) {
            return {
                name: document.getElementById(`bonus${i}-name`).value || `Bonus ${i}`,
                min: parseInt(document.getElementById(`bonus${i}-duration`).value) || 0,
                freq: document.getElementById(`bonus${i}-freq`).value,
                id: i
            };
        }

        // --- ROBUUSTE FUNCTIE OM DATA TE LADEN ---
        async function initApp() {
            const select = document.getElementById('coach-preset');
            select.innerHTML = '<option value="loading" disabled selected>Laden...</option>';

            const addOption = (id, name) => {
                if (!select.querySelector(`option[value="${id}"]`)) {
                    const opt = document.createElement('option');
                    opt.value = id; opt.text = name;
                    select.appendChild(opt);
                }
            };

            // 1. Init Defaults (Skipped external fetch, usage hardcoded)

            // 2. Probeer Coaches
            // The coachPresets object is now hardcoded, so we just populate the select based on it.
            for (const coachId in coachPresets) {
                let displayName = coachId.charAt(0).toUpperCase() + coachId.slice(1);
                if (coachId === 'tabataman') displayName = 'TabataMan (Actief)';
                if (coachId === 'nl_female') displayName = 'Eva (Rustig)';
                if (coachId === 'nl_male') displayName = 'Daan (Energiek)';
                addOption(coachId, displayName);
            }

            // Clean up dropdown UI
            const loadingOpt = select.querySelector('option[value="loading"]');
            if (loadingOpt) loadingOpt.remove();

            // 3. PAS NU DE WAARDEN TOE
            finalizeInit();
        }

        function finalizeInit() {
            const select = document.getElementById('coach-preset');

            // Selecteer standaard uit defaults, of fallback op eerste in lijst
            let targetPreset = appDefaults.coachPreset || 'tabataman';

            // If the target preset doesn't exist (shouldn't happen with hardcoded presets),
            // or if the select value isn't set, default to 'tabataman'.
            if (!coachPresets[targetPreset] || !select.querySelector(`option[value="${targetPreset}"]`)) {
                targetPreset = 'tabataman';
            }

            select.value = targetPreset;
            if (!speechSettings || Object.keys(speechSettings).length === 0) {
                speechSettings = JSON.parse(JSON.stringify(coachPresets[targetPreset]));
            }

            loadFromLocal();
            checkForSharedSettings();

            // Generate Toggles
            renderAudioToggles();

            // Zet inputs op basis van defaults (als ze nog niet zijn overschreven door local)
            // Let op: loadFromLocal overschrijft dit weer als er iets is opgeslagen.
            // Als er NIETS is opgeslagen, willen we de defaults in de UI zien:
            if (!localStorage.getItem('fnh_settings_v8')) {
                applyDefaultsToUI();
            }

            // Sync tijd en calculatie
            if (!document.getElementById('endTimeValue').value) {
                syncTime('duration');
            }
            calculateRealTime();
        }

        function applyDefaultsToUI() {
            document.getElementById('rounds').value = appDefaults.rounds;
            document.getElementById('exercises').value = appDefaults.exercises;
            document.getElementById('sets').value = appDefaults.sets;
            document.getElementById('restSec').value = appDefaults.restSec;
            document.getElementById('exerciseRestSec').value = appDefaults.exerciseRestSec;
            document.getElementById('roundRestSec').value = appDefaults.roundRestSec;
            document.getElementById('totalMin').value = appDefaults.totalMin;
            document.getElementById('coach-preset').value = appDefaults.coachPreset;

            if (appDefaults.bonuses) {
                for (let i = 0; i < 3; i++) {
                    if (appDefaults.bonuses[i]) {
                        document.getElementById(`bonus${i + 1}-name`).value = appDefaults.bonuses[i].name;
                        document.getElementById(`bonus${i + 1}-duration`).value = appDefaults.bonuses[i].duration;
                        document.getElementById(`bonus${i + 1}-freq`).value = appDefaults.bonuses[i].freq;
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateDropdowns();

            // Start async init, maar blokkeer de UI niet
            initApp();

            document.querySelectorAll('input.param-input').forEach(i => {
                i.addEventListener('input', () => { calculateRealTime(); saveToLocal(); });
            });

            // These are now handled by the new card-group
            // document.getElementById('btn-audio-speech').onclick = () => { setAudioMode('speech'); saveToLocal(); };
            // document.getElementById('btn-audio-beep').onclick = () => { setAudioMode('beep'); saveToLocal(); };

            document.addEventListener("visibilitychange", handleVisibilityChange);

            // Initiele calculatie voor de zekerheid
            calculateRealTime();
        });

        function syncTime(source) {
            const min = parseInt(document.getElementById('totalMin').value) || 30;
            const startInput = document.getElementById('startTimeValue');
            const endInput = document.getElementById('endTimeValue');
            const now = new Date();

            const getDateFromTimeStr = (str, baseDate) => {
                if (!str) return null;
                const [h, m] = str.split(':');
                let d = new Date(baseDate.getTime());
                d.setHours(h, m, 0, 0);
                return d;
            };

            if (source === 'duration') {
                // Change Duration -> Update End Time
                let base = getDateFromTimeStr(startInput.value, now) || now;
                let target = new Date(base.getTime() + min * 60000);
                endInput.value = target.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', hour12: false });
            }
            else if (source === 'starttime') {
                // Change Start Time -> Update Duration (Keep End Time fixed)
                let start = getDateFromTimeStr(startInput.value, now) || now;
                let end = getDateFromTimeStr(endInput.value, now);

                if (end) {
                    if (end < start) end.setDate(end.getDate() + 1);
                    let diffMs = end - start;
                    let diffMin = Math.round(diffMs / 60000);
                    if (diffMin < 0) diffMin += 1440;

                    const sel = document.getElementById('totalMin');
                    let exists = false;
                    for (let i = 0; i < sel.options.length; i++) { if (parseInt(sel.options[i].value) === diffMin) exists = true; }

                    if (!exists && diffMin > 0) {
                        const opt = document.createElement('option');
                        opt.value = diffMin;
                        opt.text = diffMin + "m";
                        sel.add(opt, 0);
                        sel.value = diffMin;
                    } else if (diffMin > 0) {
                        sel.value = diffMin;
                    }
                } else {
                    // No End Time set -> Standard behavior (maintain duration)
                    let target = new Date(start.getTime() + min * 60000);
                    endInput.value = target.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', hour12: false });
                }
            }
            else if (source === 'endtime') {
                // Change End Time -> Update Duration
                let end = getDateFromTimeStr(endInput.value, now);
                if (!end) return;

                let base = getDateFromTimeStr(startInput.value, now) || now;

                // Handle overnight
                if (end < base) end.setDate(end.getDate() + 1);

                let diffMs = end - base;
                let diffMin = Math.round(diffMs / 60000);

                const sel = document.getElementById('totalMin');
                let exists = false;
                for (let i = 0; i < sel.options.length; i++) { if (parseInt(sel.options[i].value) === diffMin) exists = true; }

                if (!exists && diffMin > 0) {
                    const opt = document.createElement('option');
                    opt.value = diffMin;
                    opt.text = diffMin + "m";
                    sel.add(opt, 0);
                    sel.value = diffMin;
                } else if (diffMin > 0) {
                    sel.value = diffMin;
                }
            }
            calculateRealTime();
        }

        function populateDropdowns() {
            const fill = (id, start, end, step = 1, suffix = "") => {
                const sel = document.getElementById(id);
                const resumeSel = document.getElementById("start-" + (id === 'rounds' ? 'round' : (id === 'exercises' ? 'ex' : (id === 'sets' ? 'set' : ''))));
                if (sel) sel.innerHTML = "";
                if (resumeSel) resumeSel.innerHTML = "";
                for (let i = start; i <= end; i += step) {
                    const opt = document.createElement('option'); opt.value = i; opt.text = i + suffix; if (sel) sel.appendChild(opt);
                    if (resumeSel) { const opt2 = document.createElement('option'); opt2.value = i; opt2.text = i + suffix; resumeSel.appendChild(opt2); }
                }
            };
            fill('rounds', 1, 10);
            fill('exercises', 1, 20);
            fill('sets', 1, 10);

            const fillTotal = (id) => {
                const sel = document.getElementById(id); sel.innerHTML = "";
                for (let i = 1; i <= 10; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = i + "m"; sel.appendChild(opt); }
                for (let i = 15; i <= 120; i += 5) { const opt = document.createElement('option'); opt.value = i; opt.text = i + "m"; sel.appendChild(opt); }
            };
            fillTotal('totalMin');

            const fillRest = (id) => {
                const sel = document.getElementById(id); sel.innerHTML = "";
                for (let i = 5; i <= 60; i += 5) { const opt = document.createElement('option'); opt.value = i; opt.text = i + "s"; sel.appendChild(opt); }
                for (let i = 70; i <= 180; i += 10) { const opt = document.createElement('option'); opt.value = i; opt.text = i + "s"; sel.appendChild(opt); }
                for (let i = 210; i <= 300; i += 30) { const opt = document.createElement('option'); opt.value = i; opt.text = i + "s"; sel.appendChild(opt); }
            };
            fillRest('restSec'); fillRest('exerciseRestSec'); fillRest('roundRestSec');

            // Fill Bonus Duration Dropdown
            const fillBonusDuration = (id) => {
                const sel = document.getElementById(id); sel.innerHTML = "";
                const opt0 = document.createElement('option'); opt0.value = 0; opt0.text = "0 min (Uit)"; sel.appendChild(opt0);
                for (let i = 1; i <= 15; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = i + " min"; sel.appendChild(opt); }
            };

            const fillBonusFreq = (id) => {
                const sel = document.getElementById(id); sel.innerHTML = "";

                const addOpt = (val, txt) => {
                    const opt = document.createElement('option'); opt.value = val; opt.text = txt; sel.appendChild(opt);
                };

                addOpt('start_round', 'Begin elke ronde');
                addOpt('warmup', 'Alleen begin (Warming-up)');
                addOpt('end_round', 'Eind elke ronde');
                addOpt('end_session', 'Einde van de les (Toetje)');

                const grp = document.createElement('optgroup'); grp.label = "‚îÄ‚îÄ INTERVALLEN ‚îÄ‚îÄ"; sel.appendChild(grp);

                for (let i = 1; i <= 12; i++) {
                    const opt = document.createElement('option'); opt.value = i; opt.text = `Om de ${i} oefeningen`; sel.appendChild(opt);
                }
            };

            // Loop for 3 bonuses
            for (let i = 1; i <= 3; i++) {
                fillBonusDuration(`bonus${i}-duration`);
                fillBonusFreq(`bonus${i}-freq`);
            }
        }

        function handleVisibilityChange() {
            if (document.visibilityState === 'visible' && !isPaused && timerInterval) {
                // Interval logic handles catch up automatically
            }
        }

        function toggleSection(id) {
            const el = document.getElementById(id);
            const header = el.previousElementSibling;
            if (el.style.display === 'none' || el.classList.contains('hidden')) {
                el.style.display = 'block';
                el.classList.remove('hidden');
                header.classList.add('open');
            } else {
                el.style.display = 'none';
                el.classList.add('hidden');
                header.classList.remove('open');
            }
        }

        function handleCoachChange() {
            const val = document.getElementById('coach-preset').value;
            // Merge new coach preset but KEEP user toggle overrides if they exist? 
            // Ideally we reset to the new coach defaults, but user might want to keep "Halfway OFF".
            // For now, let's reset to defaults of the new coach to be safe.
            speechSettings = JSON.parse(JSON.stringify(coachPresets[val]));

            saveToLocal();
            renderAudioToggles(); // Re-render toggles
            validateCoachFiles(val);
        }

        // --- v1.16: RENDER AUDIO TOGGLES ---
        function renderAudioToggles() {
            const container = document.getElementById('audio-toggles-panel');
            if (!container) return;
            container.innerHTML = "";

            if (audioMode === 'beep') {
                container.innerHTML = "<div style='color:#666; font-style:italic; font-size:12px; padding:10px;'>In piepjes-modus zijn er geen spraak instellingen.</div>";
                return;
            }

            uiConfig.forEach(item => {
                if (item.header) {
                    const h = document.createElement('div'); h.className = "category-header"; h.innerText = item.header;
                    h.style.marginTop = "15px"; h.style.marginBottom = "5px"; h.style.fontSize = "11px"; h.style.color = "#888"; h.style.fontWeight = "600";
                    container.appendChild(h);
                } else {
                    const wrapper = document.createElement('div'); wrapper.className = "switch-row";

                    const label = document.createElement('span'); label.className = "switch-label"; label.innerText = item.label;
                    const switchLabel = document.createElement('label'); switchLabel.className = "switch";

                    const cb = document.createElement('input'); cb.type = "checkbox";

                    // Check logic: if key missing, assume enabled by default
                    let isEnabled = true;
                    if (speechSettings[item.id] && typeof speechSettings[item.id].enabled !== 'undefined') {
                        isEnabled = speechSettings[item.id].enabled;
                    }
                    cb.checked = isEnabled;

                    cb.onchange = () => {
                        if (!speechSettings[item.id]) speechSettings[item.id] = { enabled: true };
                        speechSettings[item.id].enabled = cb.checked;
                        saveToLocal();
                    };

                    const slider = document.createElement('span'); slider.className = "slider";
                    switchLabel.appendChild(cb); switchLabel.appendChild(slider);
                    wrapper.appendChild(label); wrapper.appendChild(switchLabel);
                    container.appendChild(wrapper);
                }
            });
        }

        async function validateCoachFiles(coachId) {
            const modal = document.getElementById('validation-modal');
            const status = document.getElementById('validation-status');
            const list = document.getElementById('validation-list');

            modal.style.display = 'flex';
            status.innerText = "Controleren op MP3 bestanden...";
            status.style.color = "#fff";
            list.innerHTML = "";

            const expectedKeys = [];
            uiConfig.forEach(item => {
                if (item.id) expectedKeys.push(item.id);
            });

            // Add manual bonus keys if we want to be thorough, but uiConfig covers most speech triggers.

            const missing = [];

            // Check in chunks to not overload (optional, but Promise.all is usually fine for ~20 files)
            const checks = expectedKeys.map(async (key) => {
                try {
                    const path = `coaches/${coachId}/${key}.mp3`;
                    const resp = await fetch(path, { method: 'HEAD' });
                    if (!resp.ok) return key;
                    return null;
                } catch (e) {
                    return key; // Error means missing or network issue
                }
            });

            const results = await Promise.all(checks);
            results.forEach(res => {
                if (res) missing.push(res);
            });

            if (missing.length > 0) {
                status.innerText = `Er ontbreken ${missing.length} bestanden:`;
                status.style.color = "#ff453a";
                missing.forEach(key => {
                    const li = document.createElement('li');
                    li.innerText = `${key}.mp3`;
                    list.appendChild(li);
                });
            } else {
                status.innerText = "Alle audio bestanden zijn aanwezig! ‚úÖ";
                status.style.color = "#30D158";
                setTimeout(() => {
                    if (modal.style.display === 'flex') modal.style.display = 'none';
                }, 1500);
            }
        }


        // --- SCHEDULE MODAL LOGIC ---
        function getExerciseDetails(name) {
            if (typeof WORKOUT_DB === 'undefined') return null;
            // Try exact match first
            let match = WORKOUT_DB.find(i => i.exercise_name === name);
            if (match) return match;
            // Try case-insensitive
            return WORKOUT_DB.find(i => i.exercise_name.toLowerCase() === name.toLowerCase());
        }

        function showScheduleModal() {
            generateScheduleData(false);
            const tableBody = document.querySelector('#full-schedule-table tbody');
            tableBody.innerHTML = "";

            let currentTime = new Date();

            schedule.forEach((step) => {
                if (step.type === 'finish') return;

                const tr = document.createElement('tr');

                // Time Cell
                const tdTime = document.createElement('td');
                tdTime.style.verticalAlign = 'top';
                tdTime.style.paddingTop = '10px';
                tdTime.innerText = currentTime.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                // Content Cell
                const tdContent = document.createElement('td');

                // --- RICH CARD LOGIC ---
                if (step.type === 'work' && step.info.exercise > 0) {
                    const exName = step.label;
                    const details = getExerciseDetails(exName);

                    const divCard = document.createElement('div');
                    divCard.className = 'schedule-card';

                    // Video Button
                    let videoBtnHtml = '';
                    let matName = '-';
                    let matDesc = '-';
                    let instr = '-';

                    if (details) {
                        matName = details.material_name || '-';
                        matDesc = details.material_description || '-';
                        instr = details.instructions || '-';

                        const vidUrl = details.video_search_url || "";

                        const searchUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(exName + " shorts")}`;
                        const finalUrl = vidUrl ? vidUrl : searchUrl;
                        const shortsUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(exName + " " + matName + " workout shorts")}`;

                        videoBtnHtml = `
                            <div style="display:flex; gap:10px;">
                                <button class="btn-video" onclick="window.open('${finalUrl}', '_blank')" style="flex:1;">
                                    ‚ñ∂ Video
                                </button>
                                <button class="btn-video" onclick="window.open('${shortsUrl}', '_blank')" style="flex:1; background-color:#FF3B30;">
                                    üì± Shorts
                                </button>
                            </div>
                        `;
                    }

                    // New Labeled Structure
                    divCard.innerHTML = `
                        <div style="display:flex; flex-direction:column; gap:10px; text-align:left;">
                            
                            <div>
                                <div style="font-size:10px; font-weight:bold; color:#888; text-transform:uppercase; margin-bottom:2px;">Naam Oefening</div>
                                <div class="schedule-name" onclick="openExerciseSelector(${step.info.round}, ${step.info.exercise}, ${step.info.set}, '${exName}')" 
                                     style="cursor:pointer; text-decoration:underline; font-size:14px; font-weight:bold; color:#fff;">
                                    ${exName}
                                </div>
                            </div>

                            <div>
                                <div style="font-size:10px; font-weight:bold; color:#888; text-transform:uppercase; margin-bottom:2px;">Materiaal</div>
                                <div style="font-size:13px; color:#ddd;">${matName}</div>
                            </div>

                            <div>
                                <div style="font-size:10px; font-weight:bold; color:#888; text-transform:uppercase; margin-bottom:2px;">Omschrijving Materiaal</div>
                                <div style="font-size:13px; color:#bbb; font-style:italic;">${matDesc}</div>
                            </div>

                            <div>
                                <div style="font-size:10px; font-weight:bold; color:#888; text-transform:uppercase;">Instructie</div>
                                <div style="font-size:13px; color:#fff; line-height:1.4;">${instr}</div>
                            </div>

                            <div style="margin-top:5px;">
                                ${videoBtnHtml}
                            </div>
                        </div>
                    `;
                    tdContent.appendChild(divCard);

                } else {
                    // Rest / Transition / Prep
                    // Keep it simple but styled slightly to match width
                    const divSimple = document.createElement('div');
                    divSimple.style.padding = '10px';
                    divSimple.style.color = '#888';
                    divSimple.innerText = step.label;
                    if (step.info && step.info.round && step.info.exercise > 0) {
                        divSimple.innerText += ` (R${step.info.round}/E${step.info.exercise})`;
                    }
                    tdContent.appendChild(divSimple);
                }

                // Duration Cell
                const tdDur = document.createElement('td');
                tdDur.style.verticalAlign = 'top';
                tdDur.style.paddingTop = '10px';
                tdDur.innerText = step.time;

                tr.appendChild(tdTime);
                tr.appendChild(tdContent);
                tr.appendChild(tdDur);
                tableBody.appendChild(tr);

                currentTime.setSeconds(currentTime.getSeconds() + step.time);
            });

            document.getElementById('schedule-modal').style.display = 'flex';
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').style.display = 'none';
            calculateRealTime();
        }



        // --- NEW EXERCISE SELECTOR LOGIC ---
        let currentExContext = null; // {r, e, s}
        let selectedDbItem = null;

        function openExerciseSelector(r, e, s, currentName) {
            currentExContext = { r, e, s };
            document.getElementById('exercise-selector-modal').style.display = 'flex';
            document.getElementById('scope-set-force').innerText = s;

            // Generate list
            const ul = document.getElementById('ex-list-ul');
            ul.innerHTML = "";

            // Filters Sets
            const categories = new Set();
            const materials = new Set();

            // Add "Custom" option at top
            const customLi = document.createElement('li');
            customLi.className = "ex-list-item";
            customLi.style.borderBottom = "2px solid #333";
            customLi.innerHTML = `<span style="font-weight:bold; color:white;">‚úèÔ∏è Eigen Naam Invoeren...</span>`;
            customLi.onclick = () => {
                const name = prompt("Voer naam in:", currentName);
                if (name) {
                    selectedDbItem = { exercise_name: name }; // Pseudo item
                    showExDetail(selectedDbItem);
                }
            };
            ul.appendChild(customLi);

            // Populate from DB
            if (typeof WORKOUT_DB !== 'undefined') {
                WORKOUT_DB.forEach(item => {
                    const li = document.createElement('li');
                    li.className = "ex-list-item";

                    // Metadata for filtering
                    const cat = item.category || "Other";
                    const mat = item.material_name || "None";

                    categories.add(cat);
                    materials.add(mat);

                    li.dataset.search = (item.exercise_name + " " + cat + " " + item.id).toLowerCase();
                    li.dataset.cat = cat;
                    li.dataset.mat = mat;

                    li.innerHTML = `
                        <div style="font-weight:500; color:#eee;">${item.exercise_name}</div>
                        <div class="ex-cat-tag">${cat}</div>
                    `;
                    li.onclick = () => showExDetail(item);
                    ul.appendChild(li);
                });
            } else {
                ul.innerHTML += `<li class="ex-list-item">Database niet geladen.</li>`;
            }

            // Populate Filter Dropdowns
            const catSelect = document.getElementById('filter-category');
            catSelect.innerHTML = '<option value="">Alle Categorie√´n</option>';
            Array.from(categories).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                catSelect.appendChild(opt);
            });

            const matSelect = document.getElementById('filter-material');
            matSelect.innerHTML = '<option value="">Alle Materialen</option>';
            Array.from(materials).sort().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                matSelect.appendChild(opt);
            });

            // Show List View
            backToExList();
        }

        function filterExercises() {
            const term = document.getElementById('ex-search-input').value.toLowerCase();
            const catFilter = document.getElementById('filter-category').value;
            const matFilter = document.getElementById('filter-material').value;

            const items = document.querySelectorAll('#ex-list-ul .ex-list-item');
            items.forEach(li => {
                if (!li.dataset.search) return; // Custom item

                const matchesTerm = li.dataset.search.includes(term);
                const matchesCat = catFilter === "" || li.dataset.cat === catFilter;
                const matchesMat = matFilter === "" || li.dataset.mat === matFilter;

                if (matchesTerm && matchesCat && matchesMat) li.style.display = 'flex';
                else li.style.display = 'none';
            });
        }

        function showExDetail(item) {
            selectedDbItem = item;
            document.getElementById('ex-list-view').style.display = 'none';
            document.getElementById('ex-detail-view').style.display = 'flex';
            document.getElementById('ex-modal-title').innerText = "Bevestig";

            document.getElementById('detail-tit').innerText = item.exercise_name;
            document.getElementById('detail-meta').innerText = item.category || "Custom";
            document.getElementById('detail-desc').innerText = item.instructions || "Geen instructies.";

            const vidBtn = document.getElementById('detail-vid-btn');
            if (item.video_search_url) {
                vidBtn.style.display = 'flex';
                vidBtn.href = item.video_search_url;
            } else {
                vidBtn.style.display = 'none';
            }

            const shortsBtn = document.getElementById('detail-yt-shorts-btn');
            if (shortsBtn) {
                shortsBtn.href = `https://www.youtube.com/results?search_query=${encodeURIComponent(item.exercise_name + " shorts")}`;
            }
        }

        function backToExList() {
            document.getElementById('ex-list-view').style.display = 'flex';
            document.getElementById('ex-detail-view').style.display = 'none';
            document.getElementById('ex-modal-title').innerText = "Kies Oefening";
        }

        function closeExerciseSelector() {
            document.getElementById('exercise-selector-modal').style.display = 'none';
            showScheduleModal(); // Return to previous modal
        }

        function confirmExerciseSelection() {
            if (!selectedDbItem || !currentExContext) return;

            const scopeRadios = document.getElementsByName('scope_sel');
            let scope = 'all_rounds';
            for (let r of scopeRadios) if (r.checked) scope = r.value;

            // Map scope to function args
            // 'all_rounds', 'set_all_rounds', 'single'
            // NOTE: 'round_ex' removed based on UI simplification, but we can re-add if needed.

            // Set input values for hidden fields used by applyNameChange
            document.getElementById('edit-round-idx').value = currentExContext.r;
            document.getElementById('edit-ex-idx').value = currentExContext.e;
            document.getElementById('edit-set-idx').value = currentExContext.s;
            document.getElementById('edit-new-val').value = selectedDbItem.exercise_name;

            applyNameChange(scope);
            closeExerciseSelector();
        }

        // --- OLD MODAL REMOVED - Adapter for applyNameChange remains same ---
        // (Function applyNameChange is reused)

        function closeEditScopeModal() {
            document.getElementById('edit-scope-modal').style.display = 'none';
            showScheduleModal();
        }

        function applyNameChange(scope) {
            const r = parseInt(document.getElementById('edit-round-idx').value);
            const e = parseInt(document.getElementById('edit-ex-idx').value);
            const s = parseInt(document.getElementById('edit-set-idx').value);
            const newVal = document.getElementById('edit-new-val').value;
            const totalRounds = parseInt(document.getElementById('rounds').value);

            if (scope === 'single') {
                const key = `r${r}-e${e}-s${s}`;
                if (newVal.trim() === "") delete customNames[key];
                else customNames[key] = newVal;
            }
            else if (scope === 'round_ex') {
                const key = `r${r}-e${e}`;
                if (newVal.trim() === "") delete customNames[key];
                else customNames[key] = newVal;
                // Cleanup specific set overrides for this round
                Object.keys(customNames).forEach(k => { if (k.startsWith(`r${r}-e${e}-s`)) delete customNames[k]; });
            }
            else if (scope === 'all_rounds') {
                for (let i = 1; i <= totalRounds; i++) {
                    const key = `r${i}-e${e}`;
                    if (newVal.trim() === "") delete customNames[key];
                    else customNames[key] = newVal;
                    // Cleanup specific set overrides
                    Object.keys(customNames).forEach(k => { if (k.startsWith(`r${i}-e${e}-s`)) delete customNames[k]; });
                }
            }
            else if (scope === 'set_all_rounds') {
                for (let i = 1; i <= totalRounds; i++) {
                    const key = `r${i}-e${e}-s${s}`;
                    if (newVal.trim() === "") delete customNames[key];
                    else customNames[key] = newVal;
                }
            }

            saveToLocal();
            document.getElementById('edit-scope-modal').style.display = 'none'; // OLD MODAL REMOVED
            // showScheduleModal(); // Handled by caller
        }

        function resetToDefaults() {
            if (!confirm("Weet je zeker dat je alle instellingen wilt resetten naar standaard?")) return;

            applyDefaultsToUI();

            customNames = {};

            // Custom Reset Logic: Start Time + 5min, Duration 45min, Rest 15s
            const now = new Date();
            const start = new Date(now.getTime() + 5 * 60000);
            const startStr = start.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', hour12: false });

            document.getElementById('startTimeValue').value = startStr;

            // Ensure 45m exists and set it
            const durSel = document.getElementById('totalMin');
            const targetDur = 45;
            let exists = false;
            for (let i = 0; i < durSel.options.length; i++) { if (parseInt(durSel.options[i].value) === targetDur) exists = true; }
            if (!exists) {
                const opt = document.createElement('option');
                opt.value = targetDur;
                opt.text = targetDur + "m";
                durSel.add(opt, 0); // Add at top or sorted? Logic usually adds at top if missing.
            }
            durSel.value = targetDur;

            // Set Rest Time to 15s
            document.getElementById('restSec').value = 15;

            // Set Exercises to 8
            document.getElementById('exercises').value = 8;

            syncTime('duration'); // Updates End Time based on Start + Duration
            setAudioMode('speech');
            document.getElementById('coach-preset').value = 'tabataman';

            saveToLocal();
            calculateRealTime();
        }

        function applyTabataPreset() {
            if (!confirm("Huidige instellingen overschrijven met Tabata preset?")) return;

            // Tabata Specifics:
            // 4 min Duration
            // 1 Round
            // 8 Exercises
            // 1 Set
            // 10s Rest (Switch)
            // (Implicit: 20s Work Time calculated automatically)

            // Ensure 4m exists
            const durSel = document.getElementById('totalMin');
            const targetDur = 4;
            let exists = false;
            for (let i = 0; i < durSel.options.length; i++) { if (parseInt(durSel.options[i].value) === targetDur) exists = true; }
            if (!exists) {
                const opt = document.createElement('option');
                opt.value = targetDur; opt.text = targetDur + "m";
                durSel.add(opt, 0);
            }
            durSel.value = targetDur;

            document.getElementById('rounds').value = 1;
            document.getElementById('exercises').value = 8;
            document.getElementById('sets').value = 1;
            document.getElementById('exerciseRestSec').value = 10;

            document.getElementById('exerciseRestSec').value = 10;

            // NEW: Set Start Time to NOW to prevent "Time in Past" legacy bugs
            const now = new Date();
            const timeStr = now.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('startTimeValue').value = timeStr;

            // We don't touch other Rests unless needed. 
            // Standard Tabata usually implies short rests. 
            // But user only specified Switch Rest 10s.

            // Sync to update End Time
            syncTime('duration');
            calculateRealTime();
            saveToLocal();
        }

        // --- AI GENERATOR LOGIC ---
        let globalCoachAudio = new Audio();
        let audioCache = {}; // Cache for Web Audio buffers (Mix Mode)
        let iosMixMode = true; // Default ON (v1.5)
        let genLogic = { set: 'same', round: 'same' };

        // Show Mix Mode toggle only on iOS & Add Resumption Listeners
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            document.addEventListener('DOMContentLoaded', () => {
                const el = document.getElementById('ios-mix-container');
                if (el) el.style.display = 'block';

                // Set checkbox to default true if not loaded yet
                const mixEl = document.getElementById('ios-mix-mode');
                if (mixEl && !localStorage.getItem('fnh_settings')) mixEl.checked = true;
            });

            // Auto-Resume AudioContext on Tab Focus/Return
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) wakeUpAudio();
            });

            // Re-unlock on any touch (ensure playback)
            document.addEventListener('touchstart', () => {
                wakeUpAudio();
            }, { passive: true });
        }

        function wakeUpAudio() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended' || audioCtx.state === 'interrupted') {
                audioCtx.resume().then(() => logAudioDebug("‚ö° Audio Resumed (WakeUp)"));
            }
            // Force silent oscillator to wake up iOS Audio Engine
            try {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                g.gain.value = 0; // Silent
                osc.connect(g);
                g.connect(audioCtx.destination);
                osc.start(0);
                osc.stop(audioCtx.currentTime + 0.01);
            } catch (e) { /* ignore */ }
        }

        function toggleMixMode(state) {
            iosMixMode = state;
            saveToLocal();
        }

        function openGeneratorModal() {
            document.getElementById('generator-modal').style.display = 'flex';
            populateGeneratorOptions();
        }

        function closeGeneratorModal() {
            document.getElementById('generator-modal').style.display = 'none';
        }

        function toggleGenCheckboxes(name, state) {
            document.querySelectorAll(`input[name="${name}"]`).forEach(cb => cb.checked = state);
        }

        function setGenLogic(type, val, el) {
            genLogic[type] = val;
            // Update UI
            const group = el.parentElement;
            group.querySelectorAll('.gen-radio-opt').forEach(opt => opt.classList.remove('active'));
            el.classList.add('active');
        }

        function populateGeneratorOptions() {
            const matList = document.getElementById('gen-materials-list');
            const catList = document.getElementById('gen-categories-list');
            matList.innerHTML = "";
            catList.innerHTML = "";

            if (typeof WORKOUT_DB === 'undefined') {
                matList.innerHTML = "Database niet geladen.";
                return;
            }

            const cats = new Set();
            const mats = new Set();

            WORKOUT_DB.forEach(item => {
                if (item.category) cats.add(item.category);
                if (item.material_name) mats.add(item.material_name);
            });

            // Populate Materials
            Array.from(mats).sort().forEach(m => {
                const div = document.createElement('div');
                div.className = 'gen-checkbox-item';
                div.innerHTML = `<input type="checkbox" name="gen_mat" value="${m}" checked> ${m}`;
                matList.appendChild(div);
            });

            // Populate Categories
            Array.from(cats).sort().forEach(c => {
                const div = document.createElement('div');
                div.className = 'gen-checkbox-item';
                div.innerHTML = `<input type="checkbox" name="gen_cat" value="${c}" checked> ${c}`;
                catList.appendChild(div);
            });
        }

        // Helper Shuffle (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function runGenerator() {
            if (typeof WORKOUT_DB === 'undefined') { alert("Database error"); return; }

            // 1. Get Settings
            const rounds = parseInt(document.getElementById('rounds').value);
            const exPerRound = parseInt(document.getElementById('exercises').value);
            const sets = parseInt(document.getElementById('sets').value);

            // 2. Get Filters & SHUFFLE THEM
            // Shuffling ensures we don't always start with "Bodyweight" if checked.
            let selectedMats = Array.from(document.querySelectorAll('input[name="gen_mat"]:checked')).map(cb => cb.value);
            let selectedCats = Array.from(document.querySelectorAll('input[name="gen_cat"]:checked')).map(cb => cb.value);

            selectedMats = shuffleArray(selectedMats);
            selectedCats = shuffleArray(selectedCats);

            if (selectedMats.length === 0 || selectedCats.length === 0) {
                alert("Selecteer ten minste 1 materiaal en 1 categorie.");
                return;
            }

            // 3. Clear existing custom names
            if (!confirm("Dit overschrijft alle handmatige aanpassingen in het schema. Doorgaan?")) return;
            customNames = {};

            // 4. Generation Loop
            const usedIds = new Set(); // To ensure uniqueness across the whole workout

            // Helper to get candidate
            const getCandidate = (mat, catList, excludeIds) => {
                let candidates = WORKOUT_DB.filter(item =>
                    item.material_name === mat &&
                    catList.includes(item.category) &&
                    !excludeIds.has(item.id)
                );

                if (candidates.length === 0) {
                    // Try relaxing the ID constraint if we ran out of exercises
                    // Use a slightly different shuffle for fallback to keep it random
                    let backupCandidates = WORKOUT_DB.filter(item =>
                        item.material_name === mat &&
                        catList.includes(item.category)
                    );
                    if (backupCandidates.length > 0) {
                        return shuffleArray(backupCandidates)[0];
                    }
                    return null;
                }

                return shuffleArray(candidates)[0];
            };

            // Logic:
            // We iterate Rounds -> Exercises.
            // Material Priority: The user list order. Ex 1 = Mat 1, Ex 2 = Mat 2... cycling.

            let r1Matrix = [];

            for (let r = 1; r <= rounds; r++) {
                let roundExList = []; // Store for this round

                if (r > 1 && genLogic.round === 'same') {
                    // Copy Round 1 Logic
                } else {
                    // Generate New Round
                    for (let e = 1; e <= exPerRound; e++) {
                        // Determine Material (Cyclic)
                        const matIndex = (e - 1) % selectedMats.length;
                        const targetMat = selectedMats[matIndex];

                        // Determine Sets
                        let exForSet1 = getCandidate(targetMat, selectedCats, usedIds);
                        let set1Name = exForSet1 ? exForSet1.exercise_name : `Geen Oefening (${targetMat})`;

                        if (exForSet1) usedIds.add(exForSet1.id);

                        let setNames = [];
                        setNames.push(set1Name);

                        for (let s = 2; s <= sets; s++) {
                            if (genLogic.set === 'same') {
                                setNames.push(set1Name);
                            } else {
                                let exNext = getCandidate(targetMat, selectedCats, usedIds);
                                let nextName = exNext ? exNext.exercise_name : `Geen Oefening (${targetMat})`;
                                if (exNext) usedIds.add(exNext.id);
                                setNames.push(nextName);
                            }
                        }
                        roundExList.push(setNames);
                    }

                    if (r === 1) r1Matrix = roundExList;
                }

                // Apply to customNames
                for (let e = 1; e <= exPerRound; e++) {
                    for (let s = 1; s <= sets; s++) {
                        let finalName = "";
                        if (genLogic.round === 'same') {
                            // Use R1
                            if (r1Matrix[e - 1] && r1Matrix[e - 1][s - 1]) finalName = r1Matrix[e - 1][s - 1];
                        } else {
                            // Use Generated
                            if (roundExList[e - 1] && roundExList[e - 1][s - 1]) finalName = roundExList[e - 1][s - 1];
                        }

                        if (finalName) {
                            const key = `r${r}-e${e}-s${s}`;
                            customNames[key] = finalName;
                        }
                    }
                }
            }

            saveToLocal();
            closeGeneratorModal();
            showScheduleModal(); // Show result
        }

        async function shareSchedulePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Title
                doc.setFontSize(18);
                doc.text("Friday Night Hawks Training", 14, 20);
                doc.setFontSize(10);
                doc.text(`Gegenereerd op: ${new Date().toLocaleString('nl-NL')}`, 14, 26);

                const tableData = [];
                let currentTime = new Date();

                schedule.forEach(step => {
                    if (step.type === 'finish') return;

                    const timeStr = currentTime.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

                    let exName = step.label;
                    let detailsText = "";
                    let videoLink = "";
                    let shortsLink = "";

                    if (step.type === 'work' && step.info.exercise > 0) {
                        const details = getExerciseDetails(exName);
                        if (details) {
                            const matName = details.material_name || "-";
                            const matDesc = details.material_description || "";
                            const instr = details.instructions || "";

                            detailsText = `MATERIAAL: ${matName}\n\n${matDesc}\n\nINSTRUCTIE:\n${instr}`;

                            // Links
                            const vidUrl = details.video_search_url || "";
                            videoLink = vidUrl ? vidUrl : `https://www.youtube.com/results?search_query=${encodeURIComponent(exName + " shorts")}`;
                            shortsLink = `https://www.youtube.com/results?search_query=${encodeURIComponent(exName + " " + matName + " workout shorts")}`;
                        }
                    } else {
                        detailsText = step.label;
                        if (step.info && step.info.round) detailsText += ` (R${step.info.round}/E${step.info.exercise})`;
                    }

                    tableData.push([timeStr, exName, detailsText, { video: videoLink, shorts: shortsLink }]);
                    currentTime.setSeconds(currentTime.getSeconds() + step.time);
                });

                // Generate Table Data for PDF
                // We map the rich data to a format suitable for the PDF table, including clickable links.

                const finalBody = tableData.map(row => {
                    const linkObj = row[3];
                    let linkText = "";
                    if (linkObj.video) linkText += "VIDEO";
                    if (linkObj.shorts) linkText += (linkText ? "\n\n" : "") + "SHORTS";
                    // Pass object to preserve link data in cell.raw
                    return [row[0], row[1], row[2], { content: linkText, links: linkObj }];
                });

                doc.autoTable({
                    head: [['Tijd', 'Oefening', 'Details', 'Links']],
                    body: finalBody,
                    startY: 35,
                    styles: { fontSize: 8, cellPadding: 3, overflow: 'linebreak' },
                    columnStyles: {
                        0: { cellWidth: 20 },
                        1: { cellWidth: 35, fontStyle: 'bold' },
                        2: { cellWidth: 'auto' },
                        3: { cellWidth: 25, halign: 'center', textColor: [10, 132, 255] }
                    },
                    didDrawCell: function (data) {
                        if (data.column.index === 3 && data.cell.section === 'body') {
                            // Safely access embedded link data
                            const raw = data.cell.raw;
                            if (raw && raw.links && (raw.links.video || raw.links.shorts)) {
                                const linkObj = raw.links;
                                const x = data.cell.x;
                                const y = data.cell.y;
                                const w = data.cell.width;
                                const h = data.cell.height;

                                // Link Areas
                                if (linkObj.video) {
                                    doc.link(x, y, w, h / 2, { url: linkObj.video });
                                }
                                if (linkObj.shorts) {
                                    doc.link(x, y + h / 2, w, h / 2, { url: linkObj.shorts });
                                }
                            }
                        }
                    }
                });

                const pdfBlob = doc.output('blob');
                const file = new File([pdfBlob], "fnh_schema.pdf", { type: "application/pdf" });

                if (navigator.share) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'FNH Training Schema',
                            text: 'Hier is het schema voor vanavond!'
                        });
                    } catch (err) {
                        console.log("Share failed or cancelled", err);
                        doc.save("fnh_schema.pdf");
                    }
                } else {
                    doc.save("fnh_schema.pdf");
                }
            } catch (error) {
                console.error("PDF Error:", error);
                alert("Er is een fout opgetreden bij het maken van de PDF:\n" + error.message);
            }
        }

        function shareApp() {
            const cleanUrl = window.location.origin + window.location.pathname;
            let text = "ü¶Ö **Friday Night Hawks Timer**\n\n";
            text += "üèÜ **Uniek:** Jij bepaalt de EINDTIJD üèÅ. De app berekent automatisch de werk- en rusttijden zodat je precies op tijd klaar bent!\n\n";
            text += "De ultieme trainingspartner voor de vrijdagavond! üö¥üèãÔ∏èüèä\n";
            text += "Sluit af met bitterballen & gezelligheid! üçñ\n\n";
            text += "‚úÖ **Wat kan deze app?**\n";
            text += "- üó£Ô∏è Volledige spraakbegeleiding (NL)\n";
            text += "- ‚è±Ô∏è Slimme tijd- & rustberekening\n";
            text += "- üîÑ 'Crash Recovery': Hervat direct na uitval\n";
            text += "- üé® Volledig aanpasbare commando's\n\n";
            text += "üëá Download/Gebruik de app hier (gratis):";
            if (navigator.share) { navigator.share({ title: "Friday Night Hawks Timer ü¶Ö", text: text, url: cleanUrl }).catch(console.error); }
            else { navigator.clipboard.writeText(text + "\n" + cleanUrl).then(() => alert("Promotietekst en link gekopieerd!")); }
        }

        function shareSettings() {
            const rounds = document.getElementById('rounds').value; const exercises = document.getElementById('exercises').value; const sets = document.getElementById('sets').value;
            const restSec = document.getElementById('restSec').value; const exerciseRestSec = document.getElementById('exerciseRestSec').value; const roundRestSec = document.getElementById('roundRestSec').value;
            const totalMin = document.getElementById('totalMin').value;
            const params = new URLSearchParams();
            params.set('r', rounds); params.set('e', exercises); params.set('s', sets);
            params.set('rs', restSec); params.set('re', exerciseRestSec); params.set('rr', roundRestSec); params.set('tm', totalMin);
            for (const [key, value] of Object.entries(speechSettings)) { if (value.text) { params.set(key, value.text); } }
            const baseUrl = window.location.origin + window.location.pathname; const shareUrl = baseUrl + '?' + params.toString();
            if (navigator.share) { navigator.share({ title: 'FNH Training Settings', url: shareUrl }).catch(console.error); }
            else { navigator.clipboard.writeText(shareUrl).then(() => { alert("Link met instellingen gekopieerd!"); }); }
        }

        function checkForSharedSettings() {
            const params = new URLSearchParams(window.location.search);
            let dataUpdated = false;
            if (params.has('r')) {
                document.getElementById('rounds').value = params.get('r'); document.getElementById('exercises').value = params.get('e'); document.getElementById('sets').value = params.get('s');
                document.getElementById('restSec').value = params.get('rs'); document.getElementById('exerciseRestSec').value = params.get('re'); document.getElementById('roundRestSec').value = params.get('rr');
                document.getElementById('totalMin').value = params.get('tm'); dataUpdated = true;
            }
            let speechUpdated = false;
            for (const key in speechSettings) { if (params.has(key)) { speechSettings[key].text = params.get(key); speechUpdated = true; dataUpdated = true; } }
            if (speechUpdated) { const dropdown = document.getElementById('coach-preset'); if (dropdown) { dropdown.value = 'custom'; dropdown.querySelector('option[value="custom"]').removeAttribute('hidden'); dropdown.querySelector('option[value="custom"]').removeAttribute('disabled'); } }
            if (dataUpdated) { syncTime('duration'); saveToLocal(); }
        }

        function saveToLocal() {
            const data = {
                rounds: document.getElementById('rounds').value, exercises: document.getElementById('exercises').value, sets: document.getElementById('sets').value,
                restSec: document.getElementById('restSec').value, exerciseRestSec: document.getElementById('exerciseRestSec').value, roundRestSec: document.getElementById('roundRestSec').value,
                totalMin: document.getElementById('totalMin').value, audioMode: audioMode,
                speechSettings: speechSettings, // v1.16: Restore Save
                startTimeValue: document.getElementById('startTimeValue').value, // NEW
                coachPreset: document.getElementById('coach-preset').value, // Save Coach Selection
                startRound: document.getElementById('start-round').value, startEx: document.getElementById('start-ex').value, startSet: document.getElementById('start-set').value,
                iosMixMode: iosMixMode, // Save Mix Mode setting
                // Save 3 Bonuses
                bonus1: { name: document.getElementById('bonus1-name').value, dur: document.getElementById('bonus1-duration').value, freq: document.getElementById('bonus1-freq').value },
                bonus2: { name: document.getElementById('bonus2-name').value, dur: document.getElementById('bonus2-duration').value, freq: document.getElementById('bonus2-freq').value },
                bonus3: { name: document.getElementById('bonus3-name').value, dur: document.getElementById('bonus3-duration').value, freq: document.getElementById('bonus3-freq').value },
                // Save Custom Names
                customNames: customNames
            };
            localStorage.setItem('fnh_settings_v8', JSON.stringify(data));
        }

        function loadFromLocal() {
            const saved = localStorage.getItem('fnh_settings_v8');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('rounds').value = data.rounds || 2; document.getElementById('exercises').value = data.exercises || 6; document.getElementById('sets').value = data.sets || 2;
                    document.getElementById('restSec').value = data.restSec || 20; document.getElementById('exerciseRestSec').value = data.exerciseRestSec || 30; document.getElementById('roundRestSec').value = data.roundRestSec || 90;
                    document.getElementById('totalMin').value = data.totalMin || 30;
                    if (data.startTimeValue) document.getElementById('startTimeValue').value = data.startTimeValue;
                    if (data.startRound) document.getElementById('start-round').value = data.startRound;
                    if (data.startEx) document.getElementById('start-ex').value = data.startEx;
                    if (data.startSet) document.getElementById('start-set').value = data.startSet;

                    if (data.bonus1) { document.getElementById('bonus1-name').value = data.bonus1.name; document.getElementById('bonus1-duration').value = data.bonus1.dur; document.getElementById('bonus1-freq').value = data.bonus1.freq; }
                    if (data.bonus2) { document.getElementById('bonus2-name').value = data.bonus2.name; document.getElementById('bonus2-duration').value = data.bonus2.dur; document.getElementById('bonus2-freq').value = data.bonus2.freq; }
                    if (data.bonus3) { document.getElementById('bonus3-name').value = data.bonus3.name; document.getElementById('bonus3-duration').value = data.bonus3.dur; document.getElementById('bonus3-freq').value = data.bonus3.freq; }

                    if (data.customNames) customNames = data.customNames;

                    // Restore Coach Preset
                    if (data.coachPreset) {
                        const sel = document.getElementById('coach-preset');
                        // Only set if option exists
                        if (sel.querySelector(`option[value="${data.coachPreset}"]`)) {
                            sel.value = data.coachPreset;
                        }
                    }

                    if (data.audioMode) setAudioMode(data.audioMode);
                    // v1.16: Restore speechSettings load
                    if (data.speechSettings) {
                        for (const key in speechSettings) {
                            if (data.speechSettings[key]) {
                                speechSettings[key].enabled = data.speechSettings[key].enabled;
                            }
                        }
                        // Also Add keys that might be in data but not in current preset (though standardizing via uiConfig is better)
                        for (const key in data.speechSettings) {
                            if (!speechSettings[key]) speechSettings[key] = data.speechSettings[key];
                        }
                    }
                } catch (e) { console.log("Error loading settings", e); }
            }
        }

        function setAudioMode(newMode) {
            audioMode = newMode;
            document.getElementById('btn-audio-speech').className = (audioMode === 'speech') ? 'toggle-btn active' : 'toggle-btn';
            document.getElementById('btn-audio-beep').className = (audioMode === 'beep') ? 'toggle-btn active' : 'toggle-btn';
            renderAudioToggles(); // Re-render when mode changes
        }

        function calculateRealTime() {
            const rounds = parseInt(document.getElementById('rounds').value) || 1; const ex = parseInt(document.getElementById('exercises').value) || 0; const sts = parseInt(document.getElementById('sets').value) || 0;
            const rst = parseInt(document.getElementById('restSec').value) || 0; const exRst = parseInt(document.getElementById('exerciseRestSec').value) || 0; const roundRst = parseInt(document.getElementById('roundRestSec').value) || 0;
            const startRound = parseInt(document.getElementById('start-round').value) || 1; const startEx = parseInt(document.getElementById('start-ex').value) || 1; const startSet = parseInt(document.getElementById('start-set').value) || 1;

            if (ex === 0 || sts === 0 || rounds === 0) return;

            let remainingWorkSets = 0; let remainingFixedRestTime = 0;

            // BONUS LOGIC CALCULATION (Loop 3 bonuses)
            // Warmup Check (Start of Session)
            for (let b = 1; b <= 3; b++) {
                const bMin = parseInt(document.getElementById(`bonus${b}-duration`).value) || 0;
                const bFreq = document.getElementById(`bonus${b}-freq`).value;
                if (bMin > 0 && bFreq === 'warmup') {
                    if (startRound === 1 && startEx === 1 && startSet === 1) {
                        remainingFixedRestTime += (bMin * 60) + exRst;
                    }
                }
            }

            // Toetje Check (End of Session)
            for (let b = 1; b <= 3; b++) {
                const bMin = parseInt(document.getElementById(`bonus${b}-duration`).value) || 0;
                const bFreq = document.getElementById(`bonus${b}-freq`).value;
                if (bMin > 0 && bFreq === 'end_session') {
                    // Toetje NO REST after
                    remainingFixedRestTime += (bMin * 60) + exRst; // Added exRst here to account for the "switch" after bonus
                }
            }

            let globalExCount = 0;

            for (let r = 1; r <= rounds; r++) {

                // Start Round Check
                // Start Round Check
                for (let b = 1; b <= 3; b++) {
                    const bonus = getBonusData(b);
                    if (bonus.min > 0 && bonus.freq === 'start_round') {
                        if (r >= startRound) {
                            if (r > startRound || (r === startRound && startEx === 1 && startSet === 1)) {
                                remainingFixedRestTime += (bonus.min * 60) + exRst;
                            }
                        }
                    }
                }

                for (let e = 1; e <= ex; e++) {
                    globalExCount++;

                    // Interval Check
                    // Interval Check
                    for (let b = 1; b <= 3; b++) {
                        const bonus = getBonusData(b);
                        if (bonus.min > 0 && !isNaN(bonus.freq) && (globalExCount % parseInt(bonus.freq) === 0)) {
                            let isFuture = false;
                            if (r > startRound) isFuture = true; else if (r === startRound && e > startEx) isFuture = true; else if (r === startRound && e === startEx && sts >= startSet) isFuture = true;
                            if (isFuture) remainingFixedRestTime += (bonus.min * 60) + exRst;
                        }
                    }

                    for (let s = 1; s <= sts; s++) {
                        let isFuture = false; if (r > startRound) isFuture = true; else if (r === startRound && e > startEx) isFuture = true; else if (r === startRound && e === startEx && s >= startSet) isFuture = true;
                        if (isFuture) {
                            remainingWorkSets++;
                            const isLastSetOfWorkout = (r === rounds && e === ex && s === sts); const isLastSetOfRound = (e === ex && s === sts); const isLastSetOfExercise = (s === sts);
                            if (!isLastSetOfWorkout) { if (isLastSetOfRound) remainingFixedRestTime += roundRst; else if (isLastSetOfExercise) remainingFixedRestTime += exRst; else remainingFixedRestTime += rst; }
                        }
                    }
                }

                // End Round Check
                // End Round Check
                for (let b = 1; b <= 3; b++) {
                    const bonus = getBonusData(b);
                    if (bonus.min > 0 && bonus.freq === 'end_round') {
                        let include = true;
                        if (r >= startRound) {
                            if (r > startRound || (r === startRound)) { // Loose check for end of round
                                remainingFixedRestTime += (bonus.min * 60) + exRst;
                            }
                        }
                    }
                }
            }
            remainingFixedRestTime += 10;

            let availableSec = 0;
            const startStr = document.getElementById('startTimeValue').value;
            const endStr = document.getElementById('endTimeValue').value;

            if (endStr) {
                const now = new Date();
                let base = now;
                if (startStr) {
                    const [sh, sm] = startStr.split(':');
                    base = new Date();
                    base.setHours(sh, sm, 0, 0);
                }

                const [h, m] = endStr.split(':');
                const target = new Date();
                target.setHours(h, m, 0, 0);

                if (target < base) target.setDate(target.getDate() + 1);
                availableSec = Math.floor((target - base) / 1000);
            }

            const workSecTotal = availableSec - remainingFixedRestTime;
            const btnEl = document.getElementById('btn-start-app'); const errEl = document.getElementById('live-calc-error'); const resEl = document.getElementById('live-calc-result');

            if (workSecTotal <= 0 || remainingWorkSets <= 0) {
                resEl.innerText = "--"; errEl.style.display = "block"; btnEl.style.opacity = 0.5; btnEl.disabled = true; workTimeSec = 0;
                document.getElementById('preview-list').innerHTML = "<div style='padding:10px; color:#555;'>Geen schema mogelijk</div>";
            } else {
                workTimeSec = Math.floor(workSecTotal / remainingWorkSets);
                resEl.innerText = workTimeSec + "s"; errEl.style.display = "none"; btnEl.style.opacity = 1; btnEl.disabled = false;
                restTimeSec = rst; exerciseRestSec = exRst; roundRestSec = roundRst;
                generateScheduleData(true); renderPreviewList();
            }
        }



        function generateScheduleData(applyResumeFilter) {
            const rounds = parseInt(document.getElementById('rounds').value); const ex = parseInt(document.getElementById('exercises').value); const sts = parseInt(document.getElementById('sets').value);
            const startRound = parseInt(document.getElementById('start-round').value); const startEx = parseInt(document.getElementById('start-ex').value); const startSet = parseInt(document.getElementById('start-set').value);
            const exerciseRestSec = parseInt(document.getElementById('exerciseRestSec').value);

            totalWorkSetsGlobal = rounds * ex * sts; let currentSetGlobal = 0;
            schedule = []; schedule.push({ type: 'prep', time: 15, label: "Voorbereiden", initialTime: 15, info: { round: 1, exercise: 1, set: 1, maxRounds: rounds, maxEx: ex, maxSets: sts } });

            // Using global getBonusData helper now

            // WARMUP BONUS (Check all 3)
            for (let b = 1; b <= 3; b++) {
                const bonus = getBonusData(b);
                if (bonus.min > 0 && bonus.freq === 'warmup') {
                    if (!applyResumeFilter || (startRound === 1 && startEx === 1 && startSet === 1)) {
                        addBonusStep(0, bonus.name.toUpperCase(), bonus.min * 60, exerciseRestSec, bonus.id);
                    }
                }
            }

            let globalExCount = 0;

            for (let r = 1; r <= rounds; r++) {

                // START ROUND BONUS
                for (let b = 1; b <= 3; b++) {
                    const bonus = getBonusData(b);
                    if (bonus.min > 0 && bonus.freq === 'start_round') {
                        let include = true;
                        if (applyResumeFilter) {
                            if (r < startRound) include = false;
                            else if (r === startRound && (startEx > 1 || startSet > 1)) include = false;
                        }
                        if (include) addBonusStep(r, bonus.name.toUpperCase(), bonus.min * 60, exerciseRestSec, bonus.id);
                    }
                }

                for (let e = 1; e <= ex; e++) {
                    globalExCount++;

                    // INTERVAL BONUS
                    for (let b = 1; b <= 3; b++) {
                        const bonus = getBonusData(b);
                        if (bonus.min > 0 && !isNaN(bonus.freq) && (globalExCount % parseInt(bonus.freq) === 0)) {
                            let include = true;
                            if (applyResumeFilter) { if (r < startRound) include = false; else if (r === startRound && e < startEx) include = false; else if (r === startRound && e === startEx && sts < startSet) include = false; }

                            if (include) addBonusStep(r, bonus.name.toUpperCase(), bonus.min * 60, exerciseRestSec, bonus.id);
                        }
                    }

                    for (let s = 1; s <= sts; s++) {
                        currentSetGlobal++; let include = true;
                        if (applyResumeFilter) { if (r < startRound) include = false; else if (r === startRound && e < startEx) include = false; else if (r === startRound && e === startEx && s < startSet) include = false; }
                        if (include) {
                            // CHECK FOR CUSTOM NAME
                            // Hierarchy: Specific Set > Round Exercise > All Round Exercise (handled by apply)
                            let label = `Oefening ${e}.${s}`;
                            const keySet = `r${r}-e${e}-s${s}`;
                            const keyRound = `r${r}-e${e}`;

                            if (customNames[keySet]) label = customNames[keySet];
                            else if (customNames[keyRound]) label = customNames[keyRound];

                            schedule.push({ type: 'work', time: workTimeSec, initialTime: workTimeSec, label: label, info: { round: r, exercise: e, set: s, maxRounds: rounds, maxEx: ex, maxSets: sts, globalSet: currentSetGlobal } });
                            const isLastSetOfWorkout = (r === rounds && e === ex && s === sts); const isLastSetOfRound = (e === ex && s === sts); const isLastSetOfExercise = (s === sts);
                            if (!isLastSetOfWorkout) {
                                let restLabel = "RUST"; let infoText = "";
                                if (isLastSetOfRound) { restLabel = "RONDE PAUZE"; infoText = "Even bijkomen..."; }
                                else if (isLastSetOfExercise) { restLabel = "WISSEL OEFENING"; infoText = `Op naar oefening ${e < ex ? e + 1 : 1}`; }
                                else { infoText = "Even ontspannen"; }
                                let type = isLastSetOfRound ? 'rest-long' : (isLastSetOfExercise ? 'rest-exercise' : 'rest');
                                schedule.push({ type: type, time: (isLastSetOfRound ? roundRestSec : (isLastSetOfExercise ? exerciseRestSec : restTimeSec)), initialTime: (isLastSetOfRound ? roundRestSec : (isLastSetOfExercise ? exerciseRestSec : restTimeSec)), label: restLabel, info: { round: r, exercise: e, set: s, maxRounds: rounds, maxEx: ex, maxSets: sts, text: infoText } });
                            }
                        }
                    }
                }

                // END ROUND BONUS
                for (let b = 1; b <= 3; b++) {
                    const bonus = getBonusData(b);
                    if (bonus.min > 0 && bonus.freq === 'end_round') {
                        let include = true;
                        if (applyResumeFilter && r < startRound) include = false;
                        if (include) addBonusStep(r, bonus.name.toUpperCase(), bonus.min * 60, exerciseRestSec, bonus.id);
                    }
                }
            }

            // TOETJE BONUS
            for (let b = 1; b <= 3; b++) {
                const bonus = getBonusData(b);
                if (bonus.min > 0 && bonus.freq === 'end_session') {
                    // TOETJE has NO rest/switch after!
                    schedule.push({
                        type: 'work',
                        time: bonus.min * 60,
                        initialTime: bonus.min * 60,
                        label: bonus.name.toUpperCase(),
                        info: { round: 0, exercise: 0, set: 0, globalSet: 0, bonusId: bonus.id }
                    });
                }
            }

            if (schedule.length > 1) schedule.push({ type: 'finish', time: 0, label: "KLAAR!", initialTime: 0, info: { text: "Goed gewerkt!" } }); else schedule = [];
        }

        function playMp3WebAudio(url, key) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Check Cache
            if (audioCache[url]) {
                logAudioDebug(`‚úÖ WebAudio Cache: ${key}`);
                playBuffer(audioCache[url]);
                return;
            }

            // Fetch
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("404");
                    return response.arrayBuffer();
                })
                .then(arrayBuffer => audioCtx.decodeAudioData(arrayBuffer))
                .then(audioBuffer => {
                    audioCache[url] = audioBuffer;
                    logAudioDebug(`‚úÖ WebAudio Play: ${key}`);
                    playBuffer(audioBuffer);
                })
                .catch(e => {
                    failedAudioKeys.add(key);
                    logAudioDebug(`‚ùå WebAudio Fail: ${key}`);
                    console.error("WebAudio Error", e);
                });
        }

        function playBuffer(buffer) {
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;

            // VOLUME BOOST (for Mix Mode)
            // Since we cannot "duck" (lower) the background music on iOS,
            // we digitally boost the voice volume to 250% to cut through.
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = 2.5;

            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            source.start(0);
        }

        function addBonusStep(r, label, time, rest, bId) {
            schedule.push({
                type: 'work',
                time: time,
                initialTime: time,
                label: label,
                info: { round: r, exercise: 0, set: 0, globalSet: 0, bonusId: bId } // 0 indicates bonus
            });
            schedule.push({
                type: 'rest-exercise',
                time: rest,
                initialTime: rest,
                label: "WISSEL",
                info: { round: r, exercise: 0, set: 0, text: "Klaarmaken..." }
            });
        }

        function renderPreviewList() {
            const list = document.getElementById('preview-list'); list.innerHTML = ""; let runningDate = new Date();
            schedule.forEach((item) => {
                if (item.type === 'finish') return;
                let timeStr = runningDate.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                runningDate.setSeconds(runningDate.getSeconds() + item.time);
                const div = document.createElement('div'); div.className = `schedule-item`;
                let icon = ""; if (item.type === 'rest-long') { div.style.borderLeft = "4px solid #0A84FF"; icon = '‚òï'; } else if (item.type === 'rest-exercise') { div.style.borderLeft = "4px solid #BF5AF2"; icon = 'üîÄ'; } else if (item.type === 'work') icon = 'üî•'; else if (item.type === 'rest') icon = 'üí§'; else icon = 'üöÄ';
                let desc = item.label; if (item.info && item.info.round && item.info.exercise > 0) desc += ` (R${item.info.round}/E${item.info.exercise}/S${item.info.set})`;
                div.innerHTML = `<div class="col-time">${timeStr}</div><div class="col-desc">${icon} ${desc}</div><div class="col-dur">${item.time}s</div>`;
                list.appendChild(div);
            });
        }

        function triggerAudio(key, fallbackText, extraInfo = "") {
            try {
                if (audioMode === 'beep') { if (key.includes('work')) playBeep(800, 'start'); else if (key.includes('rest')) playBeep(400, 'end'); else if (key === 'tick') playBeep(600, 'tick'); else if (key === 'finish') playBeep(1000, 'win'); return; }

                // MP3 Support Logic (SIMPLIFIED v1.15 / TOGGLES v1.16)
                const coachId = document.getElementById('coach-preset').value || 'tabataman';

                // Check Enable/Disable Toggle provided by user
                if (speechSettings[key] && speechSettings[key].enabled === false) {
                    logAudioDebug(`üîá Silenced by user setting: ${key}`);
                    return;
                }

                if (coachId && coachId !== 'loading' && !failedAudioKeys.has(key)) {
                    logAudioDebug(`üéµ Attempting MP3: ${coachId}/${key}.mp3`);
                    const mp3Path = `coaches/${coachId}/${key}.mp3`;

                    // OPTIONAL MIX MODE (iOS Web Audio)
                    if (iosMixMode) {
                        playMp3WebAudio(mp3Path, key);
                        return;
                    }

                    // Standard HTML5 Audio (Single Global Object)
                    globalCoachAudio.src = mp3Path;

                    const playPromise = globalCoachAudio.play();

                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            logAudioDebug(`‚úÖ Playing MP3: ${key}`);
                        })
                            .catch(error => {
                                failedAudioKeys.add(key); // Mark as missing/broken
                                logAudioDebug(`‚ùå MP3 Failed: ${key}`);
                            });
                    }
                    return;
                }
            } catch (e) {
                console.error("Audio Trigger Error", e);
                logAudioDebug(`‚ö†Ô∏è Audio Error: ${e.message}`);
            }
        }

        function logAudioDebug(msg) {
            const loginfo = document.getElementById('audio-debug-log');
            if (loginfo) {
                const line = document.createElement('div');
                const time = new Date().toLocaleTimeString('nl-NL', { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
                line.innerText = `[${time}] ${msg}`;
                loginfo.prepend(line);
                // Keep only last 20 lines
                while (loginfo.children.length > 20) {
                    loginfo.removeChild(loginfo.lastChild);
                }
            }
        }

        function playBeep(f, t) { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; o.type = 'sine'; const n = audioCtx.currentTime; if (t === 'tick') { g.gain.setValueAtTime(0.1, n); o.start(n); o.stop(n + 0.1); } else if (t === 'win') { g.gain.setValueAtTime(0.1, n); o.start(n); o.stop(n + 0.2); setTimeout(() => playBeep(1200, 'tick'), 300); } else { g.gain.setValueAtTime(0.3, n); o.start(n); o.stop(n + 0.5); } }

        let preWorkoutInterval = null;

        function startWorkout() {
            // Audio Context for Beep Mode (Ensure resumed)
            if (audioMode === 'beep') { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); audioCtx.resume(); }

            const startStr = document.getElementById('startTimeValue').value;
            if (startStr) {
                const now = new Date();
                const [h, m] = startStr.split(':');
                const targetStart = new Date();
                targetStart.setHours(h, m, 0, 0);

                if (targetStart > now) {
                    // Show Countdown Overlay
                    const overlay = document.getElementById('pre-workout-overlay');
                    const timerEl = document.getElementById('pre-workout-timer');
                    const startInfoEl = document.getElementById('pre-workout-start-time'); // NEW

                    overlay.style.display = 'flex';
                    if (startInfoEl) startInfoEl.innerText = `STARTTIJD: ${startStr}`;

                    // Initial wake lock attempt (user interaction context)
                    if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(console.log);

                    clearInterval(preWorkoutInterval);

                    const updateTimer = () => {
                        const currentNow = new Date();
                        const diffMs = targetStart - currentNow;

                        if (diffMs <= 0) {
                            clearInterval(preWorkoutInterval);
                            overlay.style.display = 'none';
                            performStart();
                            return;
                        }

                        // Format MM:SS
                        const totalSec = Math.ceil(diffMs / 1000);
                        const mins = Math.floor(totalSec / 60);
                        const secs = totalSec % 60;
                        timerEl.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    };

                    updateTimer(); // Immediate update
                    preWorkoutInterval = setInterval(updateTimer, 1000);
                    return;
                }
            }
            // No delay needed
            performStart();
        }

        function performStart() {
            // Hide overlay if manual skip was triggered
            document.getElementById('pre-workout-overlay').style.display = 'none';
            if (preWorkoutInterval) clearInterval(preWorkoutInterval);
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(console.log);
            if (audioMode === 'beep') { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); } else { if (window.speechSynthesis) window.speechSynthesis.cancel(); }

            clearInterval(timerInterval); // Ensure no previous timer is running

            // Ensure times are fresh
            calculateRealTime();
            generateScheduleData(true);
            populateJumpMenus();

            document.getElementById('setup-screen').classList.add('hidden');
            // Scroll Fix v1.9: Use block display for reliable scrolling
            // Reset style completely to remove !important inline hider
            const ts = document.getElementById('timer-screen');
            ts.style.cssText = '';
            ts.style.display = 'block';

            workoutStartTime = new Date();
            const [h, m] = document.getElementById('endTimeValue').value.split(':');
            targetEndTimeDate = new Date(); targetEndTimeDate.setHours(h, m, 0, 0);
            if (targetEndTimeDate < workoutStartTime) targetEndTimeDate.setDate(targetEndTimeDate.getDate() + 1);

            updateEndTimeDisplay();
            currentIndex = 0;
            // speechPlaylists = {}; // REMOVED v1.15
            failedAudioKeys.clear(); // Reset MP3 failures on new workout start
            stepEndTime = Date.now() + (schedule[0].time * 1000);

            // NEW: Render Live Schedule
            renderLiveSchedule();

            runStep();
        }

        function populateJumpMenus() {
            const rounds = parseInt(document.getElementById('rounds').value); const ex = parseInt(document.getElementById('exercises').value); const sets = parseInt(document.getElementById('sets').value);
            const rSel = document.getElementById('jump-round'); const eSel = document.getElementById('jump-exercise'); const sSel = document.getElementById('jump-set');
            rSel.innerHTML = ""; eSel.innerHTML = ""; sSel.innerHTML = "";
            for (let i = 1; i <= rounds; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = "Ronde " + i; rSel.appendChild(opt); }
            for (let i = 1; i <= ex; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = "Oef " + i; eSel.appendChild(opt); }
            for (let i = 1; i <= sets; i++) { const opt = document.createElement('option'); opt.value = i; opt.text = "Set " + i; sSel.appendChild(opt); }
        }

        function handleJump() {
            const r = parseInt(document.getElementById('jump-round').value); const e = parseInt(document.getElementById('jump-exercise').value); const s = parseInt(document.getElementById('jump-set').value);
            const newIndex = schedule.findIndex(step => { return step.type === 'work' && step.info && step.info.round === r && step.info.exercise === e && step.info.set === s; });
            if (newIndex > -1) {
                currentIndex = newIndex;
                triggerAudio('manual_override', "Springen naar ronde " + r);
                stepEndTime = Date.now();
                // Reset played flags when jumping
                schedule.forEach(s => delete s.hasPlayedEntry);
                runStep();
                recalculateForFixedEnd();
            }
        }

        function runStep() {
            if (currentIndex >= schedule.length) return;
            const step = schedule[currentIndex];
            const nextStep = schedule[currentIndex + 1];
            const totalRounds = parseInt(document.getElementById('rounds').value);
            const totalEx = document.getElementById('exercises').value;

            const body = document.body; body.className = '';
            const titleEl = document.getElementById('gym-phase-title'); const nextEl = document.getElementById('gym-next-info');

            if (step.info && step.info.maxRounds) {
                document.getElementById('val-round').innerText = `${step.info.round}/${step.info.maxRounds}`;
                // Only show exercise/set if not 0 (extra phase)
                if (step.info.exercise > 0) {
                    document.getElementById('val-exercise').innerText = `${step.info.exercise}/${step.info.maxEx}`;
                    document.getElementById('val-set').innerText = `${step.info.set}/${step.info.maxSets}`;
                    document.getElementById('jump-round').value = step.info.round; document.getElementById('jump-exercise').value = step.info.exercise; document.getElementById('jump-set').value = step.info.set;
                } else {
                    document.getElementById('val-exercise').innerText = "-";
                    document.getElementById('val-set').innerText = "-";
                }
                document.getElementById('gym-stats-container').style.opacity = 1;
            } else { document.getElementById('gym-stats-container').style.opacity = 0.5; }

            // NEW: Update Live Schedule Highlight
            updateLiveScheduleHighlight();

            // Dynamic Inner Ring Color (based on NEXT step)
            let nextColor = '#30D158'; // Default Green (Work)
            let nextGlow = 'rgba(48, 209, 88, 0.6)';
            if (nextStep) {
                if (nextStep.type === 'work') { nextColor = '#30D158'; nextGlow = 'rgba(48, 209, 88, 0.6)'; }
                else if (nextStep.type === 'rest') { nextColor = '#FF9F0A'; nextGlow = 'rgba(255, 159, 10, 0.6)'; }
                else if (nextStep.type === 'rest-exercise') { nextColor = '#BF5AF2'; nextGlow = 'rgba(191, 90, 242, 0.6)'; }
                else if (nextStep.type === 'rest-long') { nextColor = '#0A84FF'; nextGlow = 'rgba(10, 132, 255, 0.6)'; }
                else if (nextStep.type === 'finish') { nextColor = '#FFD60A'; nextGlow = 'rgba(255, 214, 10, 0.6)'; }
                else if (nextStep.type === 'prep') { nextColor = '#3a3a3c'; nextGlow = 'rgba(58, 58, 60, 0.6)'; }
            } else {
                nextColor = '#FFD60A'; nextGlow = 'rgba(255, 214, 10, 0.6)';
            }

            const ringStep = document.getElementById('ring-step');
            if (ringStep) {
                ringStep.style.stroke = nextColor;
                ringStep.style.filter = `drop-shadow(0 0 10px ${nextGlow})`;
            }

            titleEl.innerText = step.label;
            titleEl.className = 'gym-phase-title';
            if (step.label === 'WERKEN' || step.label === 'RUST' || step.type === 'work') {
                // Make huge text for main work phases (including custom extra name)
                titleEl.classList.add('huge-text');
            }

            let nextText = "Hierna: Klaar";
            if (nextStep) { nextText = "Hierna: " + nextStep.label; if (nextStep.type === 'work' && nextStep.info && nextStep.info.exercise > 0) nextText += ` (Oef ${nextStep.info.exercise})`; }
            nextEl.innerText = nextText;

            if (!step.hasPlayedEntry) {
                step.hasPlayedEntry = true;
                if (step.type === 'work') {
                    body.classList.add('mode-work');
                    // Standard work audio triggers
                    if (step.info.exercise > 0) {
                        if (step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.25)) triggerAudio('mile_start', "Goede start");
                        else if (step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.5)) triggerAudio('mile_half', "Helft");
                        else if (step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.75)) triggerAudio('mile_end', "Eindsprint");
                        else if (step.info.globalSet === Math.ceil(totalWorkSetsGlobal * 0.75)) triggerAudio('mile_end', "Eindsprint");
                        else if (totalRounds > 1 && step.info.round === totalRounds && step.info.set === 1 && step.info.exercise === 1) triggerAudio('mile_lastround', "Laatste ronde");
                        else triggerAudio('work_start', "Start");
                    } else {
                        // Custom Extra Start Audio
                        triggerAudio('work_start', `Start ${step.label}`);
                    }
                }
                else if (step.type === 'rest') {
                    body.classList.add('mode-rest');
                    let info = ""; if (speechSettings.rest_set_tips.enabled) { const tips = ["Adem in, adem uit", "Schud je spieren los", "Slokje water", "Blijf gefocust"]; info = tips[Math.floor(Math.random() * tips.length)]; }
                    triggerAudio('rest_set_start', "Rust", info);
                }
                else if (step.type === 'rest-exercise') {
                    body.classList.add('mode-switch');
                    let info = ""; if (speechSettings.rest_switch_info.enabled && nextStep && nextStep.info && nextStep.info.exercise > 0) { info = `Hierna oefening ${nextStep.info.exercise} van de ${totalEx}`; }
                    triggerAudio('rest_switch_start', "Wissel", info);
                }
                else if (step.type === 'rest-long') {
                    body.classList.add('mode-long');
                    let info = ""; if (speechSettings.rest_round_info.enabled && nextStep && nextStep.info) { info = `Hierna ronde ${nextStep.info.round} van de ${totalRounds}`; }
                    triggerAudio('rest_round_start', "Grote pauze", info);
                }
                else if (step.type === 'prep') { body.classList.add('mode-prep'); triggerAudio('prep_intro', "Welkom"); }
                else { finish(); return; }
            } else {
                // Ensure class is correct valid even if we didn't play audio
                if (step.type === 'work') body.classList.add('mode-work');
                else if (step.type === 'rest') body.classList.add('mode-rest');
                else if (step.type === 'rest-exercise') body.classList.add('mode-switch');
                else if (step.type === 'rest-long') body.classList.add('mode-long');
                else if (step.type === 'prep') body.classList.add('mode-prep');
            }

            stepEndTime = Date.now() + (step.time * 1000);
            document.getElementById('countdown').innerText = step.time;

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (!isPaused) {
                    const now = Date.now();
                    const remainingMs = stepEndTime - now;
                    let remainingSec = Math.ceil(remainingMs / 1000);

                    if (remainingSec < 0) {
                        while (remainingSec < 0) {
                            currentIndex++; if (currentIndex >= schedule.length) { finish(); return; }
                            const skippedStep = schedule[currentIndex];
                            stepEndTime += (skippedStep.time * 1000);
                            remainingSec = Math.ceil((stepEndTime - Date.now()) / 1000);
                        }
                        runStep(); return;
                    }

                    step.time = remainingSec;
                    document.getElementById('countdown').innerText = step.time;
                    updateProgressRings(step.time, step.initialTime);

                    const totalDiff = targetEndTimeDate - now;
                    if (totalDiff > 0) {
                        const m = Math.floor(totalDiff / 60000); const s = Math.floor((totalDiff % 60000) / 1000);
                        document.getElementById('val-remaining').innerText = `${m}m ${s}s`;
                    } else { document.getElementById('val-remaining').innerText = "0m 0s"; }

                    const init = step.initialTime;
                    if (step.type === 'work') {
                        let audioTriggered = false;
                        if (step.time === Math.floor(init / 2) && init >= 20) {
                            triggerAudio('work_halfway', "Halverwege");
                            audioTriggered = true;
                        }
                        if (!audioTriggered && step.time === 30 && init > 40) {
                            triggerAudio('work_30s', "30 seconden");
                            audioTriggered = true;
                        }
                        if (!audioTriggered && step.time === 10 && init > 20) {
                            triggerAudio('work_10s', "10 seconden");
                        }
                    }
                    if (step.type === 'rest-long' && step.time === 15 && init > 20) triggerAudio('rest_round_15s', "Nog 15 seconden, ga naar je oefening");
                    if (step.type === 'rest-exercise' && step.time === 10 && init > 15) triggerAudio('rest_switch_10s', "Nog 10 seconden");

                    if (step.time <= 0) { clearInterval(timerInterval); currentIndex++; runStep(); }
                    else if (step.time <= 3) {
                        if (speechSettings.use_mp3) {
                            // MP3 Mode: Trigger prep_countdown once at 3s. Silence at 2s/1s.
                            if (step.time === 3) triggerAudio('prep_countdown', "3 2 1");
                        } else {
                            // TTS Mode: Individual ticks
                            triggerAudio('tick', step.time.toString());
                        }
                    }
                } else {
                    // Do nothing while paused
                }
            }, 1000);
        }

        function triggerEndTimeEdit() {
            const timeStr = targetEndTimeDate.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
            const input = document.getElementById('hidden-endtime-input'); input.value = timeStr;
            if ('showPicker' in HTMLInputElement.prototype) { try { input.showPicker(); } catch (e) { input.click(); } } else { input.click(); }
        }

        function handleNewEndTime(newVal) {
            if (!newVal) return;
            const [h, m] = newVal.split(':'); const newDate = new Date(); newDate.setHours(h, m, 0, 0);
            const now = new Date();
            if (newDate < now) { if (newDate.getTime() < now.getTime() - 12 * 3600 * 1000) { newDate.setDate(newDate.getDate() + 1); } }

            targetEndTimeDate = newDate;
            updateEndTimeDisplay(); recalculateForFixedEnd();
            renderLiveSchedule(); // Re-render to show updated times if needed
            triggerAudio('manual_override', "Eindtijd aangepast, schema herberekend");
        }

        function recalculateForFixedEnd() {
            const now = new Date();
            const secsRemaining = Math.floor((targetEndTimeDate - now) / 1000);
            let workStepsLeft = 0; let fixedRest = 0;
            for (let i = currentIndex; i < schedule.length; i++) {
                if (schedule[i].type === 'finish') continue;
                if (schedule[i].type.includes('rest')) fixedRest += schedule[i].time;
                else if (schedule[i].type === 'work') {
                    // Check if it's a regular exercise or extra start
                    // We only adjust regular exercises.
                    // Extra start is considered fixed time (like rest).
                    if (schedule[i].info && schedule[i].info.exercise > 0) {
                        workStepsLeft++;
                    } else {
                        fixedRest += schedule[i].time; // Treat extra work as fixed rest time for calc purposes
                    }
                }
                else if (schedule[i].type === 'prep') workStepsLeft++; // Prep usually 10s fixed, but kept logic same
            }

            if (workStepsLeft > 0) {
                const availableForWork = secsRemaining - fixedRest;
                let newWork = Math.floor(availableForWork / workStepsLeft);
                if (newWork < 5) newWork = 5;

                const currentIsWork = (schedule[currentIndex].type === 'work' && schedule[currentIndex].info.exercise > 0);
                const oldWorkVal = schedule[currentIndex].initialTime;

                for (let i = currentIndex; i < schedule.length; i++) {
                    if (schedule[i].type === 'work' && schedule[i].info.exercise > 0) {
                        schedule[i].time = newWork; schedule[i].initialTime = newWork;
                    }
                }
                if (currentIsWork) {
                    const diff = newWork - oldWorkVal;
                    stepEndTime += (diff * 1000);
                    document.getElementById('countdown').innerText = Math.ceil((stepEndTime - Date.now()) / 1000);
                }
            }
        }

        function handlePauseClick() {
            const btn = document.getElementById('btn-pause');
            if (!isPaused) {
                isPaused = true;
                pauseStartTime = Date.now();
                btn.innerText = "‚ñ∂Ô∏è"; // Show Play icon to resume

                document.body.classList.add('mode-pause');
                document.getElementById('gym-phase-title').innerText = "GEPAUZEERD";
                triggerAudio('manual_override', "Gepauzeerd");
            } else {
                previewPauseOptions(); // Calculate BEFORE showing modal
                document.getElementById('pause-modal').style.display = 'flex';
            }
        }

        // --- NEW PAUSE RESOLUTION LOGIC ---
        function previewPauseOptions() {
            const now = Date.now();
            currentPauseDuration = Math.ceil((now - pauseStartTime) / 1000); // Seconds paused
            document.getElementById('pause-duration-display').innerText = currentPauseDuration + "s";

            // 1. Push Endtime (Always possible)
            const newEndDate = new Date(targetEndTimeDate.getTime() + (currentPauseDuration * 1000));
            const oldEndStr = targetEndTimeDate.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
            const newEndStr = newEndDate.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
            const extraMin = Math.ceil(currentPauseDuration / 60);
            document.getElementById('btn-text-push').innerText = `Van ${oldEndStr} naar ${newEndStr} (+${extraMin}m)`;

            // 2. Catch up Work
            const workSteps = countRemainingSteps('work');
            const btnWork = document.getElementById('btn-catch-work');
            if (workSteps > 0) {
                const deduction = Math.ceil(currentPauseDuration / workSteps);
                const currentWork = getFirstStepTime('work');
                const newWork = currentWork - deduction;
                if (newWork >= 5) {
                    btnWork.disabled = false; btnWork.style.opacity = 1;
                    document.getElementById('btn-text-work').innerText = `Werk: ${currentWork}s -> ${newWork}s`;
                } else {
                    btnWork.disabled = true; btnWork.style.opacity = 0.5;
                    document.getElementById('btn-text-work').innerText = `Niet mogelijk (Werk wordt < 5s)`;
                }
            } else {
                btnWork.disabled = true; btnWork.style.opacity = 0.5; document.getElementById('btn-text-work').innerText = "Geen werksets meer";
            }

            // 3. Catch up Rest (Set)
            updateCatchUpButton('rest', 'btn-catch-rest', 'btn-text-rest', "Rust");
            // 4. Catch up Switch
            updateCatchUpButton('rest-exercise', 'btn-catch-switch', 'btn-text-switch', "Wissel");
            // 5. Catch up Round
            updateCatchUpButton('rest-long', 'btn-catch-round', 'btn-text-round', "Pauze");
        }

        function updateCatchUpButton(type, btnId, textId, label) {
            const steps = countRemainingSteps(type);
            const btn = document.getElementById(btnId);
            if (steps > 0) {
                const deduction = Math.ceil(currentPauseDuration / steps);
                const currentVal = getFirstStepTime(type);
                const newVal = currentVal - deduction;
                if (newVal >= 5) {
                    btn.disabled = false; btn.style.opacity = 1;
                    document.getElementById(textId).innerText = `${label}: ${currentVal}s -> ${newVal}s`;
                } else {
                    btn.disabled = true; btn.style.opacity = 0.5;
                    document.getElementById(textId).innerText = `Niet mogelijk (${newVal}s < 5s)`;
                }
            } else {
                btn.disabled = true; btn.style.opacity = 0.5; document.getElementById(textId).innerText = "Niet van toepassing";
            }
        }

        function countRemainingSteps(type) {
            let count = 0;
            // Only count regular work steps, not fixed extra steps for adjustment
            for (let i = currentIndex; i < schedule.length; i++) {
                if (schedule[i].type === type) {
                    if (type === 'work') {
                        if (schedule[i].info && schedule[i].info.exercise > 0) count++;
                    } else {
                        count++;
                    }
                }
            }
            return count;
        }

        function getFirstStepTime(type) {
            for (let i = currentIndex; i < schedule.length; i++) { if (schedule[i].type === type) return schedule[i].time; }
            return 0;
        }

        function resolvePause(choice) {
            document.getElementById('pause-modal').style.display = 'none';
            const btn = document.getElementById('btn-pause');
            btn.innerText = "‚è∏"; btn.classList.remove('paused');
            isPaused = false;

            document.body.classList.remove('mode-pause');

            // Apply Logic
            if (choice === 'push') {
                targetEndTimeDate = new Date(targetEndTimeDate.getTime() + (currentPauseDuration * 1000));
                updateEndTimeDisplay();
                stepEndTime += (currentPauseDuration * 1000);
            } else {
                stepEndTime += (currentPauseDuration * 1000);

                // Now Reduce
                let typeToReduce = '';
                if (choice === 'work') typeToReduce = 'work';
                else if (choice === 'rest') typeToReduce = 'rest';
                else if (choice === 'switch') typeToReduce = 'rest-exercise';
                else if (choice === 'round') typeToReduce = 'rest-long';

                const steps = countRemainingSteps(typeToReduce);
                const deduction = Math.ceil(currentPauseDuration / steps);

                // Apply deduction
                let currentStepReduced = false;
                for (let i = currentIndex; i < schedule.length; i++) {
                    if (schedule[i].type === typeToReduce) {
                        // Protect Extra Work from reduction if mode is 'work'
                        if (typeToReduce === 'work' && schedule[i].info.exercise === 0) continue;

                        schedule[i].time = Math.max(5, schedule[i].time - deduction);
                        schedule[i].initialTime = schedule[i].time;
                        if (i === currentIndex) currentStepReduced = true;
                    }
                }

                if (currentStepReduced) {
                    stepEndTime -= (deduction * 1000);
                    document.getElementById('countdown').innerText = Math.ceil((stepEndTime - Date.now()) / 1000);
                }
            }

            // UI Restore
            const step = schedule[currentIndex];
            if (step.type === 'work') document.body.classList.add('mode-work');
            else if (step.type === 'rest') document.body.classList.add('mode-rest');
            else if (step.type === 'rest-exercise') document.body.classList.add('mode-switch');
            else if (step.type === 'rest-long') document.body.classList.add('mode-long');

            triggerAudio('manual_override', "We gaan weer door");
            document.getElementById('gym-phase-title').innerText = step.label;

            const titleEl = document.getElementById('gym-phase-title');
            titleEl.className = 'gym-phase-title';
            if (step.label === 'WERKEN' || step.label === 'RUST' || step.type === 'work') { titleEl.classList.add('huge-text'); }
        }

        function updateEndTimeDisplay() {
            const timeStr = targetEndTimeDate.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('val-endtime').innerText = timeStr;
            document.getElementById('live-endtime-input').value = timeStr;
        }


        function updateProgressRings(currentSec, totalSec) {
            // Inner Ring (Step) uses REVERSE logic (starts full, goes to empty)
            const ringStep = document.getElementById('ring-step');
            if (ringStep && totalSec > 0) {
                const totalC = 251.3; // 2 * pi * 40
                // pct is % LEFT
                let pct = currentSec / totalSec;
                if (pct > 1) pct = 1; if (pct < 0) pct = 0;

                // stroke-dashoffset: 0 = full, totalC = empty
                // We want full at start, empty at end.
                // So offset = totalC * (1 - pct)
                const offset = totalC * (1 - pct);
                ringStep.style.strokeDashoffset = offset;


            } else {
                console.log("Ring update failed", totalSec);
            }

            // Outer Ring (Total)
            const ringTotal = document.getElementById('ring-total');
            if (ringTotal) {
                const now = new Date();
                const totalMs = targetEndTimeDate - workoutStartTime;
                if (totalMs > 0) {
                    const elapsed = now - workoutStartTime;
                    let pct = elapsed / totalMs;
                    if (pct > 1) pct = 1; if (pct < 0) pct = 0;

                    const totalC = 301.6; // 2 * pi * 48
                    // Here we fill UP: 0 = empty ?? No, svg dasharray logic usually: 0=full.
                    // Let's say we want to START empty and FILL up.
                    // offset = totalC * (1 - pct)
                    const offset = totalC * (1 - pct);
                    ringTotal.style.strokeDashoffset = offset;
                }
            }
        }

        function finish() {
            document.body.className = 'mode-finish';
            document.getElementById('gym-phase-title').innerText = "KLAAR!";
            document.getElementById('gym-phase-title').classList.remove('huge-text');
            document.getElementById('countdown').innerText = "üéâ";
            document.getElementById('gym-stats-container').style.display = 'none';
            document.getElementById('btn-pause').style.display = 'none';
            clearInterval(timerInterval);
            triggerAudio('finish', "Training klaar");
        }

        function resetApp() {
            clearInterval(timerInterval);
            // Force Tabataman on reset (User Request)
            try {
                let s = JSON.parse(localStorage.getItem('fnh_settings_v8') || "{}");
                s.coachPreset = 'tabataman';
                localStorage.setItem('fnh_settings_v8', JSON.stringify(s));
            } catch (e) { console.error("Reset pref fail", e); }
            location.reload();
        }

        function confirmStop() { if (confirm("Weet je zeker dat je de training wilt stoppen?")) { resetApp(); } }

        // --- NEW FEATURES: LIVE SCHEDULE & NAVIGATION ---

        function renderLiveSchedule() {
            const tbody = document.getElementById('live-table-body');
            tbody.innerHTML = "";

            let runningDate = new Date(); // Start from "now" (or workout start)
            // Ideally we want to show absolute times based on workout start.
            // If workout hasn't started, assume now.
            if (workoutStartTime) {
                // If we are mid-workout, we need to reconstruct the timeline
                // But for simplicity, let's just render the list with relative durations 
                // and maybe approximate start times based on "now" for future steps?
                // Better: Just use the same logic as preview but anchored to workoutStartTime.
                runningDate = new Date(workoutStartTime);
            }

            // Re-calculate running times based on current schedule
            // Logic: elapsed time is fixed, future is projected.

            // Simplification: Just list them. We highlight the current one.
            let tempDate = new Date(workoutStartTime || Date.now());

            schedule.forEach((item, index) => {
                if (item.type === 'finish') return;

                const tr = document.createElement('tr');
                tr.id = `sched-row-${index}`;
                tr.onclick = () => jumpToStep(index);

                // Determine status
                if (index < currentIndex) tr.className = "past-row";
                else if (index === currentIndex) tr.className = "active-row";
                else tr.className = "future-row";

                const showTime = tempDate.toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });

                // Add Duration to tempDate
                // NOTE: For the current step, the duration in 'item.time' is changing in real-time!
                // So we should use initialTime for the projection of FUTURE steps.
                let dur = item.initialTime;

                const tdTime = document.createElement('td');
                tdTime.innerText = showTime;

                const tdName = document.createElement('td');
                let desc = item.label;
                if (item.info && item.info.round && item.info.exercise > 0) desc += ` <span style='color:#888; font-size:11px;'>(R${item.info.round}/E${item.info.exercise}/S${item.info.set})</span>`;
                tdName.innerHTML = desc; /* Allow HTML for span */

                const tdDur = document.createElement('td');
                tdDur.style.textAlign = "right";
                tdDur.innerText = dur + "s";

                tr.appendChild(tdTime);
                tr.appendChild(tdName);
                tr.appendChild(tdDur);
                tbody.appendChild(tr);

                tempDate.setSeconds(tempDate.getSeconds() + dur);
            });
        }

        function updateLiveScheduleHighlight() {
            // Remove old highlight
            const rows = document.querySelectorAll('.live-table tr');
            rows.forEach((r, idx) => {
                if (idx < currentIndex) r.className = "past-row";
                else if (idx === currentIndex) {
                    r.className = "active-row";
                    // Scroll disabled to keep focus on top of page
                }
                else r.className = "future-row";
            });
        }

        function handleNextClick() {
            if (currentIndex < schedule.length - 1) {
                currentIndex++;
                schedule.forEach(s => delete s.hasPlayedEntry); // Allow audio to play for new step
                stepEndTime = Date.now() + (schedule[currentIndex].time * 1000);
                triggerAudio('manual_override', "Volgende");
                renderLiveSchedule(); // Update times potentially?
                runStep();
            } else {
                finish();
            }
        }

        function handlePrevClick() {
            if (currentIndex > 0) {
                currentIndex--;
                schedule.forEach(s => delete s.hasPlayedEntry); // Allow audio to play for previous step
                // Restore time for the step we are going BACK to (full duration)
                schedule[currentIndex].time = schedule[currentIndex].initialTime;
                stepEndTime = Date.now() + (schedule[currentIndex].time * 1000);
                triggerAudio('manual_override', "Vorige");
                renderLiveSchedule();
                runStep();
            }
        }

        function jumpToStep(index) {
            if (index >= 0 && index < schedule.length) {
                if (confirm(`Wil je springen naar: ${schedule[index].label}?`)) {
                    currentIndex = index;
                    // Reset time to full initial duration for that step
                    schedule[currentIndex].time = schedule[currentIndex].initialTime;
                    stepEndTime = Date.now() + (schedule[currentIndex].time * 1000);

                    triggerAudio('manual_override', "Springen naar selectie");
                    renderLiveSchedule();
                    runStep();
                }
            }
        }
    </script>
    <div id="pre-workout-overlay" class="modal-overlay epic-overlay"
        style="display:none; flex-direction:column; justify-content:center; align-items:center; background:black; color:white;">
        <div style="font-size:18px; color:#888; text-transform:uppercase; letter-spacing:4px; margin-bottom:10px;">
            TRAINING BEGINT OVER</div>

        <!-- NEW START TIME INFO -->
        <div id="pre-workout-start-time"
            style="font-size:24px; color:#30D158; font-weight:bold; margin-bottom:20px; text-transform:uppercase; letter-spacing:1px; text-shadow: 0 0 10px rgba(48,209,88,0.4);">
            STARTTIJD: --:--
        </div>

        <div id="pre-workout-timer" class="epic-timer" style="font-size:120px; font-weight:900; line-height:1;">
            00:00
        </div>

        <button onclick="performStart()" class="action-btn"
            style="margin-top:50px; padding:15px 40px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); backdrop-filter:blur(10px); width:auto;">
            üöÄ NU BEGINNEN (OVERSLAAN)
        </button>
    </div>
</body>

</html>